<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¥ STATS LIVE - LBMA 2026</title>
    <link rel="icon" type="image/jpeg" href="logo-lbma.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --primary:#1E3A5F;--accent:#CC0000;--gold:#D4AF37;--white:#FDFBF7;--cream:#F5F1E8;--dark:#1A1A1A;
            --success:#28a745;--danger:#dc3545;--warning:#ffc107
        }
        body{font-family:'Work Sans',sans-serif;background:var(--dark);color:var(--white);min-height:100vh}
        .header{background:linear-gradient(135deg,var(--primary) 0%,#0d2137 100%);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;border-bottom:3px solid var(--gold)}
        .header-left{display:flex;align-items:center;gap:1rem}
        .header img{height:50px;background:white;padding:3px;border-radius:5px}
        .header h1{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:.1em}
        .live-badge{background:var(--accent);color:white;padding:.5rem 1rem;font-family:'Oswald',sans-serif;animation:pulse 1.5s infinite;display:flex;align-items:center;gap:.5rem}
        .live-dot{width:10px;height:10px;background:white;border-radius:50%;animation:blink 1s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        .main-tabs{display:flex;background:var(--dark);border-bottom:3px solid var(--gold);flex-wrap:wrap}
        .main-tab{padding:1rem 2rem;font-family:'Oswald',sans-serif;font-size:1rem;cursor:pointer;border:none;background:transparent;color:var(--white);opacity:.7;transition:.3s}
        .main-tab:hover{opacity:1}
        .main-tab.active{background:var(--primary);opacity:1;border-bottom:3px solid var(--gold);margin-bottom:-3px}
        .container{max-width:1600px;margin:0 auto;padding:1rem}
        .tab-content{display:none}.tab-content.active{display:block}
        .match-setup{background:var(--primary);padding:1.5rem;margin-bottom:1rem;border:2px solid var(--gold)}
        .match-setup h2{font-family:'Bebas Neue',sans-serif;color:var(--gold);margin-bottom:1rem}
        .setup-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;align-items:end}
        .form-group{display:flex;flex-direction:column;gap:.5rem}
        .form-group label{font-family:'Oswald',sans-serif;font-size:.85rem;text-transform:uppercase}
        .form-group select,.form-group input{padding:.75rem;border:2px solid var(--gold);background:var(--dark);color:white;font-size:1rem}
        .btn{padding:.75rem 1.5rem;font-family:'Oswald',sans-serif;border:none;cursor:pointer;transition:.3s;text-transform:uppercase}
        .btn-success{background:var(--success);color:white}
        .btn-danger{background:var(--danger);color:white}
        .btn-warning{background:var(--warning);color:var(--dark)}
        .btn-primary{background:var(--gold);color:var(--dark)}
        .btn:hover{transform:scale(1.05)}
        .scoreboard{display:grid;grid-template-columns:1fr auto 1fr;gap:2rem;background:linear-gradient(135deg,#1a1a1a,#2d2d2d);padding:2rem;margin-bottom:1rem;border:3px solid var(--gold);align-items:center}
        .team-score{text-align:center}
        .team-score .team-name{font-family:'Bebas Neue',sans-serif;font-size:2rem;margin-bottom:.5rem}
        .team-score .score{font-family:'Bebas Neue',sans-serif;font-size:5rem;color:var(--gold)}
        .score-vs{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--gold)}
        .match-info{text-align:center;font-family:'Oswald',sans-serif}
        .stats-entry{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
        .team-entry{background:var(--cream);color:var(--dark);border:3px solid var(--dark);overflow:hidden}
        .team-entry-header{padding:1rem;color:white;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;display:flex;justify-content:space-between}
        .team-entry-body{padding:.5rem;max-height:500px;overflow-y:auto}
        .psr{display:grid;grid-template-columns:140px repeat(11,1fr) auto;gap:.2rem;padding:.4rem;border-bottom:1px solid #ddd;align-items:center;font-size:.8rem}
        .psr:hover{background:rgba(0,0,0,.05)}
        .psr.hdr{background:var(--primary);color:white;font-family:'Oswald',sans-serif;font-size:.7rem;position:sticky;top:0;z-index:2}
        .psr input{width:100%;padding:.2rem;border:1px solid #ccc;text-align:center;font-size:.8rem}
        .psr input:focus{border-color:var(--primary);outline:none;background:rgba(212,175,55,.2)}
        .psr .pn{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.75rem}
        .psr .moy{font-weight:bold;color:var(--primary)}
        .qb{padding:.1rem .3rem;font-size:.65rem;border:none;cursor:pointer;margin:0 .05rem}
        .qb.hit{background:var(--success);color:white}.qb.out{background:var(--danger);color:white}
        .qb.abs-btn{background:#999;color:white;font-size:.55rem}
        .psr.player-abs{opacity:.3;pointer-events:none}
        .psr.player-abs .pn::after{content:' (ABS)';color:var(--danger);font-weight:bold;font-size:.65rem}
        .psr.player-def .pn::after{content:' (DEF)';color:var(--primary);font-weight:bold;font-size:.65rem}
        .psr.player-def input{pointer-events:none;opacity:.3}
        .psr.player-def .qb{pointer-events:none;opacity:.3}
        .banc-section{padding:.3rem .5rem;background:var(--cream);font-family:'Oswald',sans-serif;font-size:.75rem;color:var(--primary);display:flex;justify-content:space-between;align-items:center;border-top:2px solid var(--primary)}
        .banc-section button{font-size:.65rem;padding:.2rem .5rem;background:var(--success);color:white;border:none;cursor:pointer;font-family:'Oswald',sans-serif}
        .role-sel{font-size:.6rem;padding:.1rem;border:1px solid #ccc;background:white;font-family:'Oswald',sans-serif;width:40px;margin-right:.2rem}
        .pitcher-section{background:var(--accent);color:white;padding:.75rem;margin-top:0}
        .pitcher-section h3{font-family:'Oswald',sans-serif;margin-bottom:.5rem;font-size:.95rem}
        .pitcher-stats{display:flex;gap:.75rem;flex-wrap:wrap}
        .pitcher-stat{text-align:center;background:rgba(255,255,255,.1);padding:.5rem .75rem;flex:1;min-width:60px}
        .pitcher-stat .value{font-family:'Bebas Neue',sans-serif;font-size:1.5rem}
        .pitcher-stat .label{font-size:.7rem;opacity:.8}
        .standings-card{background:var(--white);color:var(--dark);border:3px solid var(--dark);margin-bottom:1rem}
        .standings-card h3{background:var(--primary);color:white;padding:1rem;font-family:'Bebas Neue',sans-serif}
        .standings-table{width:100%;border-collapse:collapse}
        .standings-table th{background:var(--cream);padding:.75rem;text-align:left;font-family:'Oswald',sans-serif;font-size:.8rem}
        .standings-table td{padding:.5rem .75rem;border-bottom:1px solid var(--cream)}
        .standings-table tr:hover{background:var(--cream)}
        .leaders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
        .leader-card{background:var(--white);color:var(--dark);border:3px solid var(--dark)}
        .leader-card h3{background:var(--gold);color:var(--dark);padding:.75rem 1rem;font-family:'Bebas Neue',sans-serif}
        .leader-list{padding:.25rem}
        .leader-item{display:flex;justify-content:space-between;padding:.6rem .75rem;border-bottom:1px solid var(--cream)}
        .leader-item:first-child{background:rgba(212,175,55,.2)}
        .leader-item .rank{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--primary);width:25px}
        .leader-item .name{flex:1;font-size:.9rem}
        .leader-item .value{font-family:'Oswald',sans-serif;font-weight:bold;color:var(--primary)}
        .games-log{background:var(--white);color:var(--dark);border:3px solid var(--dark);margin-top:1rem}
        .games-log h3{background:var(--primary);color:white;padding:1rem;font-family:'Bebas Neue',sans-serif}
        .games-table{width:100%;border-collapse:collapse}
        .games-table th{background:var(--cream);padding:.75rem;text-align:left;font-family:'Oswald',sans-serif}
        .games-table td{padding:.75rem;border-bottom:1px solid var(--cream)}
        .toast{position:fixed;top:80px;right:20px;padding:1rem 2rem;border-radius:5px;color:white;font-weight:bold;z-index:3000;animation:slideIn .3s ease}
        .toast-success{background:var(--success)}.toast-danger{background:var(--danger)}.toast-warning{background:var(--warning);color:var(--dark)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .loading-msg{text-align:center;padding:2rem;font-family:'Oswald',sans-serif;color:var(--gold)}
        @media(max-width:1024px){
            .stats-entry{grid-template-columns:1fr}
            .scoreboard{grid-template-columns:1fr;text-align:center}
            .psr{grid-template-columns:110px repeat(6,1fr) auto;font-size:.7rem}
        }
    </style>
</head>
<body>
<header class="header">
    <div class="header-left">
        <a href="index.html" title="Accueil LBMA"><img src="logo-lbma.jpg" alt="LBMA"></a>
        <h1>üìä STATISTIQUES LIVE 2026</h1>
    </div>
    <div style="display:flex;gap:1rem;align-items:center">
        <div class="live-badge"><span class="live-dot"></span> SAISON EN COURS</div>
        <a href="index.html" class="btn btn-primary" style="text-decoration:none">üè† Accueil</a>
    </div>
</header>

<div class="main-tabs">
    <button class="main-tab active" onclick="switchTab('match',this)">‚öæ Saisie Match</button>
    <button class="main-tab" onclick="switchTab('standings',this)">üèÜ Classements</button>
    <button class="main-tab" onclick="switchTab('leaders',this)">‚≠ê Meneurs</button>
    <button class="main-tab" onclick="switchTab('players',this)">üë• Stats Joueurs</button>
    <button class="main-tab" onclick="switchTab('pitchers',this)">üéØ Stats Lanceurs</button>
</div>

<div class="container">
    <!-- SAISIE MATCH -->
    <div id="match-tab" class="tab-content active">
        <div class="match-setup">
            <h2>‚öæ S√âLECTIONNER UN MATCH DU CALENDRIER</h2>
            <div class="setup-grid" style="grid-template-columns:1fr auto">
                <div class="form-group">
                    <label>Match</label>
                    <select id="matchSelect" onchange="onMatchSelect()" style="font-size:.95rem">
                        <option value="">‚Äî Choisir un match ‚Äî</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="loadMatchSelect()" style="white-space:nowrap">üîÑ Rafra√Æchir</button>
            </div>
            <div id="matchConfig" style="display:none;margin-top:1rem;border-top:2px solid var(--gold);padding-top:1rem">
                <div class="setup-grid">
                    <div class="form-group"><label>Date</label><input type="date" id="matchDate" readonly style="opacity:.7"></div>
                    <div class="form-group"><label>Visiteur</label><input type="text" id="teamAwayDisplay" readonly style="opacity:.7;font-weight:700"></div>
                    <div class="form-group"><label>Local</label><input type="text" id="teamHomeDisplay" readonly style="opacity:.7;font-weight:700"></div>
                    <div class="form-group"><label>Lanceur Visiteur</label><select id="pitcherAway"></select></div>
                    <div class="form-group"><label>Lanceur Local</label><select id="pitcherHome"></select></div>
                    <button class="btn btn-success" onclick="startMatch()">‚ñ∂Ô∏è D√âMARRER MATCH</button>
                </div>
            </div>
        </div>
        <div class="scoreboard" id="scoreboard" style="display:none">
            <div class="team-score"><div class="team-name" id="awayTeamName">VISITEUR</div><div class="score" id="awayScore">0</div></div>
            <div class="match-info"><div class="score-vs">VS</div><div id="matchDateDisplay"></div><div style="margin-top:1rem;display:flex;gap:1rem;justify-content:center"><button class="btn btn-warning" onclick="endMatch()">üèÅ Terminer Match</button><button class="btn btn-danger" onclick="cancelMatch()">‚ùå Annuler</button></div></div>
            <div class="team-score"><div class="team-name" id="homeTeamName">LOCAL</div><div class="score" id="homeScore">0</div></div>
        </div>
        <div class="stats-entry" id="statsEntry" style="display:none">
            <div class="team-entry">
                <div class="team-entry-header" id="awayHeader"><span id="awayHeaderName">ü¶Ö VISITEUR</span><span>PC: <span id="awayPC">0</span></span></div>
                <div class="team-entry-body">
                    <div class="psr hdr"><span>Joueur</span><span>AB</span><span>CS</span><span>1B</span><span>2B</span><span>3B</span><span>CC</span><span>PC</span><span>PP</span><span>BB</span><span>K</span><span>MOY</span><span>+/-</span></div>
                    <div id="awayPlayers"></div>
                </div>
                <div class="pitcher-section">
                    <h3>üéØ Lanceurs Visiteur</h3>
                    <div id="awayPitchersList"></div>
                    <div style="margin-top:.5rem"><button onclick="addReliever('away')" style="background:rgba(255,255,255,.2);color:white;border:1px dashed rgba(255,255,255,.4);padding:.3rem .6rem;border-radius:4px;cursor:pointer;font-size:.75rem">+ Ajouter releveur</button></div>
                </div>
            </div>
            <div class="team-entry">
                <div class="team-entry-header" id="homeHeader"><span id="homeHeaderName">ü¶Ö LOCAL</span><span>PC: <span id="homePC">0</span></span></div>
                <div class="team-entry-body">
                    <div class="psr hdr"><span>Joueur</span><span>AB</span><span>CS</span><span>1B</span><span>2B</span><span>3B</span><span>CC</span><span>PC</span><span>PP</span><span>BB</span><span>K</span><span>MOY</span><span>+/-</span></div>
                    <div id="homePlayers"></div>
                </div>
                <div class="pitcher-section">
                    <h3>üéØ Lanceurs Local</h3>
                    <div id="homePitchersList"></div>
                    <div style="margin-top:.5rem"><button onclick="addReliever('home')" style="background:rgba(255,255,255,.2);color:white;border:1px dashed rgba(255,255,255,.4);padding:.3rem .6rem;border-radius:4px;cursor:pointer;font-size:.75rem">+ Ajouter releveur</button></div>
                </div>
            </div>
        </div>
        <div class="games-log"><h3>üìÖ MATCHS R√âCENTS</h3>
            <table class="games-table"><thead><tr><th>Date</th><th>Visiteur</th><th>Score</th><th>Local</th><th>Actions</th></tr></thead>
            <tbody id="recentGames"><tr><td colspan="5" class="loading-msg">Chargement...</td></tr></tbody></table>
        </div>
    </div>

    <!-- CLASSEMENTS -->
    <div id="standings-tab" class="tab-content">
        <h2 style="font-family:'Bebas Neue',sans-serif;color:var(--gold);margin-bottom:1rem">üèÜ CLASSEMENT SAISON 2026</h2>
        <div class="standings-card"><table class="standings-table">
            <thead><tr><th>#</th><th>√âquipe</th><th>PJ</th><th>V</th><th>D</th><th>N</th><th>PP</th><th>PC</th><th>DIFF</th><th>PTS</th></tr></thead>
            <tbody id="standingsTable"><tr><td colspan="10" class="loading-msg">Chargement...</td></tr></tbody>
        </table></div>
    </div>

    <!-- MENEURS -->
    <div id="leaders-tab" class="tab-content">
        <h2 style="font-family:'Bebas Neue',sans-serif;color:var(--gold);margin-bottom:1rem">‚≠ê MENEURS 2026</h2>
        <div class="leaders-grid">
            <div class="leader-card"><h3>üéØ Moyenne (MOY)</h3><div class="leader-list" id="leadersMoy"></div></div>
            <div class="leader-card"><h3>üí• Coups S√ªrs (CS)</h3><div class="leader-list" id="leadersCS"></div></div>
            <div class="leader-card"><h3>üè† Circuits (CC)</h3><div class="leader-list" id="leadersCC"></div></div>
            <div class="leader-card"><h3>üèÉ Points Compt√©s (PC)</h3><div class="leader-list" id="leadersPC"></div></div>
            <div class="leader-card"><h3>üí™ Points Produits (PP)</h3><div class="leader-list" id="leadersPP"></div></div>
            <div class="leader-card"><h3>üéØ Victoires Lanceur (V)</h3><div class="leader-list" id="leadersWins"></div></div>
        </div>
    </div>

    <!-- STATS JOUEURS -->
    <div id="players-tab" class="tab-content">
        <h2 style="font-family:'Bebas Neue',sans-serif;color:var(--gold);margin-bottom:1rem">üë• STATISTIQUES FRAPPEURS 2026</h2>
        <div class="form-group" style="margin-bottom:1rem;max-width:300px">
            <select id="filterTeamPlayers" onchange="renderPlayersStats()" style="width:100%;padding:.75rem;border:2px solid var(--gold);background:var(--dark);color:white">
                <option value="">Toutes les √©quipes</option>
            </select>
        </div>
        <div class="standings-card"><table class="standings-table">
            <thead><tr><th>#</th><th>Joueur</th><th>√âQ</th><th>PJ</th><th>AB</th><th>CS</th><th>1B</th><th>2B</th><th>3B</th><th>CC</th><th>PC</th><th>PP</th><th>BB</th><th>K</th><th>MOY</th></tr></thead>
            <tbody id="playersStatsTable"></tbody>
        </table></div>
    </div>

    <!-- STATS LANCEURS ‚Äî FIX: OUT, ML, MOY (PC√∑ML) au lieu de %V -->
    <div id="pitchers-tab" class="tab-content">
        <h2 style="font-family:'Bebas Neue',sans-serif;color:var(--gold);margin-bottom:1rem">üéØ STATISTIQUES LANCEURS 2026</h2>
        <div class="standings-card"><table class="standings-table">
            <thead><tr><th>#</th><th>Lanceur</th><th>√âQ</th><th>PJ</th><th>V</th><th>D</th><th>N</th><th>OUT</th><th>ML</th><th>PC</th><th>CS</th><th>BB</th><th>K</th><th>MOY</th></tr></thead>
            <tbody id="pitchersStatsTable"></tbody>
        </table></div>
    </div>
</div>

<script>
/* ==========================================
   SUPABASE CONFIG
   ========================================== */
var SB='https://xgyskiatppgaeaamjhxr.supabase.co';
var SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXNraWF0cHBnYWVhYW1qaHhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTgxNTQsImV4cCI6MjA4NjA3NDE1NH0.67KCcUWlJij-scDoCUvZpkiCle5-mHVmy-inRk96Tac';
var SAI='2026';
var TC={AIGLES:'#FF8001',CONDORS:'#124FB2',DUCS:'#006400',FAUCONS:'#CC0000',HARFANGS:'#929292',VAUTOURS:'#B8960C'};
var TN={AIGLES:'Aigles',CONDORS:'Condors',DUCS:'Ducs',FAUCONS:'Faucons',HARFANGS:'Harfangs',VAUTOURS:'Vautours'};
var TEAMS=['AIGLES','CONDORS','DUCS','FAUCONS','HARFANGS','VAUTOURS'];

function sbF(p){return fetch(SB+'/rest/v1/'+p,{headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Range':'0-9999'}}).then(r=>r.json()).then(d=>Array.isArray(d)?d:[]).catch(()=>[])}
function sbPost(t,d){return fetch(SB+'/rest/v1/'+t,{method:'POST',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json','Prefer':'resolution=merge-duplicates,return=representation'},body:JSON.stringify(d)}).then(r=>r.json())}
function sbInsert(t,d){return fetch(SB+'/rest/v1/'+t,{method:'POST',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json','Prefer':'return=representation'},body:JSON.stringify(d)}).then(r=>{if(!r.ok)return r.text().then(tx=>{console.error('sbInsert error:',tx);return[]});return r.json()})}
function sbPatch(t,q,d){return fetch(SB+'/rest/v1/'+t+'?'+q,{method:'PATCH',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json','Prefer':'return=representation'},body:JSON.stringify(d)}).then(r=>r.json())}
function sbDel(t,q){return fetch(SB+'/rest/v1/'+t+'?'+q,{method:'DELETE',headers:{'apikey':SK,'Authorization':'Bearer '+SK}})}

/* ==========================================
   STATE
   ========================================== */
var allJoueurs=[];   // From joueurs_liste: [{nom, cote, ...}]
var eqRosters={};    // From equipes_saison: {AIGLES:[{nom,cote},...], ...}
var frappeurs=[];    // From frappeurs_saison saison=2026
var lanceurs=[];     // From lanceurs_saison saison=2026
var matchsFinal=[];  // From matchs_regulier status=final
var matchsCal=[];    // All matchs_regulier for calendar
var selectedMatch=null; // Match s√©lectionn√© du calendrier
var currentMatch=null;

/* ==========================================
   INIT
   ========================================== */
async function init(){
    try{
        var [jl,eq,fr,la,mf,mc]=await Promise.all([
            sbF('joueurs_liste?saison=eq.'+SAI+'&order=nom.asc&select=nom,cote,role'),
            sbF('equipes_saison?saison=eq.'+SAI+'&order=equipe.asc,ordre.asc'),
            sbF('frappeurs_saison?saison=eq.'+SAI+'&order=moy.desc'),
            sbF('lanceurs_saison?saison=eq.'+SAI+'&order=v.desc'),
            sbF('matchs_regulier?saison=eq.'+SAI+'&status=eq.final&order=date.desc'),
            sbF('matchs_regulier?saison=eq.'+SAI+'&order=date.asc,heure.asc')
        ]);
        allJoueurs=jl;
        frappeurs=fr;
        lanceurs=la;
        matchsFinal=mf;
        matchsCal=mc;

        // Build rosters from equipes_saison
        eqRosters={};
        TEAMS.forEach(t=>eqRosters[t]=[]);
        eq.forEach(r=>{
            if(r.equipe&&eqRosters[r.equipe]!==undefined){
                eqRosters[r.equipe].push({nom:r.joueur_nom,cote:r.joueur_cote||3,isCoach:r.is_coach});
            }
        });

        loadMatchSelect();
        // Populate team filter for Stats Joueurs tab
        var flt=document.getElementById('filterTeamPlayers');
        if(flt)flt.innerHTML='<option value="">Toutes les √©quipes</option>'+TEAMS.map(t=>'<option value="'+t+'">'+(TN[t]||t)+'</option>').join('');
        renderRecentGames();
        renderLeaders();
        renderPlayersStats();
        renderPitchersStats();
    }catch(e){
        console.error(e);
        toast('Erreur chargement: '+e.message,'danger');
    }
}

function loadMatchSelect(){
    var sel=document.getElementById('matchSelect');
    // Filtrer matchs non finalis√©s (a_venir ou en_cours)
    var avenir=matchsCal.filter(m=>m.status!=='final');
    var finals=matchsCal.filter(m=>m.status==='final').slice(-5).reverse();

    var h='<option value="">‚Äî Choisir un match ‚Äî</option>';
    if(avenir.length>0){
        h+='<optgroup label="üìÖ MATCHS √Ä JOUER">';
        avenir.forEach(m=>{
            var lbl=m.date+' ‚Äî '+(TN[m.visiteur]||m.visiteur)+' @ '+(TN[m.local]||m.local);
            if(m.heure)lbl+=' ('+m.heure+')';
            h+='<option value="'+m.id+'">'+esc(lbl)+'</option>';
        });
        h+='</optgroup>';
    }
    if(finals.length>0){
        h+='<optgroup label="‚úÖ DERNIERS MATCHS FINALIS√âS (correction)">';
        finals.forEach(m=>{
            var lbl=m.date+' ‚Äî '+(TN[m.visiteur]||m.visiteur)+' '+(m.score_visiteur||0)+'-'+(m.score_local||0)+' '+(TN[m.local]||m.local);
            h+='<option value="'+m.id+'">'+esc(lbl)+'</option>';
        });
        h+='</optgroup>';
    }
    sel.innerHTML=h;
    document.getElementById('matchConfig').style.display='none';
    selectedMatch=null;
}

function onMatchSelect(){
    var id=document.getElementById('matchSelect').value;
    if(!id){document.getElementById('matchConfig').style.display='none';selectedMatch=null;return;}
    selectedMatch=matchsCal.find(m=>String(m.id)===String(id));
    if(!selectedMatch){document.getElementById('matchConfig').style.display='none';return;}

    document.getElementById('matchConfig').style.display='block';
    document.getElementById('matchDate').value=selectedMatch.date||'';
    document.getElementById('teamAwayDisplay').value=(TN[selectedMatch.visiteur]||selectedMatch.visiteur).toUpperCase();
    document.getElementById('teamHomeDisplay').value=(TN[selectedMatch.local]||selectedMatch.local).toUpperCase();

    // Populate pitcher selects for these teams
    var away=selectedMatch.visiteur,home=selectedMatch.local;
    var rA=eqRosters[away]||[];
    var rH=eqRosters[home]||[];
    if(rA.length===0)rA=allJoueurs.map(j=>({nom:j.nom}));
    if(rH.length===0)rH=allJoueurs.map(j=>({nom:j.nom}));

    var pA=document.getElementById('pitcherAway');
    var pH=document.getElementById('pitcherHome');
    pA.innerHTML=rA.map(p=>'<option value="'+esc(p.nom)+'">'+esc(p.nom)+'</option>').join('');
    pH.innerHTML=rH.map(p=>'<option value="'+esc(p.nom)+'">'+esc(p.nom)+'</option>').join('');

    // Populate team filter
    var filter=document.getElementById('filterTeamPlayers');
    filter.innerHTML='<option value="">Toutes les √©quipes</option>'+TEAMS.map(t=>'<option value="'+t+'">'+(TN[t]||t)+'</option>').join('');
}

/* ==========================================
   TABS
   ========================================== */
function switchTab(tab,btn){
    document.querySelectorAll('.main-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tab+'-tab').classList.add('active');
    if(tab==='standings')renderStandings();
    if(tab==='leaders')renderLeaders();
    if(tab==='players')renderPlayersStats();
    if(tab==='pitchers')renderPitchersStats();
}

/* ==========================================
   MATCH
   ========================================== */
function startMatch(){
    if(!selectedMatch){toast('S√©lectionnez un match du calendrier!','danger');return;}
    var away=selectedMatch.visiteur;
    var home=selectedMatch.local;
    var date=selectedMatch.date;
    var pA=document.getElementById('pitcherAway').value;
    var pH=document.getElementById('pitcherHome').value;

    var rA=eqRosters[away]||[];
    var rH=eqRosters[home]||[];
    if(rA.length===0) rA=allJoueurs.map(j=>({nom:j.nom}));
    if(rH.length===0) rH=allJoueurs.map(j=>({nom:j.nom}));

    currentMatch={matchId:selectedMatch.id,date:date,away:away,home:home,pitcherAway:pA,pitcherHome:pH,awayStats:{},homeStats:{},awayPitcher:{pc:0,cs:0,bb:0},homePitcher:{pc:0,cs:0,bb:0},awayPitchers:[{nom:pA,out:0,pc:0,cs:0,bb:0,rb:0}],homePitchers:[{nom:pH,out:0,pc:0,cs:0,bb:0,rb:0}],awayRoles:{},homeRoles:{},awayOriginal:{},homeOriginal:{}};

    rA.forEach(p=>{currentMatch.awayStats[p.nom]={ab:0,cs:0,b1:0,b2:0,b3:0,cc:0,pc:0,pp:0,bb:0,k:0};currentMatch.awayOriginal[p.nom]=true;});
    rH.forEach(p=>{currentMatch.homeStats[p.nom]={ab:0,cs:0,b1:0,b2:0,b3:0,cc:0,pc:0,pp:0,bb:0,k:0};currentMatch.homeOriginal[p.nom]=true;});

    document.getElementById('scoreboard').style.display='grid';
    document.getElementById('statsEntry').style.display='grid';
    document.getElementById('awayTeamName').textContent=TN[away]||away;
    document.getElementById('homeTeamName').textContent=TN[home]||home;
    document.getElementById('matchDateDisplay').textContent=date;
    document.getElementById('awayHeader').style.background=TC[away]||'#333';
    document.getElementById('homeHeader').style.background=TC[home]||'#333';
    var awTx=(away==='VAUTOURS')?'var(--dark)':'white';
    var hmTx=(home==='VAUTOURS')?'var(--dark)':'white';
    document.getElementById('awayHeader').style.color=awTx;
    document.getElementById('homeHeader').style.color=hmTx;
    document.getElementById('awayHeaderName').textContent='‚öæ '+(TN[away]||away).toUpperCase();
    document.getElementById('homeHeaderName').textContent='‚öæ '+(TN[home]||home).toUpperCase();
    renderMatchPlayers();
    renderPitchersList('away');
    renderPitchersList('home');
    toast('‚öæ Match d√©marr√©!','success');
}

function renderMatchPlayers(){
    if(!currentMatch)return;
    ['away','home'].forEach(side=>{
        var stats=side==='away'?currentMatch.awayStats:currentMatch.homeStats;
        var roles=side==='away'?currentMatch.awayRoles:currentMatch.homeRoles;
        var originals=side==='away'?currentMatch.awayOriginal:currentMatch.homeOriginal;
        var el=document.getElementById(side+'Players');
        var h='';
        Object.keys(stats).forEach(nom=>{
            var s=stats[nom];
            var role=roles[nom]||'';
            var moy=s.ab>0?(s.cs/s.ab).toFixed(3):'.000';
            var cls='psr'+(role==='ABS'?' player-abs':'')+(role==='DEF'?' player-def':'');
            var isAdded=!originals[nom]; // joueur ajout√© manuellement
            h+='<div class="'+cls+'"><span class="pn">';
            h+='<select class="role-sel" onchange="setRole(\''+esc(nom)+'\',\''+side+'\',this.value)">';
            h+='<option value=""'+(role===''?' selected':'')+'>‚öæ</option>';
            h+='<option value="ABS"'+(role==='ABS'?' selected':'')+'>ABS</option>';
            h+='<option value="OFF"'+(role==='OFF'?' selected':'')+'>OFF</option>';
            h+='<option value="DEF"'+(role==='DEF'?' selected':'')+'>DEF</option>';
            h+='</select>';
            if(isAdded) h+='<button class="qb abs-btn" onclick="removeBancPlayer(\''+esc(nom)+'\',\''+side+'\')">‚úï</button> ';
            h+=esc(nom)+'</span>';
            ['ab','cs','b1','b2','b3','cc','pc','pp','bb','k'].forEach(f=>{
                h+='<input type="number" value="'+s[f]+'" min="0" onchange="uS(\''+esc(nom)+'\',\''+side+'\',\''+f+'\',this.value)">';
            });
            h+='<span class="moy">'+moy+'</span>';
            h+='<span><button class="qb hit" onclick="qH(\''+esc(nom)+'\',\''+side+'\')">+CS</button><button class="qb out" onclick="qO(\''+esc(nom)+'\',\''+side+'\')">+AB</button></span></div>';
        });
        // Section ajouter substitut avec dropdown de tous les joueurs de la ligue
        var usedNames=Object.keys(stats);
        var available=allJoueurs.filter(j=>usedNames.indexOf(j.nom)===-1);
        h+='<div class="banc-section">üë• Ajouter un substitut: ';
        h+='<select id="bancSel_'+side+'" style="font-size:.75rem;padding:.2rem;min-width:180px">';
        h+='<option value="">‚Äî Choisir un joueur ‚Äî</option>';
        // Grouper par √©quipe
        var byTeam={};
        available.forEach(j=>{
            // Trouver l'√©quipe du joueur
            var eq="AUTRES";
            TEAMS.forEach(t=>{
                var roster=eqRosters[t]||[];
                if(roster.find(r=>r.nom===j.nom))eq=t;
            });
            if(!byTeam[eq])byTeam[eq]=[];
            byTeam[eq].push(j.nom);
        });
        // D'abord les autres √©quipes (pas l'√©quipe courante)
        var teamOrder=TEAMS.filter(t=>t!==(side==='away'?currentMatch.away:currentMatch.home));
        teamOrder.forEach(t=>{
            if(byTeam[t]&&byTeam[t].length>0){
                h+='<optgroup label="'+(TN[t]||t)+'">';
                byTeam[t].sort().forEach(nom=>h+='<option value="'+esc(nom)+'">'+esc(nom)+'</option>');
                h+='</optgroup>';
            }
        });
        if(byTeam['AUTRES']&&byTeam['AUTRES'].length>0){
            h+='<optgroup label="Autres">';
            byTeam['AUTRES'].sort().forEach(nom=>h+='<option value="'+esc(nom)+'">'+esc(nom)+'</option>');
            h+='</optgroup>';
        }
        h+='</select> ';
        h+='<button onclick="addBancPlayer(\''+side+'\')">+ Ajouter</button> ';
        h+='<button onclick="addBancManuel(\''+side+'\')" style="background:var(--primary)">‚úèÔ∏è Manuel</button>';
        h+='</div>';
        el.innerHTML=h;
    });
    updateScores();
}

function setRole(nom,side,role){
    var roles=side==='away'?currentMatch.awayRoles:currentMatch.homeRoles;
    roles[nom]=role;
    if(role==='ABS'||role==='DEF'){
        // Reset stats si absent ou d√©fensif
        var stats=side==='away'?currentMatch.awayStats:currentMatch.homeStats;
        if(stats[nom]){
            stats[nom]={ab:0,cs:0,b1:0,b2:0,b3:0,cc:0,pc:0,pp:0,bb:0,k:0};
        }
    }
    renderMatchPlayers();
}

function addBancPlayer(side){
    var stats=side==='away'?currentMatch.awayStats:currentMatch.homeStats;
    var roles=side==='away'?currentMatch.awayRoles:currentMatch.homeRoles;
    var sel=document.getElementById('bancSel_'+side);
    var nom=sel.value;
    if(!nom){toast('Choisir un joueur','danger');return;}
    if(stats[nom]){toast(nom+' est d√©j√† dans la liste','danger');return;}
    stats[nom]={ab:0,cs:0,b1:0,b2:0,b3:0,cc:0,pc:0,pp:0,bb:0,k:0};
    roles[nom]='OFF';
    renderMatchPlayers();
    toast('‚úÖ '+nom+' ajout√© comme OFF','success');
}

function addBancManuel(side){
    var stats=side==='away'?currentMatch.awayStats:currentMatch.homeStats;
    var roles=side==='away'?currentMatch.awayRoles:currentMatch.homeRoles;
    var usedPlayers=Object.keys(stats);
    var available=allJoueurs.filter(function(j){return usedPlayers.indexOf(j.nom)===-1;});
    available.sort(function(a,b){return a.nom.localeCompare(b.nom);});
    openPlayerPicker('+ Ajouter joueur au banc', available, function(nom){
        if(stats[nom]){toast(nom+' est d√©j√† dans la liste','danger');return;}
        stats[nom]={ab:0,cs:0,b1:0,b2:0,b3:0,cc:0,pc:0,pp:0,bb:0,k:0};
        roles[nom]='OFF';
        renderMatchPlayers();
        toast('‚úÖ '+nom+' ajout√© comme OFF','success');
    });
}

function removeBancPlayer(nom,side){
    var stats=side==='away'?currentMatch.awayStats:currentMatch.homeStats;
    var roles=side==='away'?currentMatch.awayRoles:currentMatch.homeRoles;
    if(!confirm('Retirer '+nom+'?'))return;
    delete stats[nom];
    delete roles[nom];
    renderMatchPlayers();
}

function uS(nom,side,f,v){
    var stats=side==='away'?currentMatch.awayStats:currentMatch.homeStats;
    if(stats[nom])stats[nom][f]=parseInt(v)||0;
    updateScores();
}

function qH(nom,side){
    var stats=side==='away'?currentMatch.awayStats:currentMatch.homeStats;
    if(stats[nom]){stats[nom].ab++;stats[nom].cs++;stats[nom].b1++;}
    renderMatchPlayers();
}

function qO(nom,side){
    var stats=side==='away'?currentMatch.awayStats:currentMatch.homeStats;
    if(stats[nom])stats[nom].ab++;
    renderMatchPlayers();
}

function renderPitchersList(side){
    var pitchers=side==='away'?currentMatch.awayPitchers:currentMatch.homePitchers;
    var el=document.getElementById(side+'PitchersList');
    if(!el)return;
    var inputStyle='width:40px;text-align:center;font-family:\'Bebas Neue\',sans-serif;font-size:1.1rem;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.15);color:white;border-radius:4px;padding:2px';
    var h='';
    pitchers.forEach(function(p,i){
        var label=i===0?'‚≠ê Partant':'üîÑ Releveur '+(i);
        var out=p.out||0;
        var ml=Math.round(out/3*10)/10;
        var moy=ml>0?Math.round((p.pc||0)/ml*100)/100:0;
        h+='<div style="margin-bottom:.5rem;padding:.5rem;background:rgba(255,255,255,.08);border-radius:4px">';
        h+='<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.3rem">';
        h+='<span style="font-size:.7rem;opacity:.7;min-width:65px">'+label+'</span>';
        h+='<strong style="flex:1;font-size:.85rem">'+esc(p.nom)+'</strong>';
        // Afficher ML et MOY calcul√©s en temps r√©el
        h+='<span style="font-size:.7rem;background:rgba(255,255,255,.15);padding:2px 6px;border-radius:3px">ML: '+ml.toFixed(1)+' | MOY: '+moy.toFixed(2)+'</span>';
        if(i>0) h+='<button onclick="removeReliever(\''+side+'\','+i+')" style="background:rgba(255,0,0,.3);color:white;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:.7rem">‚úï</button>';
        h+='</div>';
        h+='<div style="display:flex;gap:.4rem;align-items:center;flex-wrap:wrap">';
        h+='<div style="text-align:center"><input type="number" min="0" value="'+out+'" onchange="setPitcherStat(\''+side+'\','+i+',\'out\',this.value)" style="'+inputStyle+'" /><div style="font-size:.6rem;opacity:.7">OUT</div></div>';
        h+='<div style="text-align:center"><input type="number" min="0" value="'+(p.pc||0)+'" onchange="setPitcherStat(\''+side+'\','+i+',\'pc\',this.value)" style="'+inputStyle+'" /><div style="font-size:.6rem;opacity:.7">PC</div></div>';
        h+='<div style="text-align:center"><input type="number" min="0" value="'+(p.cs||0)+'" onchange="setPitcherStat(\''+side+'\','+i+',\'cs\',this.value)" style="'+inputStyle+'" /><div style="font-size:.6rem;opacity:.7">CS</div></div>';
        h+='<div style="text-align:center"><input type="number" min="0" value="'+(p.bb||0)+'" onchange="setPitcherStat(\''+side+'\','+i+',\'bb\',this.value)" style="'+inputStyle+'" /><div style="font-size:.6rem;opacity:.7">BB</div></div>';
        h+='<div style="text-align:center"><input type="number" min="0" value="'+(p.rb||0)+'" onchange="setPitcherStat(\''+side+'\','+i+',\'rb\',this.value)" style="'+inputStyle+'" /><div style="font-size:.6rem;opacity:.7">RB</div></div>';
        h+='</div>';
        h+='</div>';
    });
    el.innerHTML=h;
}

function setPitcherStat(side,idx,field,val){
    var pitchers=side==='away'?currentMatch.awayPitchers:currentMatch.homePitchers;
    if(pitchers[idx]){
        pitchers[idx][field]=parseInt(val)||0;
        // Re-render to update ML/MOY display
        renderPitchersList(side);
    }
}

function addReliever(side){
    var pitchers=side==='away'?currentMatch.awayPitchers:currentMatch.homePitchers;
    var equipe=side==='away'?currentMatch.away:currentMatch.home;
    var usedPitchers=pitchers.map(function(p){return p.nom;});
    var available=allJoueurs.filter(function(j){return usedPitchers.indexOf(j.nom)===-1;});
    available.sort(function(a,b){return a.nom.localeCompare(b.nom);});
    openPlayerPicker('+ Ajouter releveur', available, function(nom){
        if(usedPitchers.indexOf(nom)!==-1){toast(nom+' est d√©j√† lanceur dans ce match','danger');return;}
        pitchers.push({nom:nom,out:0,pc:0,cs:0,bb:0,rb:0});
        renderPitchersList(side);
        toast('‚úÖ '+nom+' ajout√© comme releveur','success');
    });
}

function removeReliever(side,idx){
    var pitchers=side==='away'?currentMatch.awayPitchers:currentMatch.homePitchers;
    if(idx===0)return; // Can't remove starter
    if(!confirm('Retirer '+pitchers[idx].nom+'?'))return;
    pitchers.splice(idx,1);
    renderPitchersList(side);
}

function updateScores(){
    if(!currentMatch)return;
    var aPC=0,hPC=0,aCS=0,hCS=0,aBB=0,hBB=0;
    var aRoles=currentMatch.awayRoles||{};
    var hRoles=currentMatch.homeRoles||{};
    Object.entries(currentMatch.awayStats).forEach(([nom,s])=>{if(aRoles[nom]!=='ABS'&&aRoles[nom]!=='DEF'){aPC+=s.pc;aCS+=s.cs;aBB+=s.bb;}});
    Object.entries(currentMatch.homeStats).forEach(([nom,s])=>{if(hRoles[nom]!=='ABS'&&hRoles[nom]!=='DEF'){hPC+=s.pc;hCS+=s.cs;hBB+=s.bb;}});
    document.getElementById('awayScore').textContent=aPC;
    document.getElementById('homeScore').textContent=hPC;
    document.getElementById('awayPC').textContent=aPC;
    document.getElementById('homePC').textContent=hPC;
    // Pitcher: opponent stats (totals for display)
    currentMatch.homePitcher={pc:aPC,cs:aCS,bb:aBB};
    currentMatch.awayPitcher={pc:hPC,cs:hCS,bb:hBB};
}

async function endMatch(){
    if(!currentMatch)return;
    if(!confirm('üèÅ Terminer et sauvegarder ce match dans Supabase?'))return;
    toast('üíæ Sauvegarde en cours...','warning');

    var aPC=0,hPC=0;
    var aRoles=currentMatch.awayRoles||{};
    var hRoles=currentMatch.homeRoles||{};
    Object.entries(currentMatch.awayStats).forEach(([nom,s])=>{if(aRoles[nom]!=='ABS'&&aRoles[nom]!=='DEF')aPC+=s.pc;});
    Object.entries(currentMatch.homeStats).forEach(([nom,s])=>{if(hRoles[nom]!=='ABS'&&hRoles[nom]!=='DEF')hPC+=s.pc;});

    try{
        // 1. Save frappeurs_saison ‚Äî upsert each player
        var frRows=[];
        var addFr=function(stats,equipe,roles){
            Object.entries(stats).forEach(function(e){
                var nom=e[0],s=e[1];
                var role=roles[nom]||'';
                if(role==='ABS')return; // Skip absents
                if(role==='DEF')return; // Skip d√©fensifs (pas de stats au b√¢ton)
                if(s.ab>0||s.bb>0||s.pc>0){
                    frRows.push({nom:nom,equipe:equipe});
                }
            });
        };
        addFr(currentMatch.awayStats,currentMatch.away,aRoles);
        addFr(currentMatch.homeStats,currentMatch.home,hRoles);

        // For each player, load existing and update
        for(var i=0;i<frRows.length;i++){
            var nom=frRows[i].nom,eq=frRows[i].equipe;
            var stats=(currentMatch.awayStats[nom])?currentMatch.awayStats[nom]:currentMatch.homeStats[nom];
            var existing=await sbF('frappeurs_saison?saison=eq.'+SAI+'&nom=eq.'+encodeURIComponent(nom));
            if(existing.length>0){
                var ex=existing[0];
                await sbPatch('frappeurs_saison','id=eq.'+ex.id,{
                    pj:(ex.pj||0)+1,
                    ab:(ex.ab||0)+stats.ab,
                    cs:(ex.cs||0)+stats.cs,
                    simples:(ex.simples||ex['1b']||0)+stats.b1,
                    doubles:(ex.doubles||ex['2b']||0)+stats.b2,
                    triples:(ex.triples||ex['3b']||0)+stats.b3,
                    cc:(ex.cc||0)+stats.cc,
                    pc:(ex.pc||0)+stats.pc,
                    pp:(ex.pp||0)+stats.pp,
                    bb:(ex.bb||0)+stats.bb,
                    rb:(ex.rb||0)+stats.k,
                    moy:((ex.cs||0)+stats.cs)/Math.max(1,(ex.ab||0)+stats.ab)
                });
            }else{
                var moy=stats.ab>0?stats.cs/stats.ab:0;
                await sbPost('frappeurs_saison',[{
                    saison:SAI,nom:nom,equipe:eq,pj:1,
                    ab:stats.ab,cs:stats.cs,simples:stats.b1,doubles:stats.b2,triples:stats.b3,
                    cc:stats.cc,pc:stats.pc,pp:stats.pp,bb:stats.bb,sac:0,rb:stats.k,
                    moy:parseFloat(moy.toFixed(3))
                }]);
            }
        }

        // 2. Save lanceurs_saison ‚Äî each pitcher on each side
        var savePitcher=async function(nom,equipe,side,pData){
            if(!nom){console.warn('savePitcher: nom vide, skip');return;}
            var matchOut=pData.out||0;
            var matchPC=pData.pc||0;
            var matchCS=pData.cs||0;
            var matchBB=pData.bb||0;
            var matchRB=pData.rb||0;
            var matchMl=Math.round(matchOut/3*10)/10;
            // D√©terminer type_lanceur A ou B selon le r√¥le dans joueurs_liste
            var joueurInfo=allJoueurs.find(j=>j.nom.toLowerCase()===nom.toLowerCase());
            var typeLanceur=(joueurInfo && (joueurInfo.role==='lanceur_a'||joueurInfo.role==='coachlanceur_a'))?'A':'B';
            var isWin=(side==='away'&&aPC>hPC)||(side==='home'&&hPC>aPC);
            var isLoss=(side==='away'&&aPC<hPC)||(side==='home'&&hPC<aPC);
            var isTie=aPC===hPC;

            // Chercher la cote du joueur dans eqRosters
            var playerCote=null;
            var roster=eqRosters[equipe]||[];
            var rosterPlayer=roster.find(p=>p.nom===nom);
            if(rosterPlayer) playerCote=rosterPlayer.cote;

            try{
                var existing=await sbF('lanceurs_saison?saison=eq.'+SAI+'&nom=eq.'+encodeURIComponent(nom));
                console.log('savePitcher',nom,'existing:',existing,'pData:',pData);
                if(existing.length>0){
                    var ex=existing[0];
                    var newOut=(ex.out||0)+matchOut;
                    var newMl=Math.round(newOut/3*10)/10;
                    var newPC=(ex.pc||0)+matchPC;
                    var updateData={
                        pl:(ex.pl||0)+1,
                        ml:newMl,
                        out:newOut,
                        v:(ex.v||0)+(isWin?1:0),
                        d:(ex.d||0)+(isLoss?1:0),
                        n:(ex.n||0)+(isTie?1:0),
                        pc:newPC,
                        cs:(ex.cs||0)+matchCS,
                        bb:(ex.bb||0)+matchBB,
                        rb:(ex.rb||0)+matchRB,
                        // FIX: MOY = PC √∑ ML (et non PC √ó 7 √∑ ML)
                        moy:newMl>0?Math.round(newPC/newMl*100)/100:0
                    };
                    // Mettre √† jour la cote si pas encore d√©finie
                    if(!ex.cote && playerCote) updateData.cote=playerCote;
                    var result=await sbPatch('lanceurs_saison','id=eq.'+ex.id,updateData);
                    console.log('savePitcher PATCH result:',result);
                }else{
                    // Chercher type_lanceur: priorit√© au r√¥le actuel, puis historique
                    var finalType=typeLanceur; // A ou B bas√© sur joueurs_liste
                    if(!finalType || finalType==='B'){
                        // V√©rifier si historique a un type A
                        try{
                            var prev=await sbF('lanceurs_saison?nom=eq.'+encodeURIComponent(nom)+'&type_lanceur=eq.A&order=saison.desc&limit=1');
                            if(prev.length>0) finalType='A';
                        }catch(e){}
                    }

                    var insertData={
                        saison:SAI,nom:nom,equipe:equipe,
                        pl:1,ml:matchMl,out:matchOut,v:isWin?1:0,d:isLoss?1:0,n:isTie?1:0,
                        pc:matchPC,cs:matchCS,bb:matchBB,rb:matchRB,
                        // FIX: MOY = PC √∑ ML (et non PC √ó 7 √∑ ML)
                        moy:matchMl>0?Math.round(matchPC/matchMl*100)/100:0,
                        type_lanceur:finalType
                    };
                    if(playerCote) insertData.cote=playerCote;

                    var result=await sbInsert('lanceurs_saison',[ insertData ]);
                    console.log('savePitcher INSERT result:',result);
                }
            }catch(err){
                console.error('savePitcher ERROR pour',nom,':',err);
                toast('‚ö†Ô∏è Erreur sauvegarde lanceur '+nom,'danger');
            }
        };
        // Save all pitchers for each side
        for(var pi=0;pi<currentMatch.awayPitchers.length;pi++){
            var p=currentMatch.awayPitchers[pi];
            await savePitcher(p.nom,currentMatch.away,'away',p);
        }
        for(var pi=0;pi<currentMatch.homePitchers.length;pi++){
            var p=currentMatch.homePitchers[pi];
            await savePitcher(p.nom,currentMatch.home,'home',p);
        }

        // 3. Update matchs_regulier score + status using matchId
        if(currentMatch.matchId){
            await sbPatch('matchs_regulier','id=eq.'+currentMatch.matchId,{score_visiteur:aPC,score_local:hPC,status:'final'});

            // 4. Sauvegarder le d√©tail dans pointage_frappeurs/lanceurs (pour annulation future)
            await sbDel('pointage_frappeurs','match_id=eq.'+currentMatch.matchId);
            await sbDel('pointage_lanceurs','match_id=eq.'+currentMatch.matchId);

            var pfRows=[];var ordre=1;
            var saveSide=function(stats,equipe){
                Object.entries(stats).forEach(function(e){
                    var nom=e[0],s=e[1];
                    pfRows.push({match_id:currentMatch.matchId,equipe:equipe,joueur:nom,pos:'',role:'',ordre:ordre++,
                        m1:'',m2:'',m3:'',m4:'',m5:'',m6:'',m7:'',m8:'',m9:'',m10:'',
                        ab:s.ab||0,r:s.pc||0,h:s.cs||0,rbi:s.pp||0,e:0});
                });
            };
            saveSide(currentMatch.awayStats,currentMatch.away);
            saveSide(currentMatch.homeStats,currentMatch.home);
            if(pfRows.length>0)await sbPost('pointage_frappeurs',pfRows);

            // Sauvegarder lanceurs dans pointage_lanceurs
            var plRows=[];
            var plOrdre=1;
            currentMatch.awayPitchers.forEach(function(p){
                plRows.push({match_id:currentMatch.matchId,equipe:currentMatch.away,joueur:p.nom,ordre:plOrdre++,
                    ip:p.out||0,h:p.cs||0,r:p.pc||0,er:p.pc||0,bb:p.bb||0,k:p.rb||0});
            });
            currentMatch.homePitchers.forEach(function(p){
                plRows.push({match_id:currentMatch.matchId,equipe:currentMatch.home,joueur:p.nom,ordre:plOrdre++,
                    ip:p.out||0,h:p.cs||0,r:p.pc||0,er:p.pc||0,bb:p.bb||0,k:p.rb||0});
            });
            if(plRows.length>0)await sbPost('pointage_lanceurs',plRows);
        }

        // Reload data
        frappeurs=await sbF('frappeurs_saison?saison=eq.'+SAI+'&order=moy.desc');
        lanceurs=await sbF('lanceurs_saison?saison=eq.'+SAI+'&order=v.desc');
        matchsFinal=await sbF('matchs_regulier?saison=eq.'+SAI+'&status=eq.final&order=date.desc');
        matchsCal=await sbF('matchs_regulier?saison=eq.'+SAI+'&order=date.asc,heure.asc');

        currentMatch=null;selectedMatch=null;
        document.getElementById('scoreboard').style.display='none';
        document.getElementById('statsEntry').style.display='none';
        loadMatchSelect();
        renderRecentGames();renderStandings();renderLeaders();renderPlayersStats();renderPitchersStats();
        toast('üèÅ Match termin√© et sauvegard√© dans Supabase!','success');
    }catch(e){
        console.error(e);
        toast('‚ùå Erreur: '+e.message,'danger');
    }
}

/* ==========================================
   STANDINGS (from matchs_regulier final)
   ========================================== */
function renderStandings(){
    var teams={};
    TEAMS.forEach(t=>teams[t]={pj:0,v:0,d:0,n:0,pp:0,pc:0});
    matchsFinal.forEach(g=>{
        var sv=g.score_visiteur||0,sl=g.score_local||0;
        var vis=g.visiteur,loc=g.local;
        if(!teams[vis]||!teams[loc])return;
        teams[vis].pj++;teams[loc].pj++;
        teams[vis].pp+=sv;teams[vis].pc+=sl;
        teams[loc].pp+=sl;teams[loc].pc+=sv;
        if(sv>sl){teams[vis].v++;teams[loc].d++;}
        else if(sl>sv){teams[loc].v++;teams[vis].d++;}
        else{teams[vis].n++;teams[loc].n++;}
    });
    var sorted=Object.entries(teams).map(e=>({name:e[0],...e[1],pts:e[1].v*2+e[1].n,diff:e[1].pp-e[1].pc})).sort((a,b)=>b.pts-a.pts||b.diff-a.diff);
    document.getElementById('standingsTable').innerHTML=sorted.map((t,i)=>'<tr><td><strong>'+(i+1)+'</strong></td><td style="color:'+TC[t.name]+'"><strong>'+(TN[t.name]||t.name)+'</strong></td><td>'+t.pj+'</td><td><strong>'+t.v+'</strong></td><td>'+t.d+'</td><td>'+t.n+'</td><td>'+t.pp+'</td><td>'+t.pc+'</td><td style="color:'+(t.diff>=0?'green':'red')+'">'+(t.diff>=0?'+':'')+t.diff+'</td><td><strong>'+t.pts+'</strong></td></tr>').join('');
}

/* ==========================================
   LEADERS (from frappeurs_saison + lanceurs_saison)
   ========================================== */
function renderLeaders(){
    var fp=frappeurs.filter(p=>p.ab>=5);

    var mkList=function(arr,valFn,fmtFn){
        if(arr.length===0)return'<p style="padding:1rem;color:#999">Pas assez de donn√©es</p>';
        return arr.slice(0,10).map((p,i)=>'<div class="leader-item"><span class="rank">'+(i+1)+'</span><span class="name">'+esc(p.nom)+' <small style="color:#999">('+esc(p.equipe||'')+')</small></span><span class="value">'+(fmtFn?fmtFn(p):valFn(p))+'</span></div>').join('');
    };

    document.getElementById('leadersMoy').innerHTML=mkList([...fp].sort((a,b)=>(b.moy||0)-(a.moy||0)),null,p=>(p.moy||0).toFixed(3));
    document.getElementById('leadersCS').innerHTML=mkList([...frappeurs].sort((a,b)=>(b.cs||0)-(a.cs||0)),p=>p.cs||0);
    document.getElementById('leadersCC').innerHTML=mkList([...frappeurs].sort((a,b)=>(b.cc||0)-(a.cc||0)),p=>p.cc||0);
    document.getElementById('leadersPC').innerHTML=mkList([...frappeurs].sort((a,b)=>(b.pc||0)-(a.pc||0)),p=>p.pc||0);
    document.getElementById('leadersPP').innerHTML=mkList([...frappeurs].sort((a,b)=>(b.pp||0)-(a.pp||0)),p=>p.pp||0);

    // Pitcher wins
    var lp=[...lanceurs].sort((a,b)=>(b.v||0)-(a.v||0));
    document.getElementById('leadersWins').innerHTML=mkList(lp,null,p=>(p.v||0)+'-'+(p.d||0));
}

/* ==========================================
   PLAYER STATS
   ========================================== */
function renderPlayersStats(){
    var filter=document.getElementById('filterTeamPlayers')?.value||'';
    var data=frappeurs.filter(p=>!filter||p.equipe===filter);
    data.sort((a,b)=>(b.moy||0)-(a.moy||0));
    var tb=document.getElementById('playersStatsTable');
    if(data.length===0){tb.innerHTML='<tr><td colspan="14" style="text-align:center;padding:2rem">Aucune statistique</td></tr>';return;}
    tb.innerHTML=data.map((p,i)=>'<tr><td>'+(i+1)+'</td><td><strong>'+esc(p.nom)+'</strong></td><td style="color:'+TC[p.equipe]+'">'+esc(p.equipe||'')+'</td><td>'+(p.pj||0)+'</td><td>'+(p.ab||0)+'</td><td><strong>'+(p.cs||0)+'</strong></td><td>'+(p.simples||p['1b']||0)+'</td><td>'+(p.doubles||p['2b']||0)+'</td><td>'+(p.triples||p['3b']||0)+'</td><td>'+(p.cc||0)+'</td><td>'+(p.pc||0)+'</td><td>'+(p.pp||0)+'</td><td>'+(p.bb||0)+'</td><td>'+(p.rb||0)+'</td><td><strong>'+(p.moy||0).toFixed(3)+'</strong></td></tr>').join('');
}

/* ==========================================
   PITCHER STATS ‚Äî FIX: OUT, ML, MOY (PC√∑ML) au lieu de %V
   ========================================== */
function renderPitchersStats(){
    var data=[...lanceurs].sort((a,b)=>(b.v||0)-(a.v||0));
    var tb=document.getElementById('pitchersStatsTable');
    if(data.length===0){tb.innerHTML='<tr><td colspan="14" style="text-align:center;padding:2rem">Aucune statistique</td></tr>';return;}
    tb.innerHTML=data.map((p,i)=>{
        var out=p.out||0;
        var ml=p.ml||Math.round(out/3*10)/10;
        // MOY lanceur = PC √∑ ML (moyennne de points compt√©s par manche lanc√©e)
        var moy=ml>0?Math.round((p.pc||0)/ml*100)/100:0;
        return'<tr><td>'+(i+1)+'</td><td><strong>'+esc(p.nom)+'</strong></td><td style="color:'+TC[p.equipe]+'">'+esc(p.equipe||'')+'</td><td>'+(p.pl||0)+'</td><td><strong>'+(p.v||0)+'</strong></td><td>'+(p.d||0)+'</td><td>'+(p.n||0)+'</td><td>'+out+'</td><td>'+ml.toFixed(1)+'</td><td>'+(p.pc||0)+'</td><td>'+(p.cs||0)+'</td><td>'+(p.bb||0)+'</td><td>'+(p.rb||0)+'</td><td><strong>'+moy.toFixed(2)+'</strong></td></tr>';
    }).join('');
}

/* ==========================================
   RECENT GAMES
   ========================================== */
function renderRecentGames(){
    var tb=document.getElementById('recentGames');
    if(matchsFinal.length===0){tb.innerHTML='<tr><td colspan="5" style="text-align:center;padding:2rem">Aucun match jou√©</td></tr>';return;}
    tb.innerHTML=matchsFinal.slice(0,15).map(g=>'<tr><td>'+esc(g.date)+'</td><td style="color:'+(TC[g.visiteur]||'#333')+'"><strong>'+esc(TN[g.visiteur]||g.visiteur)+'</strong></td><td><strong>'+(g.score_visiteur||0)+' - '+(g.score_local||0)+'</strong></td><td style="color:'+(TC[g.local]||'#333')+'"><strong>'+esc(TN[g.local]||g.local)+'</strong></td><td style="display:flex;gap:.3rem"><a href="pointage.html?id='+g.id+'&admin=1" class="btn btn-primary" style="padding:.25rem .5rem;font-size:.75rem;text-decoration:none" title="Voir pointage">üìã</a> <button class="btn btn-warning" style="padding:.25rem .5rem;font-size:.75rem" onclick="corrigerMatch('+g.id+')" title="Corriger les stats">‚úèÔ∏è</button> <button class="btn btn-danger" style="padding:.25rem .5rem;font-size:.75rem" onclick="annulerMatch('+g.id+')" title="Effacer le match">üóëÔ∏è</button></td></tr>').join('');
}

/* Annuler un match finalis√© ‚Äî soustrait les stats et remet √† a_venir */
async function corrigerMatch(matchId){
    if(!confirm('‚úèÔ∏è Corriger ce match?\n\nLes stats vont √™tre soustraites et le match rouvert pour correction.\nVous pourrez ressaisir les stats correctes.'))return;
    toast('üîÑ R√©ouverture du match...','warning');
    try{
        // R√©cup√©rer les infos du match
        var matchInfo=matchsFinal.find(m=>m.id===matchId);
        if(!matchInfo){toast('Match introuvable','danger');return;}

        // Charger le d√©tail du pointage
        var pf=await sbF('pointage_frappeurs?match_id=eq.'+matchId);
        var pl=await sbF('pointage_lanceurs?match_id=eq.'+matchId);

        // Soustraire stats frappeurs
        for(var i=0;i<pf.length;i++){
            var f=pf[i];
            if(!f.joueur)continue;
            var existing=await sbF('frappeurs_saison?saison=eq.'+SAI+'&nom=eq.'+encodeURIComponent(f.joueur));
            if(existing.length>0){
                var ex=existing[0];
                var newPj=Math.max(0,(ex.pj||0)-1);
                var newAb=Math.max(0,(ex.ab||0)-(f.ab||0));
                var newCs=Math.max(0,(ex.cs||0)-(f.h||0));
                var newPc=Math.max(0,(ex.pc||0)-(f.r||0));
                var newPp=Math.max(0,(ex.pp||0)-(f.rbi||0));
                var newMoy=newAb>0?newCs/newAb:0;
                if(newPj===0){ await sbDel('frappeurs_saison','id=eq.'+ex.id); }
                else{ await sbPatch('frappeurs_saison','id=eq.'+ex.id,{pj:newPj,ab:newAb,cs:newCs,pc:newPc,pp:newPp,moy:parseFloat(newMoy.toFixed(3))}); }
            }
        }

        // Soustraire stats lanceurs
        for(var j=0;j<pl.length;j++){
            var l=pl[j];
            if(!l.joueur)continue;
            var exL=await sbF('lanceurs_saison?saison=eq.'+SAI+'&nom=eq.'+encodeURIComponent(l.joueur));
            if(exL.length>0){
                var ex2=exL[0];
                var newPl=Math.max(0,(ex2.pl||0)-1);
                if(newPl===0){ await sbDel('lanceurs_saison','id=eq.'+ex2.id); }
                else{
                    var sv=matchInfo.score_visiteur||0;
                    var sl=matchInfo.score_local||0;
                    var isVis=l.equipe===matchInfo.visiteur;
                    var wasWin=isVis?(sv>sl):(sl>sv);
                    var wasLoss=isVis?(sv<sl):(sl<sv);
                    var wasTie=sv===sl;
                    var nOut=Math.max(0,(ex2.out||0)-(l.ip||0));
                    var nMl=Math.round(nOut/3*10)/10;
                    var nPC=Math.max(0,(ex2.pc||0)-(l.r||0));
                    await sbPatch('lanceurs_saison','id=eq.'+ex2.id,{
                        pl:newPl,out:nOut,ml:nMl,
                        v:Math.max(0,(ex2.v||0)-(wasWin?1:0)),
                        d:Math.max(0,(ex2.d||0)-(wasLoss?1:0)),
                        n:Math.max(0,(ex2.n||0)-(wasTie?1:0)),
                        pc:nPC,cs:Math.max(0,(ex2.cs||0)-(l.h||0)),
                        bb:Math.max(0,(ex2.bb||0)-(l.bb||0)),
                        rb:Math.max(0,(ex2.rb||0)-(l.k||0)),
                        moy:nMl>0?Math.round(nPC/nMl*100)/100:0
                    });
                }
            }
        }

        // Supprimer les donn√©es de pointage
        await sbDel('pointage_frappeurs','match_id=eq.'+matchId);
        await sbDel('pointage_lanceurs','match_id=eq.'+matchId);
        await sbDel('pointage_manches','match_id=eq.'+matchId);

        // Remettre le match √† a_venir avec scores √† null
        await sbPatch('matchs_regulier','id=eq.'+matchId,{score_visiteur:null,score_local:null,status:'a_venir'});

        // Recharger les donn√©es
        frappeurs=await sbF('frappeurs_saison?saison=eq.'+SAI+'&order=moy.desc');
        lanceurs=await sbF('lanceurs_saison?saison=eq.'+SAI+'&order=v.desc');
        matchsFinal=await sbF('matchs_regulier?saison=eq.'+SAI+'&status=eq.final&order=date.desc');
        matchsCal=await sbF('matchs_regulier?saison=eq.'+SAI+'&order=date.asc,heure.asc');

        // Trouver le match dans le calendrier et le s√©lectionner automatiquement
        selectedMatch=matchsCal.find(m=>m.id===matchId);

        // R√©cup√©rer les lanceurs partants depuis le pointage
        var pitcherAway='';var pitcherHome='';
        if(pl.length>0){
            var visLanceurs=pl.filter(function(p){return p.equipe===matchInfo.visiteur;});
            var homLanceurs=pl.filter(function(p){return p.equipe===matchInfo.local;});
            if(visLanceurs.length>0) pitcherAway=visLanceurs[0].joueur;
            if(homLanceurs.length>0) pitcherHome=homLanceurs[0].joueur;
        }

        // D√©marrer le match avec les lanceurs partants d'origine
        if(selectedMatch){
            var away=matchInfo.visiteur;
            var home=matchInfo.local;
            var rA=eqRosters[away]||[];
            var rH=eqRosters[home]||[];
            if(rA.length===0) rA=allJoueurs.map(j=>({nom:j.nom}));
            if(rH.length===0) rH=allJoueurs.map(j=>({nom:j.nom}));
            currentMatch={matchId:matchId,date:matchInfo.date,away:away,home:home,
                pitcherAway:pitcherAway,pitcherHome:pitcherHome,
                awayStats:{},homeStats:{},
                awayPitchers:[{nom:pitcherAway,out:0,pc:0,cs:0,bb:0,rb:0}],
                homePitchers:[{nom:pitcherHome,out:0,pc:0,cs:0,bb:0,rb:0}],
                awayRoles:{},homeRoles:{},awayOriginal:{},homeOriginal:{}};
            rA.forEach(p=>{currentMatch.awayStats[p.nom]={ab:0,cs:0,b1:0,b2:0,b3:0,cc:0,pc:0,pp:0,bb:0,k:0};currentMatch.awayOriginal[p.nom]=true;});
            rH.forEach(p=>{currentMatch.homeStats[p.nom]={ab:0,cs:0,b1:0,b2:0,b3:0,cc:0,pc:0,pp:0,bb:0,k:0};currentMatch.homeOriginal[p.nom]=true;});
            document.getElementById('scoreboard').style.display='grid';
            document.getElementById('statsEntry').style.display='grid';
            document.getElementById('awayTeamName').textContent=TN[away]||away;
            document.getElementById('homeTeamName').textContent=TN[home]||home;
            document.getElementById('matchDateDisplay').textContent=matchInfo.date;
            document.getElementById('awayHeader').style.background=TC[away]||'#333';
            document.getElementById('homeHeader').style.background=TC[home]||'#333';
            document.getElementById('awayHeader').style.color=(away==='VAUTOURS')?'var(--dark)':'white';
            document.getElementById('homeHeader').style.color=(home==='VAUTOURS')?'var(--dark)':'white';
            document.getElementById('awayHeaderName').textContent='‚öæ '+(TN[away]||away).toUpperCase();
            document.getElementById('homeHeaderName').textContent='‚öæ '+(TN[home]||home).toUpperCase();
            renderMatchPlayers();
            renderPitchersList('away');
            renderPitchersList('home');
            // Scroll vers le haut pour voir l'interface de saisie
            document.getElementById('scoreboard').scrollIntoView({behavior:'smooth'});
        }
        renderRecentGames();
        renderCalendar();
        toast('‚úèÔ∏è Match rouvert ‚Äî ressaisissez les stats!','success');
    }catch(err){
        console.error('corrigerMatch ERROR:',err);
        toast('‚ö†Ô∏è Erreur: '+err.message,'danger');
    }
}

async function annulerMatch(matchId){
    if(!confirm('‚ö†Ô∏è Annuler ce match?\n\nCela va:\n- Remettre le match √† "√Ä venir"\n- Soustraire les stats des frappeurs\n- Soustraire les stats des lanceurs\n\nContinuer?'))return;
    if(!confirm('üî¥ Cette action est irr√©versible. √ätes-vous s√ªr?'))return;

    toast('üîÑ Annulation en cours...','warning');
    try{
        // 1. Charger les stats individuelles de ce match depuis pointage_frappeurs
        var pf=await sbF('pointage_frappeurs?match_id=eq.'+matchId);
        var pl=await sbF('pointage_lanceurs?match_id=eq.'+matchId);
        var matchInfo=matchsCal.find(m=>m.id===matchId)||matchsFinal.find(m=>m.id===matchId);

        // 2. Soustraire stats frappeurs
        for(var i=0;i<pf.length;i++){
            var f=pf[i];
            if(!f.joueur)continue;
            var existing=await sbF('frappeurs_saison?saison=eq.'+SAI+'&nom=eq.'+encodeURIComponent(f.joueur));
            if(existing.length>0){
                var ex=existing[0];
                var newPj=Math.max(0,(ex.pj||0)-1);
                var newAb=Math.max(0,(ex.ab||0)-(f.ab||0));
                var newCs=Math.max(0,(ex.cs||0)-(f.h||0));   // h dans pointage = CS
                var newPc=Math.max(0,(ex.pc||0)-(f.r||0));   // r dans pointage = PC
                var newPp=Math.max(0,(ex.pp||0)-(f.rbi||0)); // rbi dans pointage = PP
                var newMoy=newAb>0?newCs/newAb:0;
                if(newPj===0){
                    await sbDel('frappeurs_saison','id=eq.'+ex.id);
                }else{
                    await sbPatch('frappeurs_saison','id=eq.'+ex.id,{
                        pj:newPj,ab:newAb,cs:newCs,pc:newPc,pp:newPp,
                        moy:parseFloat(newMoy.toFixed(3))
                    });
                }
            }
        }

        // 3. Soustraire stats lanceurs
        for(var j=0;j<pl.length;j++){
            var l=pl[j];
            if(!l.joueur)continue;
            var exL=await sbF('lanceurs_saison?saison=eq.'+SAI+'&nom=eq.'+encodeURIComponent(l.joueur));
            if(exL.length>0){
                var ex2=exL[0];
                var newPl=Math.max(0,(ex2.pl||0)-1);
                if(newPl===0){
                    await sbDel('lanceurs_saison','id=eq.'+ex2.id);
                }else{
                    // D√©terminer V/D/N de ce match pour soustraire
                    var sv=matchInfo?matchInfo.score_visiteur||0:0;
                    var sl=matchInfo?matchInfo.score_local||0:0;
                    var isVis=matchInfo&&l.equipe===matchInfo.visiteur;
                    var wasWin=isVis?(sv>sl):(sl>sv);
                    var wasLoss=isVis?(sv<sl):(sl<sv);
                    var wasTie=sv===sl;
                    var nOut=Math.max(0,(ex2.out||0)-(l.ip||0));
                    var nMl=Math.round(nOut/3*10)/10;
                    var nPC=Math.max(0,(ex2.pc||0)-(l.r||0));
                    await sbPatch('lanceurs_saison','id=eq.'+ex2.id,{
                        pl:newPl,
                        out:nOut,
                        ml:nMl,
                        v:Math.max(0,(ex2.v||0)-(wasWin?1:0)),
                        d:Math.max(0,(ex2.d||0)-(wasLoss?1:0)),
                        n:Math.max(0,(ex2.n||0)-(wasTie?1:0)),
                        pc:nPC,
                        cs:Math.max(0,(ex2.cs||0)-(l.h||0)),
                        bb:Math.max(0,(ex2.bb||0)-(l.bb||0)),
                        rb:Math.max(0,(ex2.rb||0)-(l.k||0)),
                        // FIX: MOY = PC √∑ ML (et non PC √ó 7 √∑ ML)
                        moy:nMl>0?Math.round(nPC/nMl*100)/100:0
                    });
                }
            }
        }

        // 4. Supprimer les donn√©es de pointage de ce match
        await sbDel('pointage_frappeurs','match_id=eq.'+matchId);
        await sbDel('pointage_lanceurs','match_id=eq.'+matchId);
        await sbDel('pointage_manches','match_id=eq.'+matchId);

        // 5. Remettre le match √† a_venir
        await sbPatch('matchs_regulier','id=eq.'+matchId,{score_visiteur:null,score_local:null,status:'a_venir'});

        // 6. Recharger tout
        frappeurs=await sbF('frappeurs_saison?saison=eq.'+SAI+'&order=moy.desc');
        lanceurs=await sbF('lanceurs_saison?saison=eq.'+SAI+'&order=v.desc');
        matchsFinal=await sbF('matchs_regulier?saison=eq.'+SAI+'&status=eq.final&order=date.desc');
        matchsCal=await sbF('matchs_regulier?saison=eq.'+SAI+'&order=date.asc,heure.asc');

        loadMatchSelect();
        renderRecentGames();renderStandings();renderLeaders();renderPlayersStats();renderPitchersStats();
        toast('‚úÖ Match annul√©! Stats soustraites.','success');
    }catch(e){
        console.error(e);
        toast('‚ùå Erreur: '+e.message,'danger');
    }
}

/* ==========================================
   HELPERS
   ========================================== */
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function cancelMatch(){
    if(!currentMatch)return;
    if(!confirm('‚ùå Annuler la saisie de ce match?\n\nAucune donn√©e ne sera sauvegard√©e.'))return;
    currentMatch=null;selectedMatch=null;
    document.getElementById('scoreboard').style.display='none';
    document.getElementById('statsEntry').style.display='none';
    document.getElementById('matchSelect').value='';
    document.getElementById('matchConfig').style.display='none';
    toast('‚ùå Match annul√© ‚Äî rien sauvegard√©','danger');
}
function toast(m,t){var x=document.querySelector('.toast');if(x)x.remove();var e=document.createElement('div');e.className='toast toast-'+(t||'success');e.textContent=m;document.body.appendChild(e);setTimeout(()=>e.remove(),3000);}

init();
</script>
<script src="lbma-analytics.js"></script>

<!-- MODAL S√âLECTEUR DE JOUEUR -->
<div id="playerPickerOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:9999;align-items:center;justify-content:center">
    <div style="background:#1a1a2e;border:2px solid #D4AF37;width:90%;max-width:420px;border-radius:6px;overflow:hidden">
        <div style="background:#D4AF37;padding:.75rem 1rem;display:flex;justify-content:space-between;align-items:center">
            <span id="playerPickerTitle" style="font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:#1a1a1a">Choisir un joueur</span>
            <button onclick="closePlayerPicker()" style="background:none;border:none;color:#1a1a1a;font-size:1.3rem;cursor:pointer;line-height:1">‚úï</button>
        </div>
        <div style="padding:.75rem">
            <input id="playerPickerSearch" type="text" placeholder="üîç Rechercher..." 
                oninput="filterPlayerPicker()"
                style="width:100%;padding:.5rem .75rem;border:2px solid #D4AF37;background:#0d0d1a;color:white;font-size:.95rem;border-radius:3px;box-sizing:border-box;margin-bottom:.5rem">
            <div id="playerPickerList" style="max-height:320px;overflow-y:auto;display:flex;flex-direction:column;gap:2px"></div>
        </div>
    </div>
</div>

<script>
var _pickerCallback = null;
var _pickerPlayers = [];

function openPlayerPicker(title, players, callback) {
    _pickerCallback = callback;
    _pickerPlayers = players;
    document.getElementById('playerPickerTitle').textContent = title;
    document.getElementById('playerPickerSearch').value = '';
    renderPickerList(players);
    var overlay = document.getElementById('playerPickerOverlay');
    overlay.style.display = 'flex';
    setTimeout(function(){ document.getElementById('playerPickerSearch').focus(); }, 100);
}

function renderPickerList(players) {
    var list = document.getElementById('playerPickerList');
    if (players.length === 0) {
        list.innerHTML = '<div style="color:#888;text-align:center;padding:1rem;font-size:.85rem">Aucun joueur trouv√©</div>';
        return;
    }
    list.innerHTML = players.map(function(p) {
        var coteColor = ['','#f44336','#FF9800','#FFC107','#2e7d32','#0d47a1'][p.cote] || '#888';
        var roleIcon = p.role === 'lanceur_a' || p.role === 'coachlanceur_a' ? ' üéØ' : (p.role === 'coach' ? ' üëî' : '');
        return '<div onclick="selectPlayer(\'' + p.nom.replace(/'/g,"\\'") + '\')" '
            + 'style="padding:.5rem .75rem;cursor:pointer;border-radius:3px;display:flex;align-items:center;gap:.6rem;'
            + 'background:rgba(255,255,255,.05);transition:background .15s" '
            + 'onmouseover="this.style.background=\'rgba(212,175,55,.2)\'" '
            + 'onmouseout="this.style.background=\'rgba(255,255,255,.05)\'">'
            + '<span style="background:' + coteColor + ';color:white;width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;flex-shrink:0">' + p.cote + '</span>'
            + '<span style="color:white;font-size:.9rem">' + p.nom + roleIcon + '</span>'
            + '</div>';
    }).join('');
}

function filterPlayerPicker() {
    var search = document.getElementById('playerPickerSearch').value.toLowerCase();
    var filtered = _pickerPlayers.filter(function(p) {
        return p.nom.toLowerCase().includes(search);
    });
    renderPickerList(filtered);
}

function selectPlayer(nom) {
    closePlayerPicker();
    if (_pickerCallback) _pickerCallback(nom);
}

function closePlayerPicker() {
    document.getElementById('playerPickerOverlay').style.display = 'none';
    _pickerCallback = null;
}

// Fermer avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closePlayerPicker();
});
// Fermer en cliquant dehors
document.getElementById('playerPickerOverlay').addEventListener('click', function(e) {
    if (e.target === this) closePlayerPicker();
});
</script>
</body>
</html>
