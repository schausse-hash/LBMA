<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - LBMA</title>
    <link rel="icon" type="image/jpeg" href="logo-lbma.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1E3A5F;--accent:#CC0000;--gold:#D4AF37;--white:#FDFBF7;--cream:#F5F1E8;--dark:#1A1A1A;--success:#28a745;--danger:#dc3545;--warning:#ffc107;
              --aigles:#FF8001;--condors:#0070C0;--ducs:#375623;--faucons:#FF0000;--harfangs:#A6A6A6;--vautours:#333366}
        body{font-family:'Work Sans',sans-serif;background:var(--cream);display:flex;min-height:100vh}
        .sidebar{width:240px;background:var(--dark);color:var(--white);position:fixed;height:100vh;overflow-y:auto}
        .sidebar-header{padding:1rem;background:var(--primary);display:flex;align-items:center;gap:.75rem}
        .sidebar-header img{height:40px;background:white;padding:3px;border-radius:5px}
        .sidebar-header h2{font-family:'Bebas Neue',sans-serif;font-size:1.2rem}
        .user-info{padding:.75rem 1rem;background:rgba(255,255,255,.1)}
        .user-info .username{font-family:'Oswald',sans-serif;color:var(--gold)}
        .user-info .logout-btn{background:var(--danger);color:white;border:none;padding:.4rem .75rem;margin-top:.4rem;cursor:pointer;font-size:.75rem;width:100%}
        .menu-section{padding:.4rem 1rem;font-size:.65rem;text-transform:uppercase;color:rgba(255,255,255,.5);margin-top:.75rem}
        .menu-item{display:flex;align-items:center;gap:.75rem;padding:.6rem 1rem;cursor:pointer;transition:.3s;border-left:3px solid transparent;font-size:.85rem}
        .menu-item:hover{background:rgba(255,255,255,.1)}
        .menu-item.active{background:var(--primary);border-left-color:var(--gold)}
        .menu-item.superadmin-only{background:linear-gradient(90deg,rgba(204,0,0,.3),transparent)}
        .sidebar-footer{padding:.75rem 1rem;background:rgba(0,0,0,.3);margin-top:auto}
        .sidebar-footer a{color:var(--white);text-decoration:none;opacity:.8;display:block;padding:.2rem 0;font-size:.75rem}
        .sidebar-footer a:hover{color:var(--gold)}
        .main-content{margin-left:240px;flex:1;padding:1.5rem}
        .page-header h1{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--primary)}
        .page-header p{color:#666;font-size:.85rem}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.75rem;margin:1.5rem 0}
        .stat-card{background:var(--white);border:2px solid var(--dark);padding:.75rem;text-align:center}
        .stat-card .number{font-family:'Bebas Neue',sans-serif;font-size:1.75rem;color:var(--primary)}
        .stat-card .label{font-family:'Oswald',sans-serif;text-transform:uppercase;font-size:.65rem;color:#666}
        .content-box{background:var(--white);border:2px solid var(--dark);padding:1.25rem;margin-bottom:1.25rem}
        .content-box h2{font-family:'Oswald',sans-serif;font-size:1.1rem;color:var(--primary);margin-bottom:.75rem;border-bottom:2px solid var(--cream);padding-bottom:.4rem}
        .admin-section{display:none}
        .admin-section.active{display:block}
        .btn{padding:.4rem .75rem;font-family:'Oswald',sans-serif;border:2px solid var(--dark);cursor:pointer;transition:.3s;text-transform:uppercase;font-size:.75rem}
        .btn-success{background:var(--success);color:white;border-color:var(--success)}
        .btn-primary{background:var(--primary);color:white;border-color:var(--primary)}
        .btn-danger{background:var(--danger);color:white;border-color:var(--danger)}
        .btn-warning{background:var(--warning);color:var(--dark);border-color:var(--warning)}
        .btn-secondary{background:var(--cream);color:var(--dark)}
        .btn:hover{opacity:.9}
        .btn-small{padding:.2rem .4rem;font-size:.65rem}
        .btn-group{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.5rem}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem;margin-bottom:.5rem}
        .form-group{margin-bottom:.5rem}
        .form-group label{display:block;font-family:'Oswald',sans-serif;font-size:.75rem;margin-bottom:.25rem;color:var(--primary)}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:.4rem;border:2px solid var(--dark);font-size:.85rem;background:var(--cream)}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);background:var(--white)}
        .alert{padding:.6rem;margin-bottom:.75rem;border-left:4px solid;font-size:.8rem}
        .alert-info{background:#cce5ff;border-color:var(--primary)}
        .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:2000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--white);border:3px solid var(--dark);width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-header{background:var(--primary);color:white;padding:.6rem 1rem;display:flex;justify-content:space-between;align-items:center}
        .modal-header h2{font-family:'Bebas Neue',sans-serif;font-size:1.1rem}
        .modal-header.danger{background:var(--danger)}
        .modal-close{background:none;border:none;color:white;font-size:1.2rem;cursor:pointer}
        .modal-body{padding:1rem}
        .toast{position:fixed;top:20px;right:20px;padding:.6rem 1.25rem;border-radius:5px;color:white;font-weight:bold;z-index:3000;font-size:.85rem}
        .toast-success{background:var(--success)}.toast-danger{background:var(--danger)}
        .item-card{background:var(--cream);border:2px solid var(--dark);padding:.6rem;margin-bottom:.4rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.4rem}
        .item-card h4{font-family:'Oswald',sans-serif;color:var(--primary);font-size:.85rem}
        .item-card p{font-size:.75rem;color:#666}
        .action-btns{display:flex;gap:.25rem}
        .superadmin-content{display:none}
        body.is-superadmin .superadmin-content{display:block}
        body.is-superadmin .menu-item.superadmin-only{display:flex}
        body:not(.is-superadmin) .menu-item.superadmin-only{display:none}
        /* Role-based menu visibility */
        body.is-marqueur .menu-item.admin-only{display:none}
        body.is-marqueur .menu-section.admin-only{display:none}
        body.is-marqueur .menu-item.superadmin-only{display:none}
        body.is-marqueur .menu-section.superadmin-content{display:none}
        body.is-marqueur .admin-only{display:none!important}
        body.is-coach .menu-item.admin-only{display:none}
        body.is-coach .menu-section.admin-only{display:none}
        body.is-coach .menu-item.superadmin-only{display:none}
        body.is-coach .menu-section.superadmin-content{display:none}
        body.is-coach .admin-only{display:none!important}
        .team-color{font-weight:bold;padding:.1rem .4rem;border-radius:3px}
        .team-color.AIGLES{background:var(--aigles);color:white}
        .team-color.CONDORS{background:var(--condors);color:white}
        .team-color.DUCS{background:var(--ducs);color:white}
        .team-color.FAUCONS{background:var(--faucons);color:white}
        .team-color.HARFANGS{background:var(--harfangs);color:white}
        .team-color.VAUTOURS{background:var(--vautours);color:white}
        .status-badge{padding:.15rem .4rem;font-size:.65rem;font-family:'Oswald',sans-serif;display:inline-block}
        .status-badge.final{background:var(--success);color:white}
        .status-badge.avenir{background:var(--cream);color:#666;border:1px solid #ccc}
        .status-badge.ferie{background:var(--gold);color:var(--dark)}
        .data-table{width:100%;border-collapse:collapse;font-size:.8rem}
        .data-table th{background:var(--primary);color:white;padding:.4rem;text-align:left;font-family:'Oswald',sans-serif;font-size:.7rem}
        .data-table td{padding:.35rem;border-bottom:1px solid var(--cream)}
        .data-table tr:hover{background:var(--cream)}
        .games-list{max-height:400px;overflow-y:auto}
        .tabs{display:flex;border-bottom:2px solid var(--dark);margin-bottom:.75rem;flex-wrap:wrap}
        .tab{padding:.4rem .75rem;font-family:'Oswald',sans-serif;cursor:pointer;background:var(--cream);border:2px solid var(--dark);border-bottom:none;margin-right:.15rem;font-size:.8rem}
        .tab.active{background:var(--primary);color:white}
        .tab-content{display:none}.tab-content.active{display:block}
        .team-tab{border-top:3px solid transparent}
        .team-tab.AIGLES{border-top-color:var(--aigles)}.team-tab.CONDORS{border-top-color:var(--condors)}
        .team-tab.DUCS{border-top-color:var(--ducs)}.team-tab.FAUCONS{border-top-color:var(--faucons)}
        .team-tab.HARFANGS{border-top-color:var(--harfangs)}.team-tab.VAUTOURS{border-top-color:var(--vautours)}
        .cote-badge{padding:.2rem .5rem;font-family:'Oswald',sans-serif;font-size:.75rem;border-radius:3px}
        .cote-1{background:#ffebee;color:#c62828}.cote-2{background:#fff3e0;color:#ef6c00}
        .cote-3{background:#fffde7;color:#f9a825}.cote-4{background:#e8f5e9;color:#2e7d32}.cote-5{background:#e3f2fd;color:#1565c0}
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header"><img src="logo-lbma.jpg" alt="LBMA"><h2>Admin LBMA</h2></div>
        <div class="user-info">
            <div>ConnectÃ©: <span class="username" id="currentUser">Admin</span></div>
            <button class="logout-btn" onclick="logout()">ğŸšª DÃ©connexion</button>
        </div>
        <nav>
            <div class="menu-section">Principal</div>
            <div class="menu-item active" onclick="showSection('dashboard',this)">ğŸ  Tableau de Bord</div>
            <div class="menu-section admin-only">Gestion</div>
            <div class="menu-item admin-only" onclick="showSection('joueursList',this)">ğŸƒ Joueurs (Liste)</div>

            <div class="menu-item admin-only" onclick="showSection('calendrier',this)">ğŸ“… Calendrier</div>
            <div class="menu-item admin-only" onclick="showSection('temple',this)">ğŸ† Temple</div>
            <div class="menu-item admin-only" onclick="showSection('reglements',this)">ğŸ“‹ RÃ¨glements</div>
            <div class="menu-item admin-only" onclick="showSection('presse',this)">ğŸ“° MÃ©dias</div>
            <div class="menu-item admin-only" onclick="showSection('contacts',this)">ğŸ‘” Direction/Contacts</div>
            <div class="menu-section admin-only">RepÃªchage & Ã‰quipes</div>
            <div class="menu-item admin-only" onclick="showSection('joueursRepechage',this)">ğŸ‘¥ Joueurs RepÃªchage</div>
            <div class="menu-item admin-only" onclick="showSection('equipesSaison',this)">ğŸ† Ã‰quipes Saison</div>
            <div class="menu-section admin-only">Statistiques</div>
            <div class="menu-item admin-only" onclick="showSection('statsLanceurs',this)">ğŸ¯ Stats Lanceurs</div>
            <div class="menu-section">Live</div>
            <div class="menu-item admin-only" onclick="window.location.href='repechage-admin.html'">ğŸ“‹ RepÃªchage Live</div>
            <div class="menu-item" onclick="window.location.href='stats-live.html'">ğŸ“Š Stats Live / Pointage</div>
            <div class="menu-section superadmin-content">Super Admin</div>
            <div class="menu-item superadmin-only" onclick="showSection('users',this)">ğŸ” Utilisateurs</div>
            <div class="menu-item superadmin-only" onclick="showSection('statsHistoriques',this)">ğŸ“Š Correction Stats</div>
            <div class="menu-section">Aide</div>
            <div class="menu-item" onclick="window.open('tutoriel.html','_blank')">ğŸ“– Tutoriel</div>
            <div class="menu-section">Voir le site</div>
            <div class="menu-item" onclick="window.open('joueurs.html','_blank')" style="opacity:.7">ğŸƒ Joueurs</div>
            <div class="menu-item" onclick="window.open('equipes.html','_blank')" style="opacity:.7">ğŸ‘¥ Ã‰quipes</div>
            <div class="menu-item" onclick="window.open('calendrier.html','_blank')" style="opacity:.7">ğŸ“… Calendrier</div>
            <div class="menu-item" onclick="window.open('temple-renommee.html','_blank')" style="opacity:.7">ğŸ† Temple</div>
        </nav>
        <div class="sidebar-footer" style="margin-top:auto;border-top:1px solid rgba(255,255,255,.2);padding-top:1rem">
            <a href="index.html" style="display:flex;align-items:center;gap:.5rem;background:var(--primary);padding:.5rem .75rem;border-radius:5px;margin-bottom:.5rem">ğŸ  Retour au site</a>
        </div>
    </aside>

    <main class="main-content">
        <!-- DASHBOARD -->
        <section id="dashboard" class="admin-section active">
            <div class="page-header"><h1>ğŸ  Tableau de Bord</h1></div>
            <div class="cards-grid">
                <div class="stat-card"><div class="number">6</div><div class="label">Ã‰quipes</div></div>
                <div class="stat-card"><div class="number" id="statJoueurs">0</div><div class="label">Joueurs</div></div>
                <div class="stat-card"><div class="number" id="statGames">0</div><div class="label">Parties</div></div>
                <div class="stat-card"><div class="number" id="statPlayed">0</div><div class="label">JouÃ©es</div></div>
            </div>
            <div class="content-box">
                <h2>âš¡ Actions Rapides</h2>
                <div class="btn-group">
                    <button class="btn btn-primary admin-only" onclick="showSection('equipes',document.querySelectorAll('.menu-item')[2])">ğŸ‘¥ Ã‰quipes</button>
                    <button class="btn btn-primary admin-only" onclick="showSection('calendrier',document.querySelectorAll('.menu-item')[3])">ğŸ“… Calendrier</button>
                    <a href="stats-live.html" class="btn btn-warning" style="text-decoration:none">ğŸ“Š Stats Live / Pointage</a>
                    <a href="equipes.html" target="_blank" class="btn btn-success" style="text-decoration:none">ğŸŒ Voir Ã‰quipes</a>
                </div>
            </div>

            <!-- ANALYTICS DASHBOARD -->
            <div class="content-box" style="margin-top:1rem">
                <h2>ğŸ“ˆ Statistiques de Visites du Site</h2>
                <div style="display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap">
                    <button class="btn btn-primary btn-small" onclick="loadAnalytics('7')" id="analyticsBtn7" style="opacity:1">7 jours</button>
                    <button class="btn btn-secondary btn-small" onclick="loadAnalytics('30')" id="analyticsBtn30">30 jours</button>
                    <button class="btn btn-secondary btn-small" onclick="loadAnalytics('90')" id="analyticsBtn90">90 jours</button>
                    <button class="btn btn-secondary btn-small" onclick="loadAnalytics('all')" id="analyticsBtnall">Tout</button>
                    <button class="btn btn-danger btn-small" style="margin-left:auto" onclick="purgeAnalytics()">ğŸ—‘ï¸ Purger +90j</button>
                </div>
                <div class="cards-grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr))">
                    <div class="stat-card" style="border-color:var(--primary)"><div class="number" id="anTotal">â€”</div><div class="label">Visites totales</div></div>
                    <div class="stat-card" style="border-color:var(--success)"><div class="number" id="anToday">â€”</div><div class="label">Aujourd'hui</div></div>
                    <div class="stat-card" style="border-color:var(--gold)"><div class="number" id="anAvg">â€”</div><div class="label">Moy./jour</div></div>
                    <div class="stat-card" style="border-color:var(--accent)"><div class="number" id="anTopPage">â€”</div><div class="label">Page #1</div></div>
                </div>
            </div>

            <!-- Appareils -->
            <div class="content-box">
                <h2>ğŸ“± Appareils</h2>
                <div class="cards-grid" style="grid-template-columns:repeat(3,1fr)">
                    <div class="stat-card" style="border-color:#5BA4E6"><div class="number" id="anDesktop" style="color:#5BA4E6">â€”</div><div class="label">ğŸ–¥ï¸ Ordinateur</div></div>
                    <div class="stat-card" style="border-color:#FF9800"><div class="number" id="anTablet" style="color:#FF9800">â€”</div><div class="label">ğŸ“± Tablette</div></div>
                    <div class="stat-card" style="border-color:#4CAF50"><div class="number" id="anMobile" style="color:#4CAF50">â€”</div><div class="label">ğŸ“² Cellulaire</div></div>
                </div>
                <div id="deviceBar" style="display:flex;height:28px;border-radius:4px;overflow:hidden;margin-top:.75rem;border:2px solid var(--dark)"></div>
                <div id="deviceLegend" style="display:flex;gap:1.5rem;margin-top:.5rem;font-size:.75rem;font-family:'Oswald',sans-serif;color:#666;justify-content:center"></div>
            </div>

            <!-- Graphique des visites par jour -->
            <div class="content-box">
                <h2>ğŸ“Š Visites par Jour</h2>
                <div id="analyticsChart" style="height:200px;display:flex;align-items:flex-end;gap:2px;padding:.5rem 0;overflow-x:auto"></div>
            </div>

            <!-- Top pages -->
            <div class="content-box">
                <h2>ğŸ† Pages les plus visitÃ©es</h2>
                <table class="data-table" id="analyticsTopPages">
                    <thead><tr><th>Page</th><th>Visites</th><th>%</th><th>Graphique</th></tr></thead>
                    <tbody id="analyticsTopBody"><tr><td colspan="4" style="text-align:center;color:#888;padding:1rem">Chargement...</td></tr></tbody>
                </table>
            </div>

            <!-- Visites rÃ©centes -->
            <div class="content-box">
                <h2>ğŸ• DerniÃ¨res visites</h2>
                <div style="max-height:250px;overflow-y:auto">
                    <table class="data-table">
                        <thead><tr><th>Date/Heure</th><th>Page</th><th>Source</th><th>Ã‰cran</th></tr></thead>
                        <tbody id="analyticsRecentBody"><tr><td colspan="4" style="text-align:center;color:#888;padding:1rem">Chargement...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Lien Google Analytics -->
            <div class="content-box" style="text-align:center;background:linear-gradient(135deg,#4285f4 0%,#34a853 100%);border-color:#4285f4">
                <a href="https://analytics.google.com/analytics/web/#/p477829022/reports/intelligenthome" target="_blank" style="color:white;text-decoration:none;font-family:'Oswald',sans-serif;font-size:1rem;display:flex;align-items:center;justify-content:center;gap:.5rem">
                    ğŸ“Š Ouvrir Google Analytics (donnÃ©es avancÃ©es) â†’
                </a>
            </div>
        </section>

        <!-- JOUEURS (LISTE COMPLÃˆTE) -->
        <section id="joueursList" class="admin-section">
            <div class="page-header">
                <h1>ğŸƒ Liste des Joueurs <span id="joueursSaison">2026</span></h1>
                <p>GÃ©rez la liste complÃ¨te des joueurs avec toutes leurs informations</p>
            </div>
            
            <!-- Gestion des saisons joueurs -->
            <div class="content-box" style="background:linear-gradient(135deg,#1E3A5F 0%,#2D5A8A 100%);color:white;margin-bottom:1.5rem">
                <h2 style="color:var(--gold);border-bottom-color:rgba(255,255,255,0.3)">ğŸ“… Gestion des Saisons</h2>
                <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem">
                    <label style="font-family:'Oswald',sans-serif">Saison :</label>
                    <select id="joueursSaisonSelect" onchange="changeJoueursSaison()" style="padding:.5rem 1rem;font-size:1.1rem;font-family:'Oswald',sans-serif;border:2px solid var(--gold);background:rgba(255,255,255,.15);color:white;cursor:pointer">
                        <option value="2026" style="color:#333">2026</option>
                        <option value="2025" style="color:#333">2025</option>
                        <option value="2024" style="color:#333">2024</option>
                    </select>
                    <span id="joueursSaisonBadge" style="display:none;background:var(--gold);color:var(--dark);padding:.3rem .8rem;font-family:'Oswald',sans-serif;font-size:.8rem;border-radius:3px">ğŸ“š ARCHIVE</span>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="nouvelleSaisonJoueurs()">ğŸ†• Nouvelle Saison</button>
                    <button class="btn btn-secondary" onclick="downloadJoueursJSON()">ğŸ’¾ TÃ©lÃ©charger JSON (backup)</button>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="content-box">
                <h2>â• Actions</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="openJoueurListModal(-1)">â• Ajouter Joueur</button>
                    <a href="joueurs.html" target="_blank" class="btn btn-primary" style="text-decoration:none">ğŸŒ Voir Page Publique</a>
                    <div style="margin-left:auto;display:flex;gap:.4rem">
    <button class="btn btn-secondary" onclick="printJoueursList()">ğŸ–¨ï¸ Imprimer Liste</button>
    <button class="btn btn-secondary" onclick="window.open('joueurs-repechage-print.html','_blank')" style="background:#5a6b3a;color:white;border-color:#5a6b3a">ğŸ“‹ Liste par cotes</button>
</div>
                </div>
            </div>
            
            <!-- LÃ©gende -->
            <div class="content-box">
                <h2>ğŸ“– LÃ©gende</h2>
                <div style="display:flex;flex-wrap:wrap;gap:1rem;margin-top:.5rem">
                    <span style="background:#28a745;color:white;padding:.3rem .6rem;border-radius:3px">ğŸ‘” Coach</span>
                    <span style="background:#ffc107;color:#333;padding:.3rem .6rem;border-radius:3px">âš™ï¸ Admin Ligue</span>
                    <span style="background:linear-gradient(135deg,#28a745 50%,#ffc107 50%);color:white;padding:.3rem .6rem;border-radius:3px">ğŸ‘”âš™ï¸ Coach+Admin</span>
                    <span style="background:var(--cream);padding:.3rem .6rem;border-radius:3px">Joueur</span>
                </div>
            </div>
            
            <!-- Filtres -->
            <div class="content-box">
                <h2>ğŸ” Filtres</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Rechercher</label>
                        <input type="text" id="adminSearchJoueur" placeholder="Nom..." oninput="renderJoueursList()">
                    </div>
                    <div class="form-group">
                        <label>Cote</label>
                        <select id="adminFilterCote" onchange="renderJoueursList()">
                            <option value="">Toutes</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>RÃ´le</label>
                        <select id="adminFilterRole" onchange="renderJoueursList()">
                            <option value="">Tous</option>
                            <option value="coach">Coach</option>
                            <option value="lanceur_a">ğŸ¯ Lanceur A</option>
                            <option value="coachlanceur_a">ğŸ‘”ğŸ¯ Coach + Lanceur A</option>
                            <option value="admin">Admin Ligue</option>
                            <option value="coachadmin">Coach + Admin</option>
                            <option value="joueur">Joueur</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Table des joueurs -->
            <div class="content-box">
                <h2>ğŸ‘¥ Joueurs (<span id="joueursCount">0</span>)</h2>
                <div style="max-height:600px;overflow-y:auto">
                    <table class="data-table" id="joueursAdminTable">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Cote</th>
                                <th>RÃ´le</th>
                                <th>TÃ©lÃ©phone</th>
                                <th>Courriel</th>
                                <th>Naissance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="joueursAdminBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- CALENDRIER -->
        <section id="calendrier" class="admin-section">
            <div class="page-header">
                <h1>ğŸ“… Calendrier des Parties</h1>
                <p>Saison rÃ©guliÃ¨re + SÃ©ries Ã©liminatoires â€” Supabase</p>
            </div>

            <!-- Onglets RÃ©gulier / SÃ©ries -->
            <div style="display:flex;gap:0;margin-bottom:0">
                <div id="tabRegulier" class="tab" style="padding:.6rem 1.5rem;cursor:pointer;font-family:'Oswald',sans-serif;border:2px solid var(--dark);border-bottom:none;background:var(--primary);color:white" onclick="switchCalTab('regulier')">âš¾ Saison RÃ©guliÃ¨re</div>
                <div id="tabSeries" class="tab" style="padding:.6rem 1.5rem;cursor:pointer;font-family:'Oswald',sans-serif;border:2px solid var(--dark);border-bottom:none;background:var(--cream);color:var(--dark)" onclick="switchCalTab('series')">ğŸ† SÃ©ries</div>
                <div style="flex:1;border-bottom:2px solid var(--dark)"></div>
            </div>

            <!-- SAISON RÃ‰GULIÃˆRE -->
            <div id="calRegulier">
                <div class="content-box" style="border-top:none">
                    <h2>â• Ajouter une Partie (RÃ©guliÃ¨re)</h2>
                    <div class="form-row">
                        <div class="form-group"><label>Saison</label><select id="calSaison" onchange="loadCalendrier()"><option value="2026">2026</option><option value="2025">2025</option></select></div>
                        <div class="form-group"><label>No Match</label><input type="number" id="newNoMatch" min="1" max="30" placeholder="Auto"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Date *</label><input type="date" id="newDate"></div>
                        <div class="form-group"><label>Jour</label>
                            <select id="newJour"><option value="SAMEDI">Samedi</option><option value="VENDREDI">Vendredi</option><option value="LUNDI">Lundi</option><option value="MARDI">Mardi</option><option value="DIMANCHE">Dimanche</option></select>
                        </div>
                        <div class="form-group"><label>Heure *</label>
                            <select id="newHeure"><option value="8H30">8H30</option><option value="9H00">9H00</option><option value="10H00">10H00</option><option value="10H45">10H45</option><option value="11H30">11H30</option><option value="18H30">18H30</option><option value="20H00">20H00</option><option value="21H30">21H30</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Visiteur *</label>
                            <select id="newVisiteur"><option value="AIGLES">Aigles</option><option value="CONDORS">Condors</option><option value="DUCS">Ducs</option><option value="FAUCONS">Faucons</option><option value="HARFANGS">Harfangs</option><option value="VAUTOURS">Vautours</option></select>
                        </div>
                        <div class="form-group"><label>Receveur (Local) *</label>
                            <select id="newLocal"><option value="AIGLES">Aigles</option><option value="CONDORS">Condors</option><option value="DUCS">Ducs</option><option value="FAUCONS">Faucons</option><option value="HARFANGS">Harfangs</option><option value="VAUTOURS">Vautours</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Endroit *</label>
                            <select id="newEndroit"><option value="AUTEUIL">Auteuil</option><option value="JARRY 1">Jarry 1</option><option value="PARC DE LOUISBOURG">Parc de Louisbourg</option></select>
                        </div>
                        <div class="form-group"><label>SpÃ©cial</label>
                            <select id="newSpecial"><option value="">Aucune</option><option value="PATRIOTES">Patriotes</option><option value="ST-JEAN">St-Jean</option><option value="TRAVAIL">Travail</option></select>
                        </div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="addGameSB()">â• Ajouter</button></div>
                </div>

                <div class="content-box">
                    <h2>ğŸ“‹ Parties RÃ©guliÃ¨res (<span id="gameCount">0</span>)</h2>
                    <div class="form-row" style="margin-bottom:.5rem">
                        <div class="form-group"><label>Mois</label><select id="filterMois" onchange="renderGames()"><option value="">Tous</option><option value="04">Avril</option><option value="05">Mai</option><option value="06">Juin</option><option value="07">Juillet</option><option value="08">AoÃ»t</option><option value="09">Sept</option></select></div>
                    </div>
                    <div class="games-list" id="gamesList"></div>
                </div>
            </div>

            <!-- SÃ‰RIES Ã‰LIMINATOIRES -->
            <div id="calSeries" style="display:none">
                <!-- TABLEAU DE BORD SÃ‰RIES -->
                <div class="content-box" style="border-top:none;background:linear-gradient(135deg,#1a1a1a,#2D5A8A);color:white;border-color:var(--gold)">
                    <h2 style="color:var(--gold)">ğŸ† Tableau des SÃ©ries 2026</h2>
                    <p style="font-size:.85rem;opacity:.8;margin-bottom:1rem">
                        <strong>Structure :</strong> R1 = #4vs#5 et #3vs#6 (2 de 3) â†’ R2 = #1 vs gagnant bas, #2 vs gagnant haut (2 de 3) â†’ Finale (3 de 5)<br>
                        <strong>Horaires :</strong> Vendredi 19H00 & 20H45 | Samedi 9H00 & 10H45<br>
                        <strong>RÃ¨gle :</strong> Ã‰quipe mieux classÃ©e joue la 1re game ven+sam. On ne passe pas Ã  la ronde suivante tant qu'une ronde n'est pas terminÃ©e.
                    </p>
                    <div id="seriesTracker" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem;margin-top:1rem"></div>
                </div>

                <!-- FORMULAIRE AJOUT -->
                <div class="content-box">
                    <h2>â• Ajouter un Match de SÃ©ries</h2>
                    <div class="form-row">
                        <div class="form-group"><label>Ronde *</label>
                            <select id="newSerieRonde" onchange="onSerieRondeChange()">
                                <option value="QUART-DE-FINALE">Quart-de-finale (R1)</option>
                                <option value="DEMI-FINALE">Demi-finale (R2)</option>
                                <option value="FINALE">Finale</option>
                            </select>
                        </div>
                        <div class="form-group"><label>SÃ©rie</label>
                            <select id="newSerieId">
                                <option value="R1-A">R1-A (#4 vs #5)</option>
                                <option value="R1-B">R1-B (#3 vs #6)</option>
                            </select>
                        </div>
                        <div class="form-group"><label>No Match</label>
                            <input type="number" id="newSerieNo" min="1" max="5" value="1">
                            <small id="serieFormatHint" style="color:var(--gold)">2 de 3</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Date *</label><input type="date" id="newSerieDate"></div>
                        <div class="form-group"><label>Jour</label>
                            <select id="newSerieJour"><option value="VENDREDI">Vendredi</option><option value="SAMEDI">Samedi</option><option value="LUNDI">Lundi (fÃ©riÃ©)</option></select>
                        </div>
                        <div class="form-group"><label>Heure *</label>
                            <select id="newSerieHeure">
                                <option value="19H00">19H00 (ven)</option>
                                <option value="20H45">20H45 (ven)</option>
                                <option value="9H00">9H00 (sam)</option>
                                <option value="10H45">10H45 (sam)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Visiteur * <small>(mieux classÃ© G1)</small></label>
                            <select id="newSerieVisiteur"><option value="AIGLES">Aigles</option><option value="CONDORS">Condors</option><option value="DUCS">Ducs</option><option value="FAUCONS">Faucons</option><option value="HARFANGS">Harfangs</option><option value="VAUTOURS">Vautours</option></select>
                        </div>
                        <div class="form-group"><label>Seed Vis</label><input type="number" id="newSerieSeedV" min="1" max="6" placeholder="#"></div>
                        <div class="form-group"><label>Local *</label>
                            <select id="newSerieLocal"><option value="AIGLES">Aigles</option><option value="CONDORS">Condors</option><option value="DUCS">Ducs</option><option value="FAUCONS">Faucons</option><option value="HARFANGS">Harfangs</option><option value="VAUTOURS">Vautours</option></select>
                        </div>
                        <div class="form-group"><label>Seed Loc</label><input type="number" id="newSerieSeedL" min="1" max="6" placeholder="#"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Endroit</label>
                            <select id="newSerieEndroit"><option value="JARRY 1">Jarry 1</option><option value="AUTEUIL">Auteuil</option><option value="PARC DE LOUISBOURG">Parc de Louisbourg</option></select>
                        </div>
                        <div class="form-group"><label>Notes</label><input type="text" id="newSerieNotes" placeholder="Ex: Programme double, reprise..."></div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="addSerieSB()">â• Ajouter match de sÃ©rie</button></div>
                </div>

                <!-- LISTE DES MATCHS -->
                <div class="content-box">
                    <h2>ğŸ“‹ Matchs de SÃ©ries (<span id="serieCount">0</span>)</h2>
                    <div class="games-list" id="seriesList"></div>
                </div>
            </div>
        </section>

        <!-- TEMPLE -->
        <section id="temple" class="admin-section">
            <div class="page-header"><h1>ğŸ† Temple de la RenommÃ©e</h1></div>
            
            <div class="btn-group" style="margin-bottom:1rem">
                <a href="temple-renommee.html" target="_blank" class="btn btn-primary" style="text-decoration:none">ğŸŒ Voir la page</a>
            </div>

            <div class="content-box">
                <h2>ğŸ—ï¸ BÃ¢tisseurs</h2>
                <div class="btn-group" style="margin-bottom:.5rem"><button class="btn btn-success" onclick="openTempleModal('batisseur')">â• Ajouter</button></div>
                <div id="batisseursList"></div>
            </div>
            
            <div class="content-box">
                <h2>ğŸ† TrophÃ©es PerpÃ©tuels</h2>
                <div class="btn-group" style="margin-bottom:.5rem"><button class="btn btn-success" onclick="openTempleModal('trophee')">â• Ajouter</button></div>
                <div id="tropheesList"></div>
            </div>
            
            <div class="content-box">
                <h2>ğŸ‘‘ Membres Ã  Vie</h2>
                <div class="btn-group" style="margin-bottom:.5rem"><button class="btn btn-success" onclick="openTempleModal('membre')">â• Ajouter</button></div>
                <div id="membresList"></div>
            </div>
            
            <div class="content-box">
                <h2>ğŸŒ³ Visite GuidÃ©e</h2>
                <div class="form-group"><label>Description</label><textarea id="visiteDesc" rows="2"></textarea></div>
                <div class="form-group"><label>Note</label><textarea id="visiteNote" rows="2"></textarea></div>
                <div class="btn-group"><button class="btn btn-primary" onclick="saveVisite()">ğŸ’¾ Sauvegarder</button></div>
            </div>
        </section>

        <!-- RÃˆGLEMENTS -->
        <section id="reglements" class="admin-section">
            <div class="page-header">
                <h1>ğŸ“‹ RÃ¨glements</h1>
                <p>GÃ©rez le contenu, la visibilitÃ© et les sections de la page des rÃ¨glements</p>
            </div>

            <!-- STATUT DE LA PAGE -->
            <div class="content-box">
                <h2>âš™ï¸ Statut de la page</h2>
                <div class="form-row" style="align-items:flex-end;flex-wrap:wrap;gap:.75rem">
                    <div class="form-group" style="min-width:160px">
                        <label>Version</label>
                        <input type="text" id="regVersion" placeholder="Ex: 2026">
                    </div>
                    <div class="form-group" style="min-width:160px">
                        <label>Date de mise Ã  jour</label>
                        <input type="date" id="regDate">
                    </div>
                    <div class="form-group" style="min-width:200px">
                        <label>VisibilitÃ© de la page</label>
                        <select id="regStatut">
                            <option value="publique">âœ… Page publique (visible)</option>
                            <option value="construction">ğŸš§ En construction (message affichÃ©)</option>
                            <option value="masquee">ğŸ”’ MasquÃ©e (redirige vers accueil)</option>
                        </select>
                    </div>
                </div>
                <div id="regStatutPreview" style="margin-top:.6rem;padding:.6rem 1rem;border-left:4px solid var(--gold);background:#fffbf0;font-size:.82rem;display:none"></div>
                <div class="btn-group" style="margin-top:.75rem">
                    <button class="btn btn-success" onclick="saveReglements()">ğŸ’¾ Sauvegarder</button>
                    <a href="reglements.html" target="_blank" class="btn btn-primary" style="text-decoration:none">ğŸŒ Voir la page</a>
                </div>
            </div>

            <!-- LISTE DES SECTIONS -->
            <div class="content-box">
                <h2>ğŸ“‘ Sections des rÃ¨glements</h2>
                <div class="btn-group" style="margin-bottom:.75rem">
                    <button class="btn btn-success" onclick="regOpenAddSection()">â• Nouvelle section</button>
                </div>
                <div id="regSectionsList" style="display:flex;flex-direction:column;gap:.5rem">
                    <div style="color:#999;font-size:.85rem;padding:1rem;text-align:center">Chargementâ€¦</div>
                </div>
            </div>
        </section>

        <!-- MODAL SECTION RÃˆGLEMENT -->
        <div class="modal" id="regModal">
            <div class="modal-content" style="max-width:680px">
                <div class="modal-header" id="regModalHeader">
                    <h2 id="regModalTitle">Section</h2>
                    <button class="modal-close" onclick="regCloseModal()">âœ•</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="regEditIndex">
                    <div class="form-row">
                        <div class="form-group" style="flex:2">
                            <label>Titre de la section</label>
                            <input type="text" id="regSectionTitre" placeholder="Ex: REPÃŠCHAGE ANNUEL">
                        </div>
                        <div class="form-group" style="flex:1">
                            <label>ID (unique, sans espaces)</label>
                            <input type="text" id="regSectionId" placeholder="Ex: repechage">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>VisibilitÃ© de cette section</label>
                        <select id="regSectionVisible">
                            <option value="1">âœ… Visible</option>
                            <option value="0">ğŸ™ˆ MasquÃ©e</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>RÃ¨gles <span style="color:#999;font-weight:normal">(une rÃ¨gle par ligne)</span></label>
                        <textarea id="regSectionRegles" rows="10" style="font-size:.82rem;line-height:1.5;resize:vertical" placeholder="Une rÃ¨gle par ligneâ€¦"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes / encadrÃ©s <span style="color:#999;font-weight:normal">(une note par ligne)</span></label>
                        <textarea id="regSectionNotes" rows="3" style="font-size:.82rem;resize:vertical" placeholder="Ex: PAUSE SANTÃ‰ de 10 minutes aprÃ¨s le 4e tour."></textarea>
                    </div>
                    <div class="btn-group" style="margin-top:.75rem;justify-content:flex-end">
                        <button class="btn btn-secondary" onclick="regCloseModal()">Annuler</button>
                        <button class="btn btn-success" onclick="regSaveSection()">ğŸ’¾ Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL CONFIRMATION SUPPRESSION -->
        <div class="modal" id="regDeleteModal">
            <div class="modal-content" style="max-width:400px">
                <div class="modal-header danger">
                    <h2>âš ï¸ Supprimer la section</h2>
                    <button class="modal-close" onclick="document.getElementById('regDeleteModal').classList.remove('active')">âœ•</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom:1rem">ÃŠtes-vous sÃ»r de vouloir supprimer la section <strong id="regDeleteName"></strong> ? Cette action est irrÃ©versible.</p>
                    <div class="btn-group" style="justify-content:flex-end">
                        <button class="btn btn-secondary" onclick="document.getElementById('regDeleteModal').classList.remove('active')">Annuler</button>
                        <button class="btn btn-danger" onclick="regConfirmDelete()">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MÃ‰DIAS -->
        <section id="presse" class="admin-section">
            <div class="page-header"><h1>ğŸ“° MÃ©dias</h1></div>
            <div class="content-box">
                <h2>ğŸ“° Articles</h2>
                <div class="btn-group" style="margin-bottom:.5rem"><button class="btn btn-success" onclick="openModal('article')">â•</button></div>
                <div id="articlesList"></div>
            </div>
            <div class="content-box">
                <h2>ğŸ™ï¸ Podcasts</h2>
                <div class="btn-group" style="margin-bottom:.5rem"><button class="btn btn-success" onclick="openModal('podcast')">â•</button></div>
                <div id="podcastsList"></div>
            </div>
        </section>

        <!-- UTILISATEURS -->
        <section id="users" class="admin-section">
            <div class="page-header"><h1>ğŸ” Utilisateurs</h1></div>
            <div class="content-box">
                <div class="btn-group" style="margin-bottom:.5rem"><button class="btn btn-success" onclick="openModal('user')">â•</button></div>
                <table class="data-table"><thead><tr><th>User</th><th>Nom</th><th>RÃ´le</th><th>Ã‰quipe</th><th>Actions</th></tr></thead><tbody id="usersList"></tbody></table>
            </div>
        </section>

        <!-- CORRECTION STATS HISTORIQUES (Super Admin) -->
        <section id="statsHistoriques" class="admin-section">
            <div class="page-header"><h1>ğŸ“Š Correction Stats Historiques</h1><p>Ajouter, modifier ou supprimer des stats de frappeurs et lanceurs (toutes saisons)</p></div>

            <div class="content-box">
                <h2 style="color:var(--gold)">ğŸ” Recherche</h2>
                <div class="form-row" style="align-items:flex-end">
                    <div class="form-group"><label>Type</label><select id="shType"><option value="frappeurs">âš¾ Frappeurs</option><option value="lanceurs">ğŸ¯ Lanceurs</option></select></div>
                    <div class="form-group"><label>Nom (partiel)</label><input id="shNom" placeholder="Ex: Bureau"></div>
                    <div class="form-group"><label>Saison</label><input id="shSaison" placeholder="Ex: 1985" style="width:100px"></div>
                    <button class="btn btn-primary" onclick="shSearch()">ğŸ” Chercher</button>
                </div>
                <div id="shResults" style="margin-top:1rem;overflow-x:auto"></div>
            </div>

            <div class="content-box" id="shFormBox" style="display:none">
                <h2 style="color:var(--gold)" id="shFormTitle">â• Ajouter</h2>
                <input type="hidden" id="shEditId">
                <div class="form-row">
                    <div class="form-group"><label>Nom (NOM, PrÃ©nom)</label><input id="shFNom" placeholder="Bureau, Michel"></div>
                    <div class="form-group"><label>Ã‰quipe</label><input id="shFEquipe" placeholder="FA" style="width:80px"></div>
                    <div class="form-group"><label>Saison</label><input id="shFSaison" type="number" placeholder="1985" style="width:100px"></div>
                </div>
                <!-- Frappeurs fields -->
                <div id="shFieldsFrappeurs">
                    <div class="form-row">
                        <div class="form-group"><label>Cote</label><input id="shFCote" type="number" style="width:70px"></div>
                        <div class="form-group"><label>PJ</label><input id="shFPj" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>AB</label><input id="shFAb" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>CS</label><input id="shFCs" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>1B</label><input id="shF1b" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>2B</label><input id="shF2b" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>3B</label><input id="shF3b" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>CC</label><input id="shFCc" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>PC</label><input id="shFPc" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>PP</label><input id="shFPp" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>SAC</label><input id="shFSac" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>BB</label><input id="shFBb" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>RB</label><input id="shFRb" type="number" value="0" style="width:70px"></div>
                    </div>
                    <p style="font-size:.85rem;opacity:.6;margin-top:.5rem">MOY = CS Ã· AB (calculÃ© auto)</p>
                </div>
                <!-- Lanceurs fields -->
                <div id="shFieldsLanceurs" style="display:none">
                    <div class="form-row">
                        <div class="form-group"><label>PL</label><input id="shFPl" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>ML</label><input id="shFMl" type="number" step="0.01" value="0" style="width:80px"></div>
                        <div class="form-group"><label>PC</label><input id="shFLPc" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>CS</label><input id="shFLCs" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>BB</label><input id="shFLBb" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>RB</label><input id="shFLRb" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>V</label><input id="shFV" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>D</label><input id="shFD" type="number" value="0" style="width:70px"></div>
                        <div class="form-group"><label>N</label><input id="shFN" type="number" value="0" style="width:70px"></div>
                    </div>
                    <p style="font-size:.85rem;opacity:.6;margin-top:.5rem">MOY = PC Ã· ML (calculÃ© auto)</p>
                </div>
                <div class="btn-group" style="margin-top:1rem">
                    <button class="btn btn-success" onclick="shSave()">ğŸ’¾ Enregistrer</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('shFormBox').style.display='none'">Annuler</button>
                </div>
                <div id="shStatus" style="margin-top:.5rem"></div>
            </div>

            <div class="content-box">
                <button class="btn btn-success" onclick="shShowAdd()">â• Ajouter une entrÃ©e</button>
            </div>
        </section>

        <!-- JOUEURS REPÃŠCHAGE (Supabase) -->
        <section id="joueursRepechage" class="admin-section">
            <div class="page-header">
                <h1>ğŸ‘¥ Joueurs RepÃªchage (Supabase)</h1>
                <p>GÃ©rer la liste des joueurs disponibles pour le repÃªchage</p>
            </div>

            <div class="content-box" style="background:linear-gradient(135deg,#1E3A5F 0%,#2D5A8A 100%);color:white">
                <h2 style="color:var(--gold);border-bottom-color:rgba(255,255,255,0.3)">ğŸ“… Saison</h2>
                <div class="form-row" style="align-items:flex-end">
                    <div class="form-group">
                        <label style="color:white">Saison</label>
                        <select id="jrSaison" onchange="loadJoueursRepechage()" style="color:var(--dark)">
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="color:white">Stats</label>
                        <div id="jrStats" style="font-family:'Oswald',sans-serif;font-size:1rem">â€”</div>
                    </div>
                </div>
            </div>

            <div class="content-box">
                <h2>â• Actions</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="openJrModal(-1)">â• Ajouter Joueur</button>
                    <button class="btn btn-warning" onclick="copierSaisonJr()">ğŸ“‹ Copier vers nouvelle saison</button>
                    <a href="repechage-live.html" target="_blank" class="btn btn-primary" style="text-decoration:none">ğŸ”´ RepÃªchage Live</a>
                </div>
            </div>

            <div class="content-box">
                <h2>ğŸ” Filtres</h2>
                <div class="form-row">
                    <div class="form-group"><label>Rechercher</label><input type="text" id="jrSearch" placeholder="Nom..." oninput="renderJrTable()"></div>
                    <div class="form-group"><label>Cote</label>
                        <select id="jrFilterCote" onchange="renderJrTable()"><option value="">Toutes</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
                    </div>
                    <div class="form-group"><label>Actif</label>
                        <select id="jrFilterActif" onchange="renderJrTable()"><option value="true">Actifs</option><option value="false">Inactifs</option><option value="">Tous</option></select>
                    </div>
                </div>
            </div>

            <div class="content-box">
                <h2>ğŸ‘¥ Joueurs (<span id="jrCount">0</span>)</h2>
                <div style="max-height:500px;overflow-y:auto">
                    <table class="data-table" id="jrTable">
                        <thead><tr>
                            <th>Nom</th><th>Cote</th><th>RÃ´le</th><th>TÃ©l</th><th>Courriel</th><th>Actif</th><th>Actions</th>
                        </tr></thead>
                        <tbody id="jrBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Modal Joueur RepÃªchage -->
        <div id="jrEditModal" class="modal">
            <div class="modal-content" style="max-width:600px">
                <div class="modal-header" style="background:var(--gold);color:var(--dark)"><h2>ğŸ‘¥ Joueur RepÃªchage</h2><button class="modal-close" onclick="closeModal('jrEdit')" style="color:var(--dark)">Ã—</button></div>
                <div class="modal-body">
                    <input type="hidden" id="jrEditId">
                    <div class="form-row">
                        <div class="form-group" style="flex:2"><label>Nom complet *</label><input type="text" id="jrEditNom" placeholder="Nom, PrÃ©nom"></div>
                        <div class="form-group"><label>Cote *</label>
                            <select id="jrEditCote"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>RÃ´le</label>
                            <select id="jrEditRole"><option value="joueur">Joueur</option><option value="lanceur_a">ğŸ¯ Lanceur A</option><option value="coach">ğŸ‘” Coach</option><option value="coachlanceur_a">ğŸ‘”ğŸ¯ Coach + Lanceur A</option><option value="admin">âš™ï¸ Admin</option><option value="coachadmin">ğŸ‘”âš™ï¸ Coach+Admin</option></select>
                        </div>
                        <div class="form-group"><label>Actif</label>
                            <select id="jrEditActif"><option value="true">âœ… Oui</option><option value="false">âŒ Non</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>TÃ©lÃ©phone 1</label><input type="tel" id="jrEditTel1" placeholder="514-XXX-XXXX"></div>
                        <div class="form-group"><label>TÃ©lÃ©phone 2</label><input type="tel" id="jrEditTel2" placeholder="514-XXX-XXXX"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Courriel</label><input type="email" id="jrEditCourriel" placeholder="email@exemple.com"></div>
                        <div class="form-group"><label>Naissance</label><input type="text" id="jrEditNaissance" placeholder="1 janv 1980"></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveJrEdit()">ğŸ’¾ Sauvegarder</button>
                        <button class="btn btn-secondary" onclick="closeModal('jrEdit')">Annuler</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ã‰QUIPES SAISON (Supabase) -->
        <section id="equipesSaison" class="admin-section">
            <div class="page-header">
                <h1>ğŸ† Ã‰quipes Saison (Supabase)</h1>
                <p>GÃ©rer les Ã©quipes aprÃ¨s le repÃªchage â€” Remplacements, blessures</p>
            </div>

            <div class="content-box" style="background:linear-gradient(135deg,#1E3A5F 0%,#2D5A8A 100%);color:white">
                <h2 style="color:var(--gold);border-bottom-color:rgba(255,255,255,0.3)">ğŸ“… Saison</h2>
                <div class="form-row" style="align-items:flex-end">
                    <div class="form-group">
                        <label style="color:white">Saison</label>
                        <select id="eqSaison" onchange="loadEquipesSaison()" style="color:var(--dark)"></select>
                    </div>
                    <div class="form-group">
                        <label style="color:white">RÃ©sumÃ©</label>
                        <div id="eqResume" style="font-family:'Oswald',sans-serif;font-size:.9rem">â€”</div>
                    </div>
                </div>
            </div>

            <div class="content-box" id="eqTeamsContainer" style="padding:0">
            </div>
        </section>

        <!-- Modal: Ajouter joueur Ã  une Ã©quipe -->
        <div id="eqAddModal" class="modal">
            <div class="modal-content" style="max-width:500px">
                <div class="modal-header" style="background:var(--success)"><h2>â• Ajouter Ã  <span id="eqAddTeamName"></span></h2><button class="modal-close" onclick="closeModal('eqAdd')">Ã—</button></div>
                <div class="modal-body">
                    <input type="hidden" id="eqAddTeam">
                    <div class="form-group"><label>Joueur</label>
                        <select id="eqAddJoueur" style="width:100%;padding:.6rem;border:2px solid var(--dark);font-size:.9rem"></select>
                    </div>
                    <div class="form-group"><label>Ou ajouter manuellement:</label>
                        <input type="text" id="eqAddNom" placeholder="Nom, PrÃ©nom">
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Cote</label>
                            <select id="eqAddCote"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select>
                        </div>
                        <div class="form-group"><label>Coach?</label>
                            <select id="eqAddCoach"><option value="false">Non</option><option value="true">ğŸ‘” Oui</option></select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="confirmEqAdd()">âœ… Ajouter</button>
                        <button class="btn btn-secondary" onclick="closeModal('eqAdd')">Annuler</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Remplacer joueur -->
        <div id="eqReplaceModal" class="modal">
            <div class="modal-content" style="max-width:500px">
                <div class="modal-header" style="background:var(--warning);color:var(--dark)"><h2>ğŸ”„ Remplacer <span id="eqReplacePlayerName"></span></h2><button class="modal-close" onclick="closeModal('eqReplace')" style="color:var(--dark)">Ã—</button></div>
                <div class="modal-body">
                    <input type="hidden" id="eqReplaceId">
                    <input type="hidden" id="eqReplaceTeam">
                    <p style="margin-bottom:1rem;background:#fff3cd;padding:.75rem;border-left:4px solid var(--warning);font-size:.85rem">Le joueur actuel sera retirÃ© et remplacÃ© par le nouveau.</p>
                    <div class="form-group"><label>Nouveau joueur (depuis la liste)</label>
                        <select id="eqReplaceJoueur" style="width:100%;padding:.6rem;border:2px solid var(--dark);font-size:.9rem"></select>
                    </div>
                    <div class="form-group"><label>Ou entrer manuellement:</label>
                        <input type="text" id="eqReplaceNom" placeholder="Nom, PrÃ©nom">
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Cote</label>
                            <select id="eqReplaceCote"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="confirmEqReplace()">ğŸ”„ Remplacer</button>
                        <button class="btn btn-secondary" onclick="closeModal('eqReplace')">Annuler</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATS LANCEURS (Supabase) -->
        <section id="statsLanceurs" class="admin-section">
            <div class="page-header">
                <h1>ğŸ¯ Stats Lanceurs (Supabase)</h1>
                <p>Modifier les statistiques des lanceurs directement dans la base de donnÃ©es</p>
            </div>

            <div class="content-box">
                <h2>ğŸ” Filtres</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Saison</label>
                        <select id="lanceurSaison" onchange="loadLanceurStats()">
                            <option value="">-- Choisir --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rechercher</label>
                        <input type="text" id="lanceurSearch" placeholder="Nom..." oninput="filterLanceurTable()">
                    </div>
                </div>
            </div>

            <div class="content-box">
                <h2>ğŸ“Š Lanceurs (<span id="lanceurCount">0</span>)</h2>
                <div id="lanceurMessage" style="display:none;padding:.5rem;background:#cce5ff;border-left:4px solid var(--primary);margin-bottom:.5rem;font-size:.8rem"></div>
                <div style="max-height:500px;overflow-y:auto">
                    <table class="data-table" id="lanceurTable">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Ã‰Q</th>
                                <th>Cote</th>
                                <th>A/B</th>
                                <th>PL</th>
                                <th>V</th>
                                <th>D</th>
                                <th>N</th>
                                <th>PC</th>
                                <th>CS</th>
                                <th>BB</th>
                                <th>K</th>
                                <th>MOY</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="lanceurBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Modal Lanceur Edit -->
        <div id="lanceurEditModal" class="modal">
            <div class="modal-content" style="max-width:600px">
                <div class="modal-header" style="background:var(--accent)"><h2>ğŸ¯ Modifier Lanceur</h2><button class="modal-close" onclick="closeModal('lanceurEdit')">Ã—</button></div>
                <div class="modal-body">
                    <input type="hidden" id="lanceurEditId">
                    <div class="form-row">
                        <div class="form-group"><label>Nom</label><input type="text" id="lanceurEditNom"></div>
                        <div class="form-group"><label>Saison</label><input type="text" id="lanceurEditSaison" readonly style="background:#ddd"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ã‰quipe</label>
                            <select id="lanceurEditEquipe">
                                <option value="">-</option>
                                <option value="AI">AI (Aigles)</option>
                                <option value="CO">CO (Condors)</option>
                                <option value="DU">DU (Ducs)</option>
                                <option value="FA">FA (Faucons)</option>
                                <option value="HA">HA (Harfangs)</option>
                                <option value="VA">VA (Vautours)</option>
                                <option value="GD">GD (Gds Ducs)</option>
                                <option value="Ã‰P">Ã‰P (Ã‰perviers)</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Cote</label>
                            <select id="lanceurEditCote">
                                <option value="">-</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Type A/B</label>
                            <select id="lanceurEditType">
                                <option value="">-</option>
                                <option value="A">A (Partant)</option>
                                <option value="B">B (Releveur)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>PL</label><input type="number" id="lanceurEditPL" min="0"></div>
                        <div class="form-group"><label>ML</label><input type="number" id="lanceurEditML" min="0" step="0.01"></div>
                        <div class="form-group"><label>V</label><input type="number" id="lanceurEditV" min="0"></div>
                        <div class="form-group"><label>D</label><input type="number" id="lanceurEditD" min="0"></div>
                        <div class="form-group"><label>N</label><input type="number" id="lanceurEditN" min="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>PC</label><input type="number" id="lanceurEditPC" min="0"></div>
                        <div class="form-group"><label>CS</label><input type="number" id="lanceurEditCS" min="0"></div>
                        <div class="form-group"><label>BB</label><input type="number" id="lanceurEditBB" min="0"></div>
                        <div class="form-group"><label>RB (K)</label><input type="number" id="lanceurEditRB" min="0"></div>
                        <div class="form-group"><label>MOY</label><input type="number" id="lanceurEditMOY" min="0" step="0.001"></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveLanceurEdit()">ğŸ’¾ Sauvegarder</button>
                        <button class="btn btn-secondary" onclick="closeModal('lanceurEdit')">Annuler</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTACTS / DIRECTION -->
        <section id="contacts" class="admin-section">
            <div class="page-header"><h1>ğŸ‘” Direction / Contacts</h1></div>
            
            <div class="btn-group" style="margin-bottom:1rem">
                <a href="contact.html" target="_blank" class="btn btn-primary" style="text-decoration:none">ğŸŒ Voir la page</a>
            </div>
            
            <div class="content-box">
                <h2>âš™ï¸ Configuration de la Page</h2>
                <div class="form-group">
                    <label>Titre de la page</label>
                    <input type="text" id="contactsPageTitre" value="Direction LBMA" placeholder="Ex: Direction LBMA">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="contactsPageDesc" rows="2" placeholder="Description affichÃ©e en haut de la page"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveContactsConfig()">ğŸ’¾ Sauvegarder Config</button>
                </div>
            </div>

            <div class="content-box">
                <h2>ğŸ‘¥ Membres de la Direction (<span id="contactsCount">0</span>)</h2>
                <div class="btn-group" style="margin-bottom:1rem">
                    <button class="btn btn-success" onclick="openContactModal(-1)">â• Ajouter un Contact</button>
                </div>
                <div id="contactsList"></div>
            </div>
        </section>
    </main>


    <div id="gameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ğŸ“… Modifier Partie</h2><button class="modal-close" onclick="closeModal('game')">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="gameId">
                <input type="hidden" id="gameType" value="regulier">
                <div class="form-row">
                    <div class="form-group"><label>Date</label><input type="date" id="gameDate"></div>
                    <div class="form-group"><label>Jour</label><select id="gameJour"><option value="SAMEDI">Samedi</option><option value="VENDREDI">Vendredi</option><option value="LUNDI">Lundi</option><option value="MARDI">Mardi</option><option value="DIMANCHE">Dimanche</option></select></div>
                    <div class="form-group"><label>Heure</label><select id="gameHeure"><option value="8H30">8H30</option><option value="9H00">9H00</option><option value="10H00">10H00</option><option value="10H45">10H45</option><option value="11H30">11H30</option><option value="18H30">18H30</option><option value="20H00">20H00</option><option value="21H30">21H30</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Visiteur</label><select id="gameVisiteur"><option value="AIGLES">Aigles</option><option value="CONDORS">Condors</option><option value="DUCS">Ducs</option><option value="FAUCONS">Faucons</option><option value="HARFANGS">Harfangs</option><option value="VAUTOURS">Vautours</option></select></div>
                    <div class="form-group"><label>Score V</label><input type="number" id="gameScoreV" min="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Local</label><select id="gameLocal"><option value="AIGLES">Aigles</option><option value="CONDORS">Condors</option><option value="DUCS">Ducs</option><option value="FAUCONS">Faucons</option><option value="HARFANGS">Harfangs</option><option value="VAUTOURS">Vautours</option></select></div>
                    <div class="form-group"><label>Score L</label><input type="number" id="gameScoreL" min="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Endroit</label><select id="gameEndroit"><option value="AUTEUIL">Auteuil</option><option value="JARRY 1">Jarry 1</option><option value="PARC DE LOUISBOURG">Louisbourg</option></select></div>
                    <div class="form-group"><label>Status</label><select id="gameStatus"><option value="avenir">Ã€ venir</option><option value="en_cours">En cours</option><option value="final">Final</option><option value="reporte">ReportÃ©</option><option value="annule">AnnulÃ©</option></select></div>
                </div>
                <div class="form-row" id="gameSerieFields" style="display:none">
                    <div class="form-group"><label>Ronde</label><select id="gameRonde"><option value="QUART-DE-FINALE">Quart-de-finale</option><option value="DEMI-FINALE">Demi-finale</option><option value="FINALE">Finale</option></select></div>
                    <div class="form-group"><label>SÃ©rie ID</label><input type="text" id="gameSerieId" placeholder="R1-A, R2-B, FINALE"></div>
                    <div class="form-group"><label>Seed Vis</label><input type="number" id="gameSeedV" min="1" max="6"></div>
                    <div class="form-group"><label>Seed Loc</label><input type="number" id="gameSeedL" min="1" max="6"></div>
                </div>
                <div class="form-group"><label>Notes</label><input type="text" id="gameNotes" placeholder="Notes optionnelles"></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveGameSB()">ğŸ’¾ Sauvegarder</button><button class="btn btn-secondary" onclick="closeModal('game')">Annuler</button></div>
            </div>
        </div>
    </div>

    <div id="batisseurModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ğŸ—ï¸ BÃ¢tisseur</h2><button class="modal-close" onclick="closeModal('batisseur')">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="batisseurId">
                <div class="form-group"><label>Nom</label><input type="text" id="batisseurNom"></div>
                <div class="form-group"><label>Description</label><input type="text" id="batisseurDesc"></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveBatisseur()">ğŸ’¾</button></div>
            </div>
        </div>
    </div>

    <div id="tropheeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background:var(--gold);color:var(--dark)"><h2>ğŸ† TrophÃ©e</h2><button class="modal-close" onclick="closeModal('trophee')" style="color:var(--dark)">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="tropheeId">
                <div class="form-group"><label>Nom (personne honorÃ©e)</label><input type="text" id="tropheeNom"></div>
                <div class="form-group"><label>TrophÃ©e (nom du prix)</label><input type="text" id="tropheePrix"></div>
                <div class="form-group"><label>IcÃ´ne</label><select id="tropheeIcon">
                    <option value="ğŸ…">ğŸ… MÃ©daille</option>
                    <option value="ğŸ›¡ï¸">ğŸ›¡ï¸ Bouclier</option>
                    <option value="ğŸ“‹">ğŸ“‹ Clipboard</option>
                    <option value="âš¾">âš¾ Baseball</option>
                    <option value="ğŸ¯">ğŸ¯ Cible</option>
                    <option value="ğŸŒŸ">ğŸŒŸ Ã‰toile</option>
                    <option value="â¤ï¸">â¤ï¸ Coeur</option>
                    <option value="ğŸŒ±">ğŸŒ± Pousse</option>
                    <option value="ğŸ¤">ğŸ¤ PoignÃ©e</option>
                    <option value="ğŸ†">ğŸ† TrophÃ©e</option>
                </select></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveTrophee()">ğŸ’¾</button></div>
            </div>
        </div>
    </div>

    <div id="membreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ğŸ‘‘ Membre Ã  Vie</h2><button class="modal-close" onclick="closeModal('membre')">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="membreId">
                <div class="form-group"><label>Nom</label><input type="text" id="membreNom"></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveMembre()">ğŸ’¾</button></div>
            </div>
        </div>
    </div>

    <div id="articleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ğŸ“° Article</h2><button class="modal-close" onclick="closeModal('article')">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="articleId">
                <div class="form-group"><label>Titre</label><input type="text" id="articleTitre"></div>
                <div class="form-group"><label>Date</label><input type="date" id="articleDate"></div>
                <div class="form-group"><label>Extrait</label><textarea id="articleExtrait" rows="2"></textarea></div>
                <div class="form-group"><label>Lien</label><input type="url" id="articleLien"></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveArticle()">ğŸ’¾</button></div>
            </div>
        </div>
    </div>

    <div id="podcastModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background:#8B5CF6"><h2>ğŸ™ï¸ Podcast</h2><button class="modal-close" onclick="closeModal('podcast')">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="podcastId">
                <div class="form-group"><label>Nom</label><input type="text" id="podcastTitre"></div>
                <div class="form-row"><div class="form-group"><label>Ã‰pisode</label><input type="text" id="podcastEpisode"></div><div class="form-group"><label>Date</label><input type="date" id="podcastDate"></div></div>
                <div class="form-group"><label>Description</label><textarea id="podcastDesc" rows="2"></textarea></div>
                <div class="form-row"><div class="form-group"><label>DurÃ©e</label><input type="text" id="podcastDuree"></div><div class="form-group"><label>Plateforme</label><input type="text" id="podcastPlateforme"></div></div>
                <div class="form-group"><label>Lien</label><input type="url" id="podcastLien"></div>
                <div class="btn-group"><button class="btn btn-success" onclick="savePodcast()">ğŸ’¾</button></div>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ğŸ” Utilisateur</h2><button class="modal-close" onclick="closeModal('user')">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="userId" value="">
                <div class="form-group"><label>Username</label><input type="text" id="userUsername"></div>
                <div class="form-group"><label>Mot de passe</label><input type="password" id="userPassword" placeholder="Laisser vide = pas de changement"></div>
                <div class="form-group"><label>Nom</label><input type="text" id="userNom"></div>
                <div class="form-group"><label>Ã‰quipe</label><input type="text" id="userEquipe" placeholder="Ex: AIGLES (optionnel)"></div>
                <div class="form-group"><label>RÃ´le</label><select id="userRole"><option value="coach">Coach (lecture seule)</option><option value="marqueur">Marqueur (saisie matchs)</option><option value="admin">Administrateur</option><option value="superadmin">Super Admin</option></select></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveUser()">ğŸ’¾</button></div>
            </div>
        </div>
    </div>

    <!-- Modal Contact -->
    <div id="contactModal" class="modal">
        <div class="modal-content" style="max-width:650px">
            <div class="modal-header" style="background:var(--gold);color:var(--dark)"><h2>ğŸ‘” Contact Direction</h2><button class="modal-close" onclick="closeModal('contact')" style="color:var(--dark)">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="contactIdx" value="-1">
                <div class="form-row">
                    <div class="form-group" style="flex:2">
                        <label>Nom complet *</label>
                        <input type="text" id="contactNom" placeholder="Ex: Michel Plante">
                    </div>
                    <div class="form-group">
                        <label>Ordre d'affichage</label>
                        <input type="number" id="contactOrdre" value="1" min="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Titre *</label>
                        <input type="text" id="contactTitre" placeholder="Ex: Directeur">
                    </div>
                    <div class="form-group">
                        <label>Sous-titre (optionnel)</label>
                        <input type="text" id="contactSousTitre" placeholder="Ex: PrÃ©sident">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>TÃ©lÃ©phone</label>
                        <input type="tel" id="contactTelephone" placeholder="Ex: 514-123-4567">
                    </div>
                    <div class="form-group">
                        <label>Courriel</label>
                        <input type="email" id="contactCourriel" placeholder="Ex: nom@email.com">
                    </div>
                </div>
                <div class="form-group">
                    <label>ResponsabilitÃ©s (une par ligne)</label>
                    <textarea id="contactResponsabilites" rows="5" placeholder="RÃ©servation des parcs&#10;Organisation des rÃ©unions&#10;Collecte des cotisations"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveContact()">ğŸ’¾ Sauvegarder</button>
                    <button class="btn btn-secondary" onclick="closeModal('contact')">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Joueur Liste (avec infos complÃ¨tes) -->
    <div id="joueurListModal" class="modal">
        <div class="modal-content" style="max-width:600px">
            <div class="modal-header" style="background:#28a745"><h2>ğŸƒ Joueur</h2><button class="modal-close" onclick="closeModal('joueurList')">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="joueurListIdx" value="-1">
                <div class="form-row">
                    <div class="form-group" style="flex:2"><label>Nom complet *</label><input type="text" id="joueurListNom" placeholder="NOM PRÃ‰NOM"></div>
                    <div class="form-group"><label>Cote *</label>
                        <select id="joueurListCote">
                            <option value="1">1 - DÃ©butant</option>
                            <option value="2">2 - IntermÃ©diaire</option>
                            <option value="3" selected>3 - RÃ©gulier</option>
                            <option value="4">4 - AvancÃ©</option>
                            <option value="5">5 - Ã‰lite</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>RÃ´le</label>
                        <select id="joueurListRole">
                            <option value="joueur">Joueur</option>
                            <option value="lanceur_a">ğŸ¯ Lanceur A</option>
                            <option value="coach">ğŸ‘” Coach</option>
                            <option value="coachlanceur_a">ğŸ‘”ğŸ¯ Coach + Lanceur A</option>
                            <option value="admin">âš™ï¸ Admin Ligue</option>
                            <option value="coachadmin">ğŸ‘”âš™ï¸ Coach + Admin</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Date de naissance</label><input type="text" id="joueurListNaissance" placeholder="1 janv 1980"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>TÃ©lÃ©phone 1</label><input type="tel" id="joueurListTel1" placeholder="514-123-4567"></div>
                    <div class="form-group"><label>TÃ©lÃ©phone 2</label><input type="tel" id="joueurListTel2" placeholder="514-123-4567"></div>
                </div>
                <div class="form-group"><label>Courriel</label><input type="email" id="joueurListCourriel" placeholder="email@exemple.com"></div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveJoueurList()">ğŸ’¾ Sauvegarder</button>
                    <button class="btn btn-secondary" onclick="closeModal('joueurList')">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Archives Joueurs -->
    <div id="archivesJoueursModal" class="modal">
        <div class="modal-content" style="max-width:800px">
            <div class="modal-header" style="background:var(--primary)"><h2>ğŸ“š Archives des Joueurs</h2><button class="modal-close" onclick="closeModal('archivesJoueurs')">Ã—</button></div>
            <div class="modal-body">
                <div id="archivesJoueursList"></div>
                <div class="btn-group" style="margin-top:1rem">
                    <button class="btn btn-warning" onclick="downloadAllArchivesJoueurs()">ğŸ’¾ TÃ©lÃ©charger Toutes</button>
                    <button class="btn btn-secondary" onclick="closeModal('archivesJoueurs')">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width:280px">
            <div class="modal-header danger"><h2>âš ï¸</h2><button class="modal-close" onclick="closeModal('confirm')">Ã—</button></div>
            <div class="modal-body" style="text-align:center">
                <p id="confirmMsg" style="margin-bottom:.75rem"></p>
                <div class="btn-group" style="justify-content:center"><button class="btn btn-danger" onclick="doConfirm()">OK</button><button class="btn btn-secondary" onclick="closeModal('confirm')">Annuler</button></div>
            </div>
        </div>
    </div>

    <script>
        const KEYS = {
            session: 'lbma_admin_session',
            users: 'lbma_admin_users',
            temple: 'lbma_temple_renommee',
            reglements: 'lbma_reglements',
            presse: 'lbma_revue_presse',
            calendrier: 'lbma_calendrier_2025',
            joueurs: 'lbma_joueurs_2026',
            archivesJoueurs: 'lbma_archives_joueurs',
            contacts: 'lbma_contacts'
        };
        
        let session, users, temple, reglements, presse, calendrier, joueursList, archivesJoueurs, contacts, confirmCb;

        const defUsers = []; // Users now loaded from Supabase admin_users table
        const defTemple = {batisseurs:[{id:1,nom:"Robert Auclair",description:"Fondateur"}]};
        const defReglements = {version:"2025",lastUpdate:"2025-01-01"};
        const defPresse = {articles:[],podcasts:[]};
        const defCalendrier = {saison:"2025",parties:[]};
        
        function checkSession(){const s=localStorage.getItem(KEYS.session);if(!s){window.location.href='login.html';return false}session=JSON.parse(s);if(session.expires<Date.now()){localStorage.removeItem(KEYS.session);window.location.href='login.html';return false}if(!session.remember&&!sessionStorage.getItem('lbma_session_alive')){localStorage.removeItem(KEYS.session);window.location.href='login.html';return false}if(!session.remember)sessionStorage.setItem('lbma_session_alive','1');document.getElementById('currentUser').textContent=(session.nom||session.user)+' ('+session.role+')';if(session.role==='superadmin'){document.body.classList.add('is-superadmin')}else if(session.role==='marqueur'){document.body.classList.add('is-marqueur')}else if(session.role==='coach'){document.body.classList.add('is-coach')}return true}
        function logout(){localStorage.removeItem(KEYS.session);window.location.href='login.html'}
        function load(key,def){const s=localStorage.getItem(key);if(s)try{return JSON.parse(s)}catch(e){}return JSON.parse(JSON.stringify(def))}
        function save(key,data){localStorage.setItem(key,JSON.stringify(data))}
        
        // === ANALYTICS DASHBOARD ===
        let analyticsData = [];
        let analyticsPeriod = '7';

        async function loadAnalytics(period) {
            analyticsPeriod = period;
            // Update button styles
            ['7','30','90','all'].forEach(p => {
                const btn = document.getElementById('analyticsBtn' + p);
                if (btn) {
                    btn.className = p === period ? 'btn btn-primary btn-small' : 'btn btn-secondary btn-small';
                }
            });
            
            try {
                let query = 'visites?select=*&order=timestamp.desc';
                if (period !== 'all') {
                    const d = new Date();
                    d.setDate(d.getDate() - parseInt(period));
                    query += '&timestamp=gte.' + d.toISOString();
                }
                const res = await sbFetch(query, { headers: { 'Range': '0-9999' } });
                analyticsData = res.ok ? await res.json() : [];
            } catch(e) {
                console.error('Analytics error:', e);
                analyticsData = [];
            }
            renderAnalytics();
        }

        function renderAnalytics() {
            const data = analyticsData;
            const total = data.length;
            
            // Today count
            const todayStr = new Date().toISOString().split('T')[0];
            const todayCount = data.filter(v => v.timestamp && v.timestamp.startsWith(todayStr)).length;
            
            // Days in period
            let numDays = parseInt(analyticsPeriod) || 1;
            if (analyticsPeriod === 'all' && data.length > 0) {
                const oldest = new Date(data[data.length - 1].timestamp);
                const newest = new Date(data[0].timestamp);
                numDays = Math.max(1, Math.ceil((newest - oldest) / 86400000));
            }
            const avg = numDays > 0 ? (total / numDays).toFixed(1) : '0';
            
            // Top page
            const pageCounts = {};
            data.forEach(v => {
                const p = v.page || 'inconnu';
                pageCounts[p] = (pageCounts[p] || 0) + 1;
            });
            const sortedPages = Object.entries(pageCounts).sort((a, b) => b[1] - a[1]);
            const topPage = sortedPages.length > 0 ? sortedPages[0][0].replace('.html', '') : 'â€”';
            
            // Update cards
            document.getElementById('anTotal').textContent = total;
            document.getElementById('anToday').textContent = todayCount;
            document.getElementById('anAvg').textContent = avg;
            document.getElementById('anTopPage').textContent = topPage;
            
            // Devices: mobile < 768, tablet 768-1024, desktop > 1024
            let dMobile = 0, dTablet = 0, dDesktop = 0;
            data.forEach(v => {
                const w = v.screen_width || 0;
                if (w > 0 && w < 768) dMobile++;
                else if (w >= 768 && w <= 1024) dTablet++;
                else if (w > 1024) dDesktop++;
            });
            const dTotal = dMobile + dTablet + dDesktop;
            const pctM = dTotal > 0 ? ((dMobile/dTotal)*100).toFixed(1) : '0';
            const pctT = dTotal > 0 ? ((dTablet/dTotal)*100).toFixed(1) : '0';
            const pctD = dTotal > 0 ? ((dDesktop/dTotal)*100).toFixed(1) : '0';
            
            document.getElementById('anDesktop').textContent = dDesktop + ' (' + pctD + '%)';
            document.getElementById('anTablet').textContent = dTablet + ' (' + pctT + '%)';
            document.getElementById('anMobile').textContent = dMobile + ' (' + pctM + '%)';
            
            // Device bar
            const barEl = document.getElementById('deviceBar');
            if (dTotal > 0) {
                barEl.innerHTML = 
                    (dDesktop > 0 ? '<div style="width:'+pctD+'%;background:#5BA4E6;display:flex;align-items:center;justify-content:center;color:white;font-size:.7rem;font-family:Oswald,sans-serif;min-width:' + (dDesktop > 0 ? '30px' : '0') + '">'+pctD+'%</div>' : '') +
                    (dTablet > 0 ? '<div style="width:'+pctT+'%;background:#FF9800;display:flex;align-items:center;justify-content:center;color:white;font-size:.7rem;font-family:Oswald,sans-serif;min-width:' + (dTablet > 0 ? '30px' : '0') + '">'+pctT+'%</div>' : '') +
                    (dMobile > 0 ? '<div style="width:'+pctM+'%;background:#4CAF50;display:flex;align-items:center;justify-content:center;color:white;font-size:.7rem;font-family:Oswald,sans-serif;min-width:' + (dMobile > 0 ? '30px' : '0') + '">'+pctM+'%</div>' : '');
            } else {
                barEl.innerHTML = '<div style="width:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#888;font-size:.75rem">Aucune donnÃ©e</div>';
            }
            document.getElementById('deviceLegend').innerHTML = 
                '<span>ğŸ–¥ï¸ Ordi <span style="color:#5BA4E6;font-weight:700">'+pctD+'%</span></span>' +
                '<span>ğŸ“± Tablette <span style="color:#FF9800;font-weight:700">'+pctT+'%</span></span>' +
                '<span>ğŸ“² Cell <span style="color:#4CAF50;font-weight:700">'+pctM+'%</span></span>';
            
            // Chart: visits per day
            const dayCounts = {};
            data.forEach(v => {
                if (!v.timestamp) return;
                const day = v.timestamp.split('T')[0];
                dayCounts[day] = (dayCounts[day] || 0) + 1;
            });
            const days = Object.keys(dayCounts).sort();
            const maxCount = Math.max(1, ...Object.values(dayCounts));
            
            const chartEl = document.getElementById('analyticsChart');
            if (days.length === 0) {
                chartEl.innerHTML = '<div style="text-align:center;width:100%;color:#888;padding:2rem">Aucune donnÃ©e de visites</div>';
            } else {
                chartEl.innerHTML = days.map(day => {
                    const count = dayCounts[day];
                    const h = Math.max(4, (count / maxCount) * 170);
                    const dayLabel = day.substring(5); // MM-DD
                    const isToday = day === todayStr;
                    return '<div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:18px;max-width:40px" title="' + day + ': ' + count + ' visites">' +
                        '<div style="font-size:.55rem;color:#666;margin-bottom:2px">' + count + '</div>' +
                        '<div style="width:100%;height:' + h + 'px;background:' + (isToday ? 'var(--gold)' : 'var(--primary)') + ';border-radius:2px 2px 0 0;min-width:8px"></div>' +
                        '<div style="font-size:.5rem;color:#888;margin-top:2px;transform:rotate(-45deg);white-space:nowrap">' + dayLabel + '</div>' +
                    '</div>';
                }).join('');
            }
            
            // Top pages table
            const topBody = document.getElementById('analyticsTopBody');
            if (sortedPages.length === 0) {
                topBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888">Aucune donnÃ©e</td></tr>';
            } else {
                const maxPageCount = sortedPages[0][1];
                topBody.innerHTML = sortedPages.slice(0, 15).map(([page, count]) => {
                    const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0';
                    const barW = Math.max(2, (count / maxPageCount) * 100);
                    const pageName = page.replace('.html', '');
                    return '<tr>' +
                        '<td style="font-weight:600">' + pageName + '</td>' +
                        '<td style="text-align:center">' + count + '</td>' +
                        '<td style="text-align:center">' + pct + '%</td>' +
                        '<td><div style="background:var(--primary);height:14px;width:' + barW + '%;border-radius:2px;min-width:4px"></div></td>' +
                    '</tr>';
                }).join('');
            }
            
            // Recent visits
            const recentBody = document.getElementById('analyticsRecentBody');
            const recent = data.slice(0, 30);
            if (recent.length === 0) {
                recentBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888">Aucune visite</td></tr>';
            } else {
                recentBody.innerHTML = recent.map(v => {
                    const dt = v.timestamp ? new Date(v.timestamp) : null;
                    const dtStr = dt ? dt.toLocaleDateString('fr-CA') + ' ' + dt.toLocaleTimeString('fr-CA', {hour:'2-digit', minute:'2-digit'}) : 'â€”';
                    const page = (v.page || 'â€”').replace('.html', '');
                    const ref = v.referrer ? new URL(v.referrer).hostname : 'direct';
                    const screen = v.screen_width ? v.screen_width + 'px' : 'â€”';
                    return '<tr><td style="font-size:.75rem">' + dtStr + '</td><td>' + page + '</td><td style="font-size:.7rem;color:#666">' + ref + '</td><td>' + screen + '</td></tr>';
                }).join('');
            }
        }

        async function purgeAnalytics() {
            if (!window.confirm('Supprimer les visites de plus de 90 jours?')) return;
            try {
                const d = new Date();
                d.setDate(d.getDate() - 90);
                const res = await sbFetch('visites?timestamp=lt.' + d.toISOString(), { method: 'DELETE' });
                if (res.ok) {
                    toast('Visites purgÃ©es!', 'success');
                    loadAnalytics(analyticsPeriod);
                } else {
                    toast('Erreur de purge', 'danger');
                }
            } catch(e) {
                toast('Erreur: ' + e.message, 'danger');
            }
        }

        function init(){
            if(!checkSession())return;
            users=[];
            loadUsersSB();
            calendrier=load(KEYS.calendrier,defCalendrier);
            archivesJoueurs=load(KEYS.archivesJoueurs,{saisons:[]});
            loadJoueursList();
            // Supabase loads
            loadContacts();
            loadTempleSB();
            loadReglementsSB();
            loadMediasSB();
            initLanceurSaisons();
            initJrSaisons();
            initEqSaisons();
            loadCalendrier();
            renderAll();
            // Analytics dashboard
            loadAnalytics('7');
        }
        
        // === CHARGEMENT JOUEURS DEPUIS SUPABASE ===
        async function loadJoueursList(){
            try {
                const saison = joueursList?.saison || '2026';
                const r = await sbFetch('joueurs_liste?saison=eq.' + saison + '&order=nom.asc', { headers: { 'Range': '0-9999' } });
                const rows = r.ok ? await r.json() : [];
                joueursList = { saison: saison, joueurs: rows };
                updateJoueursSaisonDisplay();
                renderJoueursList();
                updateStats();
            } catch(e) {
                console.error('Erreur chargement joueurs:', e);
                joueursList = {saison:'2026', joueurs:[]};
            }
        }
        

        
        function updateJoueursSaisonDisplay(){
            const saison = joueursList?.saison || '2026';
            document.getElementById('joueursSaison').textContent = saison;
            const sel = document.getElementById('joueursSaisonSelect');
            if(sel) sel.value = saison;
            const badge = document.getElementById('joueursSaisonBadge');
            if(badge) badge.style.display = (saison !== '2026') ? 'inline-block' : 'none';
        }

        function changeJoueursSaison(){
            const saison = document.getElementById('joueursSaisonSelect').value;
            joueursList = { saison: saison, joueurs: [] };
            loadJoueursList();
        }
        
        function renderAll(){renderGames();renderUsers();renderJoueursList()}

        function updateStats(){
            let totalJoueurs = (joueursList && joueursList.joueurs) ? joueursList.joueurs.length : 0;
            document.getElementById('statJoueurs').textContent=totalJoueurs;
            document.getElementById('statGames').textContent=calGames.length + calSeries.length;
            document.getElementById('statPlayed').textContent=calGames.filter(g=>g.status==='final').length + calSeries.filter(g=>g.status==='final').length;
        }
        
        function showSection(id,el){
            if(id==='users'&&session.role!=='superadmin')return toast('AccÃ¨s refusÃ©','danger');
            if(id==='statsHistoriques'&&session.role!=='superadmin')return toast('AccÃ¨s refusÃ©','danger');
            const adminSections=['joueursList','equipes','calendrier','temple','reglements','presse','contacts','joueursRepechage','equipesSaison','statsLanceurs'];
            if(adminSections.includes(id)&&(session.role==='marqueur'||session.role==='coach'))return toast('AccÃ¨s rÃ©servÃ© aux administrateurs','danger');
            document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el)el.classList.add('active');
        }
        function openModal(id){document.getElementById(id+'Modal').classList.add('active')}
        function closeModal(id){document.getElementById(id+'Modal').classList.remove('active')}
        function toast(msg,type){const t=document.createElement('div');t.className='toast toast-'+type;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2500)}
        function confirm(msg,cb){document.getElementById('confirmMsg').textContent=msg;confirmCb=cb;openModal('confirm')}
        function doConfirm(){if(confirmCb)confirmCb();closeModal('confirm');confirmCb=null}


        // === CALENDRIER ===
        // === CALENDRIER ===
        // === CALENDRIER (SUPABASE) ===
        let calGames = [];
        let calSeries = [];
        let calCurrentTab = 'regulier';

        function switchCalTab(tab) {
            calCurrentTab = tab;
            document.getElementById('calRegulier').style.display = tab === 'regulier' ? 'block' : 'none';
            document.getElementById('calSeries').style.display = tab === 'series' ? 'block' : 'none';
            document.getElementById('tabRegulier').style.background = tab === 'regulier' ? 'var(--primary)' : 'var(--cream)';
            document.getElementById('tabRegulier').style.color = tab === 'regulier' ? 'white' : 'var(--dark)';
            document.getElementById('tabSeries').style.background = tab === 'series' ? 'var(--primary)' : 'var(--cream)';
            document.getElementById('tabSeries').style.color = tab === 'series' ? 'white' : 'var(--dark)';
        }

        async function loadCalendrier() {
            const saison = document.getElementById('calSaison')?.value || 2026;
            try {
                const res = await sbFetch(`matchs_regulier?saison=eq.${saison}&order=date.asc,heure.asc`, { headers: { 'Range': '0-999' } });
                calGames = res.ok ? await res.json() : [];
            } catch(e) { calGames = []; }
            try {
                const res2 = await sbFetch(`matchs_series?saison=eq.${saison}&order=date.asc,heure.asc`, { headers: { 'Range': '0-999' } });
                calSeries = res2.ok ? await res2.json() : [];
            } catch(e) { calSeries = []; }
            renderGames();
            renderSeries();
            updateStats();
        }

        function renderGames() {
            const mois = document.getElementById('filterMois')?.value || '';
            let games = [...calGames];
            if (mois) games = games.filter(g => g.date.split('-')[1] === mois);
            document.getElementById('gameCount').textContent = games.length;
            const statusLabel = s => ({final:'FINAL',en_cours:'EN COURS',reporte:'REPORTÃ‰',annule:'ANNULÃ‰'}[s] || 'Ã€ VENIR');
            const statusClass = s => ({final:'final',en_cours:'en_cours',reporte:'reporte',annule:'annule'}[s] || 'avenir');
            document.getElementById('gamesList').innerHTML = games.map(g => `
                <div class="item-card">
                    <div style="flex:1">
                        <strong>#${g.no_match || 'â€”'}</strong> ${g.jour} ${g.date} <strong>${g.heure}</strong>
                        ${g.special ? '<span style="background:var(--gold);color:var(--dark);padding:0 .4rem;font-size:.7rem;font-weight:bold;margin-left:.3rem">' + g.special + '</span>' : ''}
                        <br><span class="team-color ${g.visiteur}">${g.visiteur}</span> ${g.score_visiteur !== null ? g.score_visiteur : ''} vs ${g.score_local !== null ? g.score_local : ''} <span class="team-color ${g.local}">${g.local}</span>
                        <span style="color:#888;font-size:.75rem">@ ${g.endroit}</span>
                        ${g.notes ? '<br><em style="font-size:.7rem;color:#999">' + g.notes + '</em>' : ''}
                    </div>
                    <div class="action-btns">
                        <span class="status-badge ${statusClass(g.status)}" style="font-size:.65rem;padding:.15rem .4rem">${statusLabel(g.status)}</span>
                        <button class="btn btn-primary btn-small" onclick="editGameSB(${g.id},'regulier')">âœï¸</button>
                        <button class="btn btn-danger btn-small" onclick="deleteGameSB(${g.id},'regulier')">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('') || '<p style="color:#888;padding:.5rem">Aucune partie pour cette saison</p>';
        }

        function onSerieRondeChange() {
            const ronde = document.getElementById('newSerieRonde').value;
            const serieSelect = document.getElementById('newSerieId');
            const hint = document.getElementById('serieFormatHint');
            if (ronde === 'QUART-DE-FINALE') {
                serieSelect.innerHTML = '<option value="R1-A">R1-A (#4 vs #5)</option><option value="R1-B">R1-B (#3 vs #6)</option>';
                hint.textContent = '2 de 3';
            } else if (ronde === 'DEMI-FINALE') {
                serieSelect.innerHTML = '<option value="R2-A">R2-A (#1 vs gagnant)</option><option value="R2-B">R2-B (#2 vs gagnant)</option>';
                hint.textContent = '2 de 3';
            } else {
                serieSelect.innerHTML = '<option value="FINALE">Finale</option>';
                hint.textContent = '3 de 5';
            }
        }

        function renderSeriesTracker() {
            // Calculer l'Ã©tat de chaque sÃ©rie
            const bySerieId = {};
            calSeries.forEach(g => {
                const sid = g.serie_id || 'AUTRE';
                if (!bySerieId[sid]) bySerieId[sid] = [];
                bySerieId[sid].push(g);
            });

            const rondeOrder = ['QUART-DE-FINALE', 'DEMI-FINALE', 'FINALE'];
            let html = '';

            rondeOrder.forEach(ronde => {
                const seriesInRonde = Object.entries(bySerieId).filter(([sid, games]) => games[0]?.ronde === ronde);
                if (seriesInRonde.length === 0) return;

                const format = ronde === 'FINALE' ? 3 : 2; // wins needed
                html += `<div style="grid-column:span 3;border-bottom:1px solid rgba(255,255,255,.2);padding-bottom:.5rem;margin-bottom:.5rem">
                    <strong style="color:var(--gold)">${ronde}</strong> <small>(${ronde === 'FINALE' ? '3 de 5' : '2 de 3'})</small>
                </div>`;

                seriesInRonde.forEach(([sid, games]) => {
                    const finals = games.filter(g => g.status === 'final' && g.score_visiteur !== null);
                    let winsA = 0, winsB = 0;
                    let teamA = '', teamB = '';
                    if (games.length > 0) {
                        // Le visiteur du match 1 = equipe mieux classÃ©e
                        const g1 = games.find(g => g.no_match === 1) || games[0];
                        teamA = g1.visiteur; teamB = g1.local;
                    }
                    finals.forEach(g => {
                        if (g.score_visiteur > g.score_local) {
                            if (g.visiteur === teamA) winsA++; else winsB++;
                        } else if (g.score_local > g.score_visiteur) {
                            if (g.local === teamA) winsA++; else winsB++;
                        }
                    });

                    const winner = winsA >= format ? teamA : (winsB >= format ? teamB : null);
                    const statusTxt = winner ? `âœ… ${winner} gagne` : `${winsA}-${winsB}`;

                    html += `<div style="background:rgba(255,255,255,.1);padding:.5rem .75rem;border-radius:4px;border-left:3px solid ${winner ? '#4CAF50' : 'var(--gold)'}">
                        <div style="font-family:'Oswald',sans-serif;font-size:.85rem">${sid}</div>
                        <div style="font-size:.9rem"><span class="team-color ${teamA}">${teamA || '?'}</span> vs <span class="team-color ${teamB}">${teamB || '?'}</span></div>
                        <div style="font-size:.8rem;margin-top:.25rem;color:${winner ? '#4CAF50' : 'var(--gold)'}">${statusTxt} | ${games.length} match(s)</div>
                    </div>`;
                });
            });

            if (!html) html = '<div style="grid-column:span 3;text-align:center;opacity:.6">Aucune sÃ©rie en cours. Ajoutez les matchs de la Ronde 1 ci-dessous.</div>';
            document.getElementById('seriesTracker').innerHTML = html;
        }

        function renderSeries() {
            document.getElementById('serieCount').textContent = calSeries.length;
            renderSeriesTracker();

            // Grouper par ronde puis serie_id
            const rondeOrder = ['QUART-DE-FINALE', 'DEMI-FINALE', 'FINALE'];
            const byRonde = {};
            calSeries.forEach(g => {
                const r = g.ronde || 'AUTRE';
                if (!byRonde[r]) byRonde[r] = [];
                byRonde[r].push(g);
            });

            let html = '';
            rondeOrder.forEach(ronde => {
                const games = byRonde[ronde];
                if (!games) return;
                html += `<div style="border:2px solid var(--gold);margin-bottom:1rem;overflow:hidden;border-radius:4px">
                    <div style="background:var(--primary);color:var(--gold);padding:.5rem .75rem;font-family:'Oswald',sans-serif">
                        ${ronde} ${ronde === 'FINALE' ? '(3 de 5)' : '(2 de 3)'}
                    </div>`;
                games.sort((a,b) => (a.serie_id||'').localeCompare(b.serie_id||'') || a.date.localeCompare(b.date) || (a.heure||'').localeCompare(b.heure||''));
                games.forEach(g => {
                    const seedV = g.seed_visiteur ? `#${g.seed_visiteur} ` : '';
                    const seedL = g.seed_local ? `#${g.seed_local} ` : '';
                    html += `<div class="item-card" style="border-left:3px solid ${g.status==='final'?'var(--primary)':'var(--gold)'}">
                        <div style="flex:1">
                            <span style="color:var(--gold);font-size:.7rem;font-family:'Oswald',sans-serif">${g.serie_id || ''}</span>
                            <strong> Match ${g.no_match || '?'}</strong> | ${g.jour} ${g.date} <strong>${g.heure}</strong>
                            <br>${seedV}<span class="team-color ${g.visiteur}">${g.visiteur}</span> ${g.score_visiteur !== null ? '<strong>'+g.score_visiteur+'</strong>' : ''} vs ${g.score_local !== null ? '<strong>'+g.score_local+'</strong>' : ''} ${seedL}<span class="team-color ${g.local}">${g.local}</span>
                            <span style="color:#888;font-size:.75rem">@ ${g.endroit}</span>
                            ${g.notes ? '<br><small style="color:#888">'+g.notes+'</small>' : ''}
                        </div>
                        <div class="action-btns">
                            <span class="status-badge ${g.status}" style="font-size:.65rem;padding:.15rem .4rem">${g.status === 'final' ? 'FINAL' : g.status === 'reporte' ? 'REPORTÃ‰' : 'Ã€ VENIR'}</span>
                            <button class="btn btn-primary btn-small" onclick="editGameSB(${g.id},'series')">âœï¸</button>
                            <button class="btn btn-danger btn-small" onclick="deleteGameSB(${g.id},'series')">ğŸ—‘ï¸</button>
                        </div>
                    </div>`;
                });
                html += '</div>';
            });

            document.getElementById('seriesList').innerHTML = html || '<p style="color:#888;padding:.5rem">Aucun match de sÃ©ries</p>';
        }

        async function addGameSB() {
            const date = document.getElementById('newDate').value;
            if (!date) return toast('Date requise!', 'danger');
            const visiteur = document.getElementById('newVisiteur').value;
            const local = document.getElementById('newLocal').value;
            if (visiteur === local) return toast('Ã‰quipes diffÃ©rentes!', 'danger');
            const saison = parseInt(document.getElementById('calSaison').value);
            const noMatch = document.getElementById('newNoMatch').value ? parseInt(document.getElementById('newNoMatch').value) : (calGames.length + 1);
            const body = {
                saison, no_match: noMatch, date, jour: document.getElementById('newJour').value,
                heure: document.getElementById('newHeure').value, visiteur, local,
                endroit: document.getElementById('newEndroit').value,
                special: document.getElementById('newSpecial').value, status: 'avenir'
            };
            const res = await sbFetch('matchs_regulier', { method: 'POST', body: JSON.stringify(body) });
            if (res.ok) { toast('Partie ajoutÃ©e!', 'success'); document.getElementById('newDate').value = ''; loadCalendrier(); }
            else toast('Erreur Supabase', 'danger');
        }

        async function addSerieSB() {
            const date = document.getElementById('newSerieDate').value;
            if (!date) return toast('Date requise!', 'danger');
            const visiteur = document.getElementById('newSerieVisiteur').value;
            const local = document.getElementById('newSerieLocal').value;
            if (visiteur === local) return toast('Ã‰quipes diffÃ©rentes!', 'danger');
            const saison = parseInt(document.getElementById('calSaison').value);
            const ronde = document.getElementById('newSerieRonde').value;
            const body = {
                saison, ronde,
                serie_id: document.getElementById('newSerieId').value,
                serie_format: ronde === 'FINALE' ? '3DE5' : '2DE3',
                no_match: parseInt(document.getElementById('newSerieNo').value),
                date, jour: document.getElementById('newSerieJour').value,
                heure: document.getElementById('newSerieHeure').value, visiteur, local,
                endroit: document.getElementById('newSerieEndroit').value, status: 'avenir',
                seed_visiteur: document.getElementById('newSerieSeedV').value ? parseInt(document.getElementById('newSerieSeedV').value) : null,
                seed_local: document.getElementById('newSerieSeedL').value ? parseInt(document.getElementById('newSerieSeedL').value) : null,
                notes: document.getElementById('newSerieNotes').value || ''
            };
            const res = await sbFetch('matchs_series', { method: 'POST', body: JSON.stringify(body) });
            if (res.ok) { toast('Match sÃ©ries ajoutÃ©!', 'success'); document.getElementById('newSerieDate').value = ''; document.getElementById('newSerieNotes').value = ''; loadCalendrier(); }
            else toast('Erreur Supabase', 'danger');
        }

        function editGameSB(id, type) {
            const list = type === 'regulier' ? calGames : calSeries;
            const g = list.find(x => x.id === id); if (!g) return;
            document.getElementById('gameId').value = id;
            document.getElementById('gameType').value = type;
            document.getElementById('gameDate').value = g.date;
            document.getElementById('gameJour').value = g.jour || 'SAMEDI';
            document.getElementById('gameHeure').value = g.heure;
            document.getElementById('gameVisiteur').value = g.visiteur;
            document.getElementById('gameLocal').value = g.local;
            document.getElementById('gameScoreV').value = g.score_visiteur !== null ? g.score_visiteur : '';
            document.getElementById('gameScoreL').value = g.score_local !== null ? g.score_local : '';
            document.getElementById('gameEndroit').value = g.endroit;
            document.getElementById('gameStatus').value = g.status;
            document.getElementById('gameNotes').value = g.notes || '';
            // Show/hide series fields
            document.getElementById('gameSerieFields').style.display = type === 'series' ? 'grid' : 'none';
            if (type === 'series') {
                if (g.ronde) document.getElementById('gameRonde').value = g.ronde;
                document.getElementById('gameSerieId').value = g.serie_id || '';
                document.getElementById('gameSeedV').value = g.seed_visiteur || '';
                document.getElementById('gameSeedL').value = g.seed_local || '';
            }
            openModal('game');
        }

        async function saveGameSB() {
            const id = parseInt(document.getElementById('gameId').value);
            const type = document.getElementById('gameType').value;
            const table = type === 'regulier' ? 'matchs_regulier' : 'matchs_series';
            const sv = document.getElementById('gameScoreV').value;
            const sl = document.getElementById('gameScoreL').value;
            const body = {
                date: document.getElementById('gameDate').value,
                jour: document.getElementById('gameJour').value,
                heure: document.getElementById('gameHeure').value,
                visiteur: document.getElementById('gameVisiteur').value,
                local: document.getElementById('gameLocal').value,
                score_visiteur: sv !== '' ? parseInt(sv) : null,
                score_local: sl !== '' ? parseInt(sl) : null,
                endroit: document.getElementById('gameEndroit').value,
                status: document.getElementById('gameStatus').value,
                notes: document.getElementById('gameNotes').value
            };
            if (type === 'series') {
                body.ronde = document.getElementById('gameRonde').value;
                body.serie_id = document.getElementById('gameSerieId').value;
                body.seed_visiteur = document.getElementById('gameSeedV').value ? parseInt(document.getElementById('gameSeedV').value) : null;
                body.seed_local = document.getElementById('gameSeedL').value ? parseInt(document.getElementById('gameSeedL').value) : null;
            }
            const res = await sbFetch(`${table}?id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(body) });
            if (res.ok) { toast('SauvegardÃ©!', 'success'); closeModal('game'); loadCalendrier(); }
            else toast('Erreur Supabase', 'danger');
        }

        async function deleteGameSB(id, type) {
            const table = type === 'regulier' ? 'matchs_regulier' : 'matchs_series';
            confirm('Supprimer cette partie?', async () => {
                const res = await sbFetch(`${table}?id=eq.${id}`, { method: 'DELETE' });
                if (res.ok) { toast('SupprimÃ©!', 'success'); loadCalendrier(); }
                else toast('Erreur', 'danger');
            });
        }

        // === TEMPLE (Supabase) ===
        let sbBatisseurs = [], sbTrophees = [], sbMembres = [];

        function openTempleModal(type){
            if(type==='batisseur'){document.getElementById('batisseurId').value='';document.getElementById('batisseurNom').value='';document.getElementById('batisseurDesc').value='';openModal('batisseur')}
            else if(type==='trophee'){document.getElementById('tropheeId').value='';document.getElementById('tropheeNom').value='';document.getElementById('tropheePrix').value='';document.getElementById('tropheeIcon').value='ğŸ†';openModal('trophee')}
            else if(type==='membre'){document.getElementById('membreId').value='';document.getElementById('membreNom').value='';openModal('membre')}
        }

        async function loadTempleSB(){
            try {
                const [r1,r2,r3] = await Promise.all([
                    sbFetch('temple_batisseurs?order=ordre.asc,nom.asc', { headers: { 'Range': '0-999' } }),
                    sbFetch('temple_trophees?order=ordre.asc,nom.asc', { headers: { 'Range': '0-999' } }),
                    sbFetch('temple_membres?order=ordre.asc,nom.asc', { headers: { 'Range': '0-999' } })
                ]);
                sbBatisseurs = r1.ok ? await r1.json() : [];
                sbTrophees = r2.ok ? await r2.json() : [];
                sbMembres = r3.ok ? await r3.json() : [];
            } catch(e) { console.error('Temple load error:', e); }
            renderTemple();
            try {
                const rv = await sbFetch('page_config?page=eq.temple&select=data', { headers: { 'Range': '0-999' } });
                const arr = rv.ok ? await rv.json() : [];
                if(arr.length > 0 && arr[0].data) {
                    document.getElementById('visiteDesc').value = arr[0].data.description || '';
                    document.getElementById('visiteNote').value = arr[0].data.note || '';
                }
            } catch(e){}
        }

        function renderTemple(){renderBatisseurs();renderTrophees();renderMembres()}
        function renderBatisseurs(){document.getElementById('batisseursList').innerHTML=sbBatisseurs.map(b=>`<div class="item-card"><h4>â­ ${b.nom}</h4><p>${b.description||''}</p><div class="action-btns"><button class="btn btn-primary btn-small" onclick="editBatisseur(${b.id})">âœï¸</button><button class="btn btn-danger btn-small" onclick="deleteBatisseur(${b.id})">ğŸ—‘ï¸</button></div></div>`).join('')||'<p>Aucun b\u00e2tisseur</p>'}
        function editBatisseur(id){const b=sbBatisseurs.find(x=>x.id===id);if(!b)return;document.getElementById('batisseurId').value=id;document.getElementById('batisseurNom').value=b.nom;document.getElementById('batisseurDesc').value=b.description||'';openModal('batisseur')}
        async function saveBatisseur(){const id=document.getElementById('batisseurId').value;const nom=document.getElementById('batisseurNom').value.trim();if(!nom)return toast('Nom requis','danger');const d={nom,description:document.getElementById('batisseurDesc').value.trim()};if(id){await sbFetch('temple_batisseurs?id=eq.'+id,{method:'PATCH',body:JSON.stringify(d)})}else{await sbFetch('temple_batisseurs',{method:'POST',body:JSON.stringify(d)})}closeModal('batisseur');toast('OK','success');loadTempleSB()}
        async function deleteBatisseur(id){confirm('Supprimer ce b\u00e2tisseur?',async()=>{await sbFetch('temple_batisseurs?id=eq.'+id,{method:'DELETE'});toast('Supprim\u00e9','success');loadTempleSB()})}

        function renderTrophees(){document.getElementById('tropheesList').innerHTML=sbTrophees.map(t=>`<div class="item-card"><h4>${t.icon||'ğŸ†'} ${t.nom}</h4><p>${t.trophee||''}</p><div class="action-btns"><button class="btn btn-primary btn-small" onclick="editTrophee(${t.id})">âœï¸</button><button class="btn btn-danger btn-small" onclick="deleteTrophee(${t.id})">ğŸ—‘ï¸</button></div></div>`).join('')||'<p>Aucun troph\u00e9e</p>'}
        function editTrophee(id){const t=sbTrophees.find(x=>x.id===id);if(!t)return;document.getElementById('tropheeId').value=id;document.getElementById('tropheeNom').value=t.nom;document.getElementById('tropheePrix').value=t.trophee||'';document.getElementById('tropheeIcon').value=t.icon||'ğŸ†';openModal('trophee')}
        async function saveTrophee(){const id=document.getElementById('tropheeId').value;const nom=document.getElementById('tropheeNom').value.trim();if(!nom)return toast('Nom requis','danger');const d={nom,trophee:document.getElementById('tropheePrix').value.trim(),icon:document.getElementById('tropheeIcon').value};if(id){await sbFetch('temple_trophees?id=eq.'+id,{method:'PATCH',body:JSON.stringify(d)})}else{await sbFetch('temple_trophees',{method:'POST',body:JSON.stringify(d)})}closeModal('trophee');toast('OK','success');loadTempleSB()}
        async function deleteTrophee(id){confirm('Supprimer ce troph\u00e9e?',async()=>{await sbFetch('temple_trophees?id=eq.'+id,{method:'DELETE'});toast('Supprim\u00e9','success');loadTempleSB()})}

        function renderMembres(){document.getElementById('membresList').innerHTML=sbMembres.map(m=>`<div class="item-card"><h4>ğŸ‘‘ ${m.nom}</h4><div class="action-btns"><button class="btn btn-primary btn-small" onclick="editMembre(${m.id})">âœï¸</button><button class="btn btn-danger btn-small" onclick="deleteMembre(${m.id})">ğŸ—‘ï¸</button></div></div>`).join('')||'<p>Aucun membre</p>'}
        function editMembre(id){const m=sbMembres.find(x=>x.id===id);if(!m)return;document.getElementById('membreId').value=id;document.getElementById('membreNom').value=m.nom;openModal('membre')}
        async function saveMembre(){const id=document.getElementById('membreId').value;const nom=document.getElementById('membreNom').value.trim();if(!nom)return toast('Nom requis','danger');if(id){await sbFetch('temple_membres?id=eq.'+id,{method:'PATCH',body:JSON.stringify({nom})})}else{await sbFetch('temple_membres',{method:'POST',body:JSON.stringify({nom})})}closeModal('membre');toast('OK','success');loadTempleSB()}
        async function deleteMembre(id){confirm('Supprimer ce membre?',async()=>{await sbFetch('temple_membres?id=eq.'+id,{method:'DELETE'});toast('Supprim\u00e9','success');loadTempleSB()})}

        async function saveVisite(){
            const data = {description: document.getElementById('visiteDesc').value, note: document.getElementById('visiteNote').value};
            const check = await sbFetch("page_config?page=eq.temple&select=id");
            const arr = check.ok ? await check.json() : [];
            if(arr.length > 0){
                await sbFetch('page_config?page=eq.temple', {method:'PATCH', body:JSON.stringify({data})});
            } else {
                await sbFetch('page_config', {method:'POST', body:JSON.stringify({page:'temple', titre:'Temple', data})});
            }
            toast('Visite sauvegard\u00e9e','success');
        }

        // === RÃˆGLEMENTS (Supabase) â€” Interface complÃ¨te ===
        let regData = null; // { version, lastUpdate, statut, sections: [] }
        let regDeleteIndex = null;

        const defaultRegData = {
            version: "2026", lastUpdate: "", statut: "publique",
            sections: [
                { id:"repechage", titre:"REPÃŠCHAGE ANNUEL", visible:1, regles:["Le droit de parole pour choisir son rang lors du repÃªchage est dÃ©terminÃ© par le classement final de la saison prÃ©cÃ©dente. L'Ã©quipe au dernier rang (6e) choisit son rang en premier, suivie par la 5e, 4e, 3e, 2e et 1re.","Tous les participants peuvent poser des questions Ã  n'importe quel membre de l'ExÃ©cutif avant le dÃ©but du repÃªchage.","La sÃ©ance de repÃªchage dÃ©bute uniquement lorsque toutes les Ã©quipes se dÃ©clarent prÃªtes.","Une pÃ©riode de cinq (5) minutes maximum est allouÃ©e Ã  chaque Ã©quipe pour effectuer chacun de ses choix.","Une pÃ©riode additionnelle de cinq (5) minutes sera allouÃ©e sur demande pour un moment de rÃ©flexion.","Une fois le repÃªchage complÃ©tÃ©, une diffÃ©rence de +/- 1 sera autorisÃ©e dans le total des cotes des Ã©quipes.","Les lanceurs Â« A Â» dÃ©signÃ©s ne peuvent Ãªtre repÃªchÃ©s par la mÃªme Ã©quipe. Lanceurs A: StÃ©phane Beaudoin, Steve Beaudry, Joe Santo, Serge ChaussÃ©, Michel LariviÃ¨re et GÃ©rard Van Houtte.","Tout Ã©change de choix/tour/sÃ©lection et nÃ©gociations avant ou durant le repÃªchage est strictement dÃ©fendu.","Ã‰change aprÃ¨s repÃªchage: possible avant la 1re partie si nombre Ã©gal de joueurs, cotes respectÃ©es, ratifiÃ© par l'ExÃ©cutif. Un lanceur A ne peut Ãªtre Ã©changÃ© que pour un autre lanceur A."], notes:["PAUSE SANTÃ‰ de 10 minutes aprÃ¨s le 4e tour."] },
                { id:"horaire", titre:"HORAIRE DES PARTIES", visible:1, regles:["Toutes les parties sont d'une durÃ©e de sept (7) manches. Une partie est considÃ©rÃ©e Â« officielle Â» aprÃ¨s 3 manches complÃ¨tes.","Lorsqu'une manche est commencÃ©e, elle doit Ãªtre terminÃ©e au complet.","VENDREDI: 1re partie 18h30 (limite 19h50), 2e partie 20h05 (limite 21h25), 3e partie 21h40 (limite 23h00).","SAMEDI: 1re partie 8h15 (limite 9h35), 2e partie 9h50 (limite 11h10), 3e partie 11h25 (limite 12h45).","Un dÃ©lai de 10 minutes est observÃ© avant la remise d'une partie.","Une Ã©quipe comptant moins de 8 joueurs aprÃ¨s le dÃ©lai perd par dÃ©faut (7-0).","Toute partie non jouÃ©e est remise Ã  la prochaine date disponible.","Pluie vendredi: annulation communiquÃ©e entre 16h et 18h. Samedi: dÃ©cisions sur le terrain."], notes:[] },
                { id:"uniforme", titre:"UNIFORME ET Ã‰QUIPEMENT", visible:1, regles:["Le port de l'uniforme complet est obligatoire: chandail d'Ã©quipe et casquette noire (fournis par la LBMA), pantalon noir (de balle, pas survÃªtement) et bas blancs.","Les receveurs doivent obligatoirement porter le plastron et le masque avec protÃ¨ge-cou.","Les bÃ¢tons personnels sont interdits. Seuls les bÃ¢tons de la Ligue peuvent Ãªtre utilisÃ©s."], notes:[] },
                { id:"echanges", titre:"Ã‰CHANGES", visible:1, regles:["Les Ã©changes sont possibles aprÃ¨s la 1re partie jusqu'avant la 10e partie de la saison rÃ©guliÃ¨re.","Tout joueur Ã©changÃ© doit Ãªtre d'accord ou l'avoir demandÃ©.","Le nombre de joueurs Ã©changÃ©s doit Ãªtre Ã©gal.","Les cotes des joueurs Ã©changÃ©s doivent respecter le total accumulÃ© lors du repÃªchage.","Tout Ã©change doit Ãªtre ratifiÃ© par l'ExÃ©cutif de la Ligue.","Un lanceur Â« A Â» ne peut Ãªtre Ã©changÃ© que pour un autre lanceur du mÃªme niveau."], notes:[] },
                { id:"arbitres", titre:"RÃˆGLEMENTS ET ARBITRES", visible:1, regles:["Les rÃ¨glements de jeu sont les rÃ¨glements rÃ©guliers de la balle molle.","Toute dÃ©cision impliquant le jugement d'un arbitre est irrÃ©vocable et sans appel.","L'esprit sportif et amical doit Ãªtre respectÃ©. Les joueurs dÃ©rogeant Ã  ces principes seront sÃ©vÃ¨rement rÃ©primandÃ©s, pouvant aller jusqu'Ã  une suspension Ã  vie.","Seuls l'instructeur ou l'assistant dÃ©signÃ© peuvent s'adresser Ã  l'arbitre.","Aucun protÃªt ne peut Ãªtre placÃ© dans la LBMA.","Un joueur expulsÃ© subit une suspension minimale d'une partie. Le remplaÃ§ant doit Ãªtre de cote infÃ©rieure. Seconde offense: cas confiÃ© Ã  l'ExÃ©cutif.","Un joueur suspendu dans une autre ligue ne peut jouer dans la LBMA pendant sa suspension.","Les membres de l'ExÃ©cutif peuvent dÃ©cerner une faute Ã  un joueur de leur propre Ã©quipe.","Le Â« slap bunt Â» est interdit."], notes:[] },
                { id:"pointage", titre:"SYSTÃˆME DE POINTAGE", visible:1, regles:["Manches 1, 2, 3 et 4: maximum de 5 points par manche.","Manches 5, 6 et 7: manches Â« ouvertes Â» (pas de limite).","Une Ã©quipe avec 7 points d'avance ne peut plus Â« bunter Â» ou voler des buts, sinon le joueur est retirÃ© automatiquement."], notes:[] },
                { id:"remplacement", titre:"REMPLACEMENT, BENCHAGE ET BLESSURES", visible:1, regles:["Une Ã©quipe peut utiliser un rÃ©serviste de n'importe quelle Ã©quipe (sauf l'adverse) si elle a moins de 9 joueurs.","Les 2 premiers remplaÃ§ants peuvent Ãªtre de cote Ã©gale aux absents. Les suivants doivent Ãªtre de cote infÃ©rieure (sauf cotes 1 et 2).","Un joueur ne peut Ãªtre rÃ©serviste plus de 4 parties par Ã©quipe (max 2 en sÃ©ries), sauf les cotes 1 et 2 qui n'ont pas de limite.","Un joueur absent 2 parties consÃ©cutives (blessure/maladie) peut Ãªtre placÃ© sur la liste des blessÃ©s (min. 3 parties).","Un joueur blessÃ© pendant la partie peut Ãªtre remplacÃ© mais ne peut revenir au jeu.","Le joueur arrivÃ© en retard ne peut jouer qu'au dÃ©but de la manche complÃ¨te suivante.","Un joueur Â« pas en Ã©tat de jouer Â» sera expulsÃ© et suspendu pour la partie suivante. Seconde offense: expulsion de la Ligue.","Option Â« benchage Â»: un joueur en dÃ©fensive jumelÃ© Ã  un joueur en offensive = 1/2 partie chacun.","ContrÃ´le des rotations par l'ExÃ©cutif. DiffÃ©rence maximale d'un (1) benchage entre joueurs. Non-respect = dÃ©faite automatique."], notes:[] },
                { id:"lanceurs", titre:"LANCEURS", visible:1, regles:["Un nouveau lanceur (1re annÃ©e) ne peut lancer plus de 21 manches en saison rÃ©guliÃ¨re et 7 manches en sÃ©ries (total 28 manches).","Les lanceurs Â« A Â» peuvent remplacer dans d'autres Ã©quipes, mais pas en tant que lanceurs."], notes:[] },
                { id:"classement", titre:"CLASSEMENT FINAL", visible:1, regles:["En cas d'Ã©galitÃ©, le vainqueur est dÃ©terminÃ© par: 1) Le plus de victoires contre toutes les Ã©quipes, 2) Le plus de victoires entre les Ã©quipes Ã  Ã©galitÃ©, 3) La meilleure diffÃ©rence points pour/contre entre ces Ã©quipes, 4) La meilleure diffÃ©rence points pour/contre globale, 5) Une partie de 7 manches Ã  finir."], notes:[] },
                { id:"series", titre:"SÃ‰RIES Ã‰LIMINATOIRES", visible:1, regles:["Toute partie doit Ãªtre complÃ©tÃ©e (7 manches) jusqu'Ã  dÃ©claration d'un gagnant.","Remise avant 3Â½ manches: partie Ã  reprendre. AprÃ¨s 3Â½ manches: Ã  continuer au point d'interruption.","QUART DE FINALE: 1re et 2e passent directement en demi-finale. 3e vs 6e et 4e vs 5e en sÃ©rie 2 de 3. Les Ã©quipes 3e et 4e reÃ§oivent pour les parties 1 et 3.","DEMI-FINALE: 1re et 2e affrontent les gagnants des quarts en sÃ©rie 2 de 3. La 1re affronte l'Ã©quipe la plus basse. Les Ã©quipes 1re et 2e reÃ§oivent pour les parties 1 et 3.","FINALE: SÃ©rie 2 de 3. L'Ã©quipe mieux classÃ©e reÃ§oit pour les parties 1 et 3."], notes:[] },
                { id:"trophees", titre:"Ã‰LIGIBILITÃ‰ AUX TROPHÃ‰ES", visible:1, regles:["Minimum de 16 parties (2/3 de la saison) pour Ãªtre Ã©ligible aux honneurs.","Minimum de 40% des manches lancÃ©es pour le titre de Â« meilleur lanceur Â».","Maximum de 8 parties ou 28 manches la saison prÃ©cÃ©dente pour Â« meilleure recrue Â»."], notes:[] }
            ]
        };

        async function loadReglementsSB(){
            try {
                const r = await sbFetch("page_config?page=eq.reglements&select=*");
                const arr = r.ok ? await r.json() : [];
                if(arr.length > 0 && arr[0].data && arr[0].data.sections && arr[0].data.sections.length > 0){
                    regData = arr[0].data;
                } else {
                    regData = JSON.parse(JSON.stringify(defaultRegData));
                }
            } catch(e){
                regData = JSON.parse(JSON.stringify(defaultRegData));
            }
            // Remplir les champs de statut
            document.getElementById('regVersion').value = regData.version || '';
            document.getElementById('regDate').value = regData.lastUpdate || '';
            document.getElementById('regStatut').value = regData.statut || 'publique';
            regUpdateStatutPreview();
            regRenderSections();
        }

        function regUpdateStatutPreview(){
            const sel = document.getElementById('regStatut').value;
            const el = document.getElementById('regStatutPreview');
            const msgs = {
                publique: { text:'âœ… La page des rÃ¨glements est visible par tous les visiteurs.', color:'#2e7d32', bg:'#f0fff0' },
                construction: { text:'ğŸš§ Les visiteurs verront un message "En construction" Ã  la place du contenu.', color:'#b26a00', bg:'#fffbf0' },
                masquee: { text:'ğŸ”’ La page est masquÃ©e â€” les visiteurs sont redirigÃ©s vers l\'accueil.', color:'#c62828', bg:'#fff5f5' }
            };
            const m = msgs[sel];
            el.style.display = 'block';
            el.style.background = m.bg;
            el.style.borderLeftColor = m.color;
            el.style.color = m.color;
            el.textContent = m.text;
        }
        document.getElementById('regStatut').addEventListener('change', regUpdateStatutPreview);

        function regRenderSections(){
            const container = document.getElementById('regSectionsList');
            if(!regData || !regData.sections || regData.sections.length === 0){
                container.innerHTML = '<div style="color:#999;font-size:.85rem;padding:1rem;text-align:center">Aucune section. Cliquez â• pour en ajouter une.</div>';
                return;
            }
            container.innerHTML = regData.sections.map((s, i) => `
                <div style="background:${s.visible==0?'#f9f9f9':'var(--white)'};border:2px solid ${s.visible==0?'#ccc':'var(--dark)'};padding:.6rem 1rem;display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">
                    <span style="font-family:'Oswald',sans-serif;font-size:.75rem;background:var(--primary);color:white;padding:.2rem .5rem;min-width:24px;text-align:center">${i+1}</span>
                    <span style="flex:1;font-family:'Oswald',sans-serif;font-size:.95rem;${s.visible==0?'color:#aaa;text-decoration:line-through':''}">
                        ${s.titre}
                        <span style="color:#999;font-size:.75rem;font-weight:normal;margin-left:.4rem">${s.regles ? s.regles.length : 0} rÃ¨gle${s.regles && s.regles.length>1?'s':''}</span>
                    </span>
                    <span style="font-size:.75rem;padding:.2rem .5rem;background:${s.visible==0?'#eee':'#e8f5e9'};color:${s.visible==0?'#999':'#2e7d32'};border:1px solid ${s.visible==0?'#ccc':'#a5d6a7'}">
                        ${s.visible==0?'ğŸ™ˆ MasquÃ©e':'âœ… Visible'}
                    </span>
                    <div style="display:flex;gap:.3rem">
                        ${i > 0 ? `<button class="btn btn-secondary" style="padding:.25rem .5rem;font-size:.8rem" onclick="regMoveSection(${i},-1)" title="Monter">â†‘</button>` : '<span style="width:2rem"></span>'}
                        ${i < regData.sections.length-1 ? `<button class="btn btn-secondary" style="padding:.25rem .5rem;font-size:.8rem" onclick="regMoveSection(${i},1)" title="Descendre">â†“</button>` : '<span style="width:2rem"></span>'}
                        <button class="btn btn-primary" style="padding:.25rem .6rem;font-size:.8rem" onclick="regOpenEditSection(${i})">âœï¸</button>
                        <button class="btn btn-danger" style="padding:.25rem .6rem;font-size:.8rem" onclick="regAskDelete(${i})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function regOpenAddSection(){
            document.getElementById('regEditIndex').value = '';
            document.getElementById('regModalTitle').textContent = 'â• Nouvelle section';
            document.getElementById('regSectionTitre').value = '';
            document.getElementById('regSectionId').value = '';
            document.getElementById('regSectionVisible').value = '1';
            document.getElementById('regSectionRegles').value = '';
            document.getElementById('regSectionNotes').value = '';
            document.getElementById('regModal').classList.add('active');
        }

        function regOpenEditSection(i){
            const s = regData.sections[i];
            document.getElementById('regEditIndex').value = i;
            document.getElementById('regModalTitle').textContent = 'âœï¸ Modifier : ' + s.titre;
            document.getElementById('regSectionTitre').value = s.titre || '';
            document.getElementById('regSectionId').value = s.id || '';
            document.getElementById('regSectionVisible').value = s.visible==0 ? '0' : '1';
            document.getElementById('regSectionRegles').value = (s.regles || []).join('\n');
            document.getElementById('regSectionNotes').value = (s.notes || []).join('\n');
            document.getElementById('regModal').classList.add('active');
        }

        function regCloseModal(){
            document.getElementById('regModal').classList.remove('active');
        }

        function regSaveSection(){
            const titre = document.getElementById('regSectionTitre').value.trim();
            let id = document.getElementById('regSectionId').value.trim().replace(/\s+/g,'_').toLowerCase();
            const visible = parseInt(document.getElementById('regSectionVisible').value);
            const reglesRaw = document.getElementById('regSectionRegles').value;
            const notesRaw = document.getElementById('regSectionNotes').value;
            if(!titre){ toast('Le titre est obligatoire','danger'); return; }
            if(!id) id = titre.toLowerCase().replace(/[^a-z0-9]/g,'_').replace(/_+/g,'_');
            const regles = reglesRaw.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
            const notes = notesRaw.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
            const section = { id, titre, visible, regles, notes };
            const idx = document.getElementById('regEditIndex').value;
            if(idx === ''){
                regData.sections.push(section);
            } else {
                regData.sections[parseInt(idx)] = section;
            }
            regCloseModal();
            regRenderSections();
            toast('Section sauvegardÃ©e â€” pensez Ã  sauvegarder en base!', 'success');
        }

        function regMoveSection(i, dir){
            const arr = regData.sections;
            const j = i + dir;
            if(j < 0 || j >= arr.length) return;
            [arr[i], arr[j]] = [arr[j], arr[i]];
            regRenderSections();
        }

        function regAskDelete(i){
            regDeleteIndex = i;
            document.getElementById('regDeleteName').textContent = regData.sections[i].titre;
            document.getElementById('regDeleteModal').classList.add('active');
        }

        function regConfirmDelete(){
            if(regDeleteIndex === null) return;
            regData.sections.splice(regDeleteIndex, 1);
            regDeleteIndex = null;
            document.getElementById('regDeleteModal').classList.remove('active');
            regRenderSections();
            toast('Section supprimÃ©e â€” pensez Ã  sauvegarder en base!', 'success');
        }

        async function saveReglements(){
            if(!regData) return;
            regData.version = document.getElementById('regVersion').value.trim();
            regData.lastUpdate = document.getElementById('regDate').value;
            regData.statut = document.getElementById('regStatut').value;
            const check = await sbFetch("page_config?page=eq.reglements&select=id");
            const arr = check.ok ? await check.json() : [];
            if(arr.length > 0){
                await sbFetch('page_config?page=eq.reglements', {method:'PATCH', body:JSON.stringify({data: regData})});
            } else {
                await sbFetch('page_config', {method:'POST', body:JSON.stringify({page:'reglements', titre:'RÃ¨glements', data: regData})});
            }
            toast('RÃ¨glements sauvegardÃ©s!','success');
        }

        // === ARTICLES (Supabase) ===
        let sbArticles = [], sbPodcasts = [];

        async function loadMediasSB(){
            try {
                const [r1,r2] = await Promise.all([
                    sbFetch('medias_articles?order=date.desc,id.desc'),
                    sbFetch('medias_podcasts?order=date.desc,id.desc')
                ]);
                sbArticles = r1.ok ? await r1.json() : [];
                sbPodcasts = r2.ok ? await r2.json() : [];
            } catch(e){ console.error('Medias load error:', e); }
            renderArticles();
            renderPodcasts();
        }

        function renderArticles(){document.getElementById('articlesList').innerHTML=sbArticles.map(a=>`<div class="item-card"><h4>ğŸ“° ${a.titre}</h4><p style="font-size:.75rem;color:#888">${a.date||''} ${a.extrait?'- '+a.extrait.substring(0,60)+'...':''}</p><div class="action-btns"><button class="btn btn-primary btn-small" onclick="editArticle(${a.id})">âœï¸</button><button class="btn btn-danger btn-small" onclick="deleteArticle(${a.id})">ğŸ—‘ï¸</button></div></div>`).join('')||'Aucun'}
        function editArticle(id){const a=sbArticles.find(x=>x.id===id);if(!a)return;document.getElementById('articleId').value=id;document.getElementById('articleTitre').value=a.titre;document.getElementById('articleDate').value=a.date||'';document.getElementById('articleExtrait').value=a.extrait||'';document.getElementById('articleLien').value=a.lien||'';openModal('article')}
        async function saveArticle(){const id=document.getElementById('articleId').value;const titre=document.getElementById('articleTitre').value.trim();if(!titre)return toast('Requis','danger');const d={titre,date:document.getElementById('articleDate').value,extrait:document.getElementById('articleExtrait').value,lien:document.getElementById('articleLien').value};if(id){await sbFetch('medias_articles?id=eq.'+id,{method:'PATCH',body:JSON.stringify(d)})}else{await sbFetch('medias_articles',{method:'POST',body:JSON.stringify(d)})}closeModal('article');document.getElementById('articleId').value='';document.getElementById('articleTitre').value='';toast('OK','success');loadMediasSB()}
        async function deleteArticle(id){confirm('Supprimer?',async()=>{await sbFetch('medias_articles?id=eq.'+id,{method:'DELETE'});toast('OK','success');loadMediasSB()})}

        // === PODCASTS (Supabase) ===
        function renderPodcasts(){document.getElementById('podcastsList').innerHTML=sbPodcasts.map(p=>`<div class="item-card"><h4>ğŸ™ï¸ ${p.titre} ${p.episode||''}</h4><p style="font-size:.75rem;color:#888">${p.date||''} ${p.plateforme?'('+p.plateforme+')':''}</p><div class="action-btns"><button class="btn btn-primary btn-small" onclick="editPodcast(${p.id})">âœï¸</button><button class="btn btn-danger btn-small" onclick="deletePodcast(${p.id})">ğŸ—‘ï¸</button></div></div>`).join('')||'Aucun'}
        function editPodcast(id){const p=sbPodcasts.find(x=>x.id===id);if(!p)return;document.getElementById('podcastId').value=id;document.getElementById('podcastTitre').value=p.titre;document.getElementById('podcastEpisode').value=p.episode||'';document.getElementById('podcastDate').value=p.date||'';document.getElementById('podcastDesc').value=p.description||'';document.getElementById('podcastDuree').value=p.duree||'';document.getElementById('podcastPlateforme').value=p.plateforme||'';document.getElementById('podcastLien').value=p.lien||'';openModal('podcast')}
        async function savePodcast(){const id=document.getElementById('podcastId').value;const titre=document.getElementById('podcastTitre').value.trim();if(!titre)return toast('Requis','danger');const d={titre,episode:document.getElementById('podcastEpisode').value,date:document.getElementById('podcastDate').value,description:document.getElementById('podcastDesc').value,duree:document.getElementById('podcastDuree').value,plateforme:document.getElementById('podcastPlateforme').value,lien:document.getElementById('podcastLien').value};if(id){await sbFetch('medias_podcasts?id=eq.'+id,{method:'PATCH',body:JSON.stringify(d)})}else{await sbFetch('medias_podcasts',{method:'POST',body:JSON.stringify(d)})}closeModal('podcast');document.getElementById('podcastId').value='';document.getElementById('podcastTitre').value='';toast('OK','success');loadMediasSB()}
        async function deletePodcast(id){confirm('Supprimer?',async()=>{await sbFetch('medias_podcasts?id=eq.'+id,{method:'DELETE'});toast('OK','success');loadMediasSB()})}

        // === USERS (SUPABASE) ===
        async function loadUsersSB() {
            if (session.role !== 'superadmin') return;
            try {
                const res = await sbFetch('admin_users?actif=eq.true&order=nom.asc&select=id,username,nom,role,equipe', { headers: { 'Range': '0-999' } });
                users = res.ok ? await res.json() : [];
                renderUsers();
            } catch (e) {
                console.error('Erreur chargement utilisateurs:', e);
                users = [];
                renderUsers();
            }
        }
        function renderUsers(){if(session.role!=='superadmin')return;document.getElementById('usersList').innerHTML=users.map(u=>`<tr><td>${u.username}</td><td>${u.nom}</td><td>${u.role}</td><td>${u.equipe||'-'}</td><td class="action-btns"><button class="btn btn-primary btn-small" onclick="editUser(${u.id})">âœï¸</button>${users.filter(x=>x.role==='superadmin').length>1||u.role!=='superadmin'?`<button class="btn btn-danger btn-small" onclick="deleteUser(${u.id})">ğŸ—‘ï¸</button>`:''}</td></tr>`).join('')}
        function editUser(id){const u=users.find(x=>x.id===id);if(!u)return;document.getElementById('userId').value=u.id;document.getElementById('userUsername').value=u.username;document.getElementById('userPassword').value='';document.getElementById('userNom').value=u.nom;document.getElementById('userEquipe').value=u.equipe||'';document.getElementById('userRole').value=u.role;openModal('user')}
        async function saveUser(){
    const id=document.getElementById('userId').value;
    const username=document.getElementById('userUsername').value.trim().toLowerCase();
    const password=document.getElementById('userPassword').value;
    const nom=document.getElementById('userNom').value.trim();
    const equipe=document.getElementById('userEquipe').value.trim().toUpperCase();
    const role=document.getElementById('userRole').value;
    if(!username||!nom)return toast('Username et nom requis','danger');
    if(!id&&(!password||password.length<6))return toast('Mot de passe requis (6+)','danger');
    try{
        const res=await fetch(SB_URL+'/rest/v1/rpc/save_user',{
            method:'POST',
            headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'},
            body:JSON.stringify({p_id:id?parseInt(id):null,p_username:username,p_password:password||null,p_nom:nom,p_role:role,p_equipe:equipe})
        });
        if(res.ok){toast('Utilisateur sauvegardÃ©','success');closeModal('user');document.getElementById('userId').value='';await loadUsersSB()}
        else{toast('Erreur: '+await res.text(),'danger')}
    }catch(e){console.error(e);toast('Erreur sauvegarde','danger')}
}
        async function deleteUser(id){const u=users.find(x=>x.id===id);confirm('Supprimer '+u.nom+'?',async()=>{try{await sbFetch('admin_users?id=eq.'+id,{method:'DELETE'});toast('SupprimÃ©','success');await loadUsersSB()}catch(e){toast('Erreur','danger')}})}

        // === JOUEURS LISTE ===
        function printJoueursList(){
            if(!joueursList || !joueursList.joueurs || joueursList.joueurs.length === 0){
                toast('Aucun joueur Ã  imprimer','danger'); return;
            }
            const saison = joueursList.saison || '2026';
            let joueurs = [...joueursList.joueurs].sort((a,b) => a.nom.localeCompare(b.nom));
            
            // Appliquer les filtres actifs
            const search = (document.getElementById('adminSearchJoueur')?.value || '').toLowerCase();
            const filterCote = document.getElementById('adminFilterCote')?.value || '';
            const filterRole = document.getElementById('adminFilterRole')?.value || '';
            if(search) joueurs = joueurs.filter(j => j.nom.toLowerCase().includes(search));
            if(filterCote) joueurs = joueurs.filter(j => j.cote == filterCote);
            if(filterRole) joueurs = joueurs.filter(j => j.role === filterRole);
            
            const rows = joueurs.map((j, i) => {
                let role = 'Joueur';
                if(j.role==='coach') role='Coach';
                else if(j.role==='admin') role='Admin';
                else if(j.role==='coachadmin') role='Coach+Admin';
                else if(j.role==='lanceur_a') role='Lanceur A';
                else if(j.role==='coachlanceur_a') role='Coach+Lanceur A';
                const bg = i % 2 === 0 ? '#fff' : '#f8f6f0';
                return '<tr style="background:'+bg+'">'+
                    '<td style="padding:4px 8px;border:1px solid #ccc;font-weight:600">'+j.nom+'</td>'+
                    '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center">'+j.cote+'</td>'+
                    '<td style="padding:4px 8px;border:1px solid #ccc">'+role+'</td>'+
                    '<td style="padding:4px 8px;border:1px solid #ccc;font-size:9pt">'+(j.telephone1||'â€”')+'</td>'+
                    '<td style="padding:4px 8px;border:1px solid #ccc;font-size:9pt">'+(j.telephone2||'â€”')+'</td>'+
                    '<td style="padding:4px 8px;border:1px solid #ccc;font-size:8pt">'+(j.courriel||'â€”')+'</td>'+
                    '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center">'+(j.naissance||'â€”')+'</td>'+
                    '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center">'+(j.actif===false?'Non':'Oui')+'</td>'+
                '</tr>';
            }).join('');
            
            const totalCote = joueurs.reduce((s,j)=>s+j.cote,0);
            const moyCote = joueurs.length > 0 ? (totalCote/joueurs.length).toFixed(1) : '0';
            const coachs = joueurs.filter(j=>j.role==='coach'||j.role==='coachadmin').length;
            
            const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Joueurs LBMA '+saison+'</title>'+
                '<style>'+
                    '@page{size:letter landscape;margin:1cm}'+
                    'body{font-family:Arial,sans-serif;font-size:10pt;margin:0;padding:1cm}'+
                    'h1{font-size:16pt;color:#1E3A5F;margin:0}'+
                    'h2{font-size:11pt;color:#666;margin:4px 0 12px 0;font-weight:normal}'+
                    '.stats{display:flex;gap:20px;margin-bottom:10px;font-size:9pt;color:#333}'+
                    '.stats span{background:#f0ece0;padding:3px 10px;border-radius:3px}'+
                    'table{width:100%;border-collapse:collapse;font-size:9pt}'+
                    'th{background:#1E3A5F;color:white;padding:6px 8px;text-align:left;font-size:8pt}'+
                    '.footer{margin-top:10px;text-align:center;font-size:8pt;color:#999}'+
                '</style></head><body>'+
                '<h1>ğŸƒ Liste des Joueurs LBMA â€” Saison '+saison+'</h1>'+
                '<h2>ImprimÃ© le '+new Date().toLocaleDateString('fr-CA',{year:'numeric',month:'long',day:'numeric'})+'</h2>'+
                '<div class="stats">'+
                    '<span><strong>'+joueurs.length+'</strong> joueurs</span>'+
                    '<span><strong>'+coachs+'</strong> coachs</span>'+
                    '<span>Cote moyenne: <strong>'+moyCote+'</strong></span>'+
                    '<span>Total cotes: <strong>'+totalCote+'</strong></span>'+
                '</div>'+
                '<table>'+
                    '<thead><tr><th>Nom</th><th>Cote</th><th>RÃ´le</th><th>TÃ©lÃ©phone 1</th><th>TÃ©lÃ©phone 2</th><th>Courriel</th><th>Naissance</th><th>Actif</th></tr></thead>'+
                    '<tbody>'+rows+'</tbody>'+
                '</table>'+
                '<div class="footer">LBMA â€” Ligue de Balle Molle Amicale â€” liguelbma.org</div>'+
                '<script>window.onload=function(){window.print();}<\/script>'+
            '</body></html>';
            
            const w = window.open('','_blank','width=1100,height=700');
            w.document.write(html);
            w.document.close();
        }

        function renderJoueursList(){
            if(!joueursList || !joueursList.joueurs) return;
            
            const search = (document.getElementById('adminSearchJoueur')?.value || '').toLowerCase();
            const filterCote = document.getElementById('adminFilterCote')?.value || '';
            const filterRole = document.getElementById('adminFilterRole')?.value || '';
            
            let filtered = joueursList.joueurs.filter(j => {
                if(search && !j.nom.toLowerCase().includes(search)) return false;
                if(filterCote && j.cote != filterCote) return false;
                if(filterRole && j.role !== filterRole) return false;
                return true;
            });
            
            filtered.sort((a,b) => a.nom.localeCompare(b.nom));
            
            document.getElementById('joueursCount').textContent = filtered.length;
            
            const tbody = document.getElementById('joueursAdminBody');
            tbody.innerHTML = filtered.map(j => {
                let roleStyle = '';
                let roleBadge = 'Joueur';
                let rowStyle = '';
                
                if (j.role === 'lanceur_a') {
                    roleStyle = 'background:#CC0000;color:white';
                    roleBadge = 'ğŸ¯ Lanceur A';
                    rowStyle = 'background:rgba(204,0,0,0.05)';
                } else if (j.role === 'coach') {
                    roleStyle = 'background:#28a745;color:white';
                    roleBadge = 'ğŸ‘” Coach';
                    rowStyle = 'background:rgba(40,167,69,0.1)';
                } else if (j.role === 'admin') {
                    roleStyle = 'background:#ffc107;color:#333';
                    roleBadge = 'âš™ï¸ Admin';
                    rowStyle = 'background:rgba(255,193,7,0.1)';
                } else if (j.role === 'coachadmin') {
                    roleStyle = 'background:linear-gradient(135deg,#28a745 50%,#ffc107 50%);color:white';
                    roleBadge = 'ğŸ‘”âš™ï¸ Coach+Admin';
                    rowStyle = 'background:linear-gradient(90deg,rgba(40,167,69,0.1) 0%,rgba(255,193,7,0.1) 100%)';
                } else if (j.role === 'coachlanceur_a') {
                    roleStyle = 'background:linear-gradient(135deg,#28a745 50%,#CC0000 50%);color:white';
                    roleBadge = 'ğŸ‘”ğŸ¯ Coach+Lanceur A';
                    rowStyle = 'background:linear-gradient(90deg,rgba(40,167,69,0.1) 0%,rgba(204,0,0,0.05) 100%)';
                }
                
                return `<tr style="${rowStyle}">
                    <td><strong>${j.nom}</strong></td>
                    <td><span class="cote-badge cote-${j.cote}">${j.cote}</span></td>
                    <td><span style="padding:.2rem .5rem;border-radius:3px;font-size:.75rem;${roleStyle}">${roleBadge}</span></td>
                    <td>${j.telephone1 || 'â€”'}</td>
                    <td style="font-size:.75rem">${j.courriel || 'â€”'}</td>
                    <td>${j.naissance || 'â€”'}</td>
                    <td class="action-btns">
                        <button class="btn btn-primary btn-small" onclick="openJoueurListModal(${j.id})">âœï¸</button>
                        <button class="btn btn-danger btn-small" onclick="deleteJoueurList(${j.id})">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function openJoueurListModal(id){
            document.getElementById('joueurListIdx').value = id || -1;
            if(id > 0){
                const j = joueursList.joueurs.find(x => x.id === id);
                if(j){
                    document.getElementById('joueurListNom').value = j.nom;
                    document.getElementById('joueurListCote').value = j.cote;
                    document.getElementById('joueurListRole').value = j.role || 'joueur';
                    document.getElementById('joueurListNaissance').value = j.naissance || '';
                    document.getElementById('joueurListTel1').value = j.telephone1 || '';
                    document.getElementById('joueurListTel2').value = j.telephone2 || '';
                    document.getElementById('joueurListCourriel').value = j.courriel || '';
                } else {
                    document.getElementById('joueurListNom').value = '';
                    document.getElementById('joueurListCote').value = '3';
                    document.getElementById('joueurListRole').value = 'joueur';
                    document.getElementById('joueurListNaissance').value = '';
                    document.getElementById('joueurListTel1').value = '';
                    document.getElementById('joueurListTel2').value = '';
                    document.getElementById('joueurListCourriel').value = '';
                }
            } else {
                document.getElementById('joueurListNom').value = '';
                document.getElementById('joueurListCote').value = '3';
                document.getElementById('joueurListRole').value = 'joueur';
                document.getElementById('joueurListNaissance').value = '';
                document.getElementById('joueurListTel1').value = '';
                document.getElementById('joueurListTel2').value = '';
                document.getElementById('joueurListCourriel').value = '';
            }
            openModal('joueurList');
        }
        
        async function saveJoueurList(){
            const id = parseInt(document.getElementById('joueurListIdx').value);
            const nom = document.getElementById('joueurListNom').value.trim();
            if(!nom) return toast('Nom requis!', 'danger');
            
            const data = {
                saison: joueursList.saison || '2026',
                nom: nom.toUpperCase(),
                cote: parseInt(document.getElementById('joueurListCote').value),
                role: document.getElementById('joueurListRole').value,
                naissance: document.getElementById('joueurListNaissance').value.trim(),
                telephone1: document.getElementById('joueurListTel1').value.trim(),
                telephone2: document.getElementById('joueurListTel2').value.trim(),
                courriel: document.getElementById('joueurListCourriel').value.trim(),
                actif: true
            };
            
            let res;
            if(id > 0){
                res = await sbFetch('joueurs_liste?id=eq.' + id, { method: 'PATCH', body: JSON.stringify(data) });
            } else {
                res = await sbFetch('joueurs_liste', { method: 'POST', body: JSON.stringify(data) });
            }
            
            if(res.ok){
                closeModal('joueurList');
                toast('Joueur sauvegardÃ©!', 'success');
                loadJoueursList();
            } else {
                toast('Erreur Supabase', 'danger');
            }
        }
        
        function deleteJoueurList(id){
            confirm('Supprimer ce joueur de la liste?', async () => {
                const res = await sbFetch('joueurs_liste?id=eq.' + id, { method: 'DELETE' });
                if(res.ok){
                    toast('Joueur supprimÃ©!', 'success');
                    loadJoueursList();
                } else {
                    toast('Erreur Supabase', 'danger');
                }
            });
        }
        function downloadJoueursJSON(){
            const saison = joueursList.saison || '2025';
            const json = JSON.stringify(joueursList, null, 2);
            const blob = new Blob([json], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `joueurs-${saison}.json`;
            a.click();
            URL.revokeObjectURL(url);
            toast('JSON tÃ©lÃ©chargÃ©!', 'success');
        }
        
        function archiverJoueurs(){
            const saison = joueursList.saison || '2025';
            const existingIdx = archivesJoueurs.saisons.findIndex(a => a.saison === saison);
            
            if(existingIdx >= 0){
                confirm(`La saison ${saison} est dÃ©jÃ  archivÃ©e. Remplacer?`, () => {
                    archivesJoueurs.saisons[existingIdx] = {
                        saison: saison,
                        dateArchive: new Date().toISOString(),
                        joueurs: JSON.parse(JSON.stringify(joueursList.joueurs))
                    };
                    save(KEYS.archivesJoueurs, archivesJoueurs);
                    toast(`Joueurs ${saison} mis Ã  jour!`, 'success');
                });
            } else {
                archivesJoueurs.saisons.push({
                    saison: saison,
                    dateArchive: new Date().toISOString(),
                    joueurs: JSON.parse(JSON.stringify(joueursList.joueurs))
                });
                save(KEYS.archivesJoueurs, archivesJoueurs);
                toast(`Joueurs ${saison} archivÃ©s!`, 'success');
            }
        }
        
        async function nouvelleSaisonJoueurs(){
            const saisonActuelle = joueursList.saison || '2025';
            const nouvelleSaison = prompt('AnnÃ©e de la nouvelle saison:', String(parseInt(saisonActuelle) + 1));
            if(!nouvelleSaison || !/^\d{4}$/.test(nouvelleSaison)) return;
            
            // VÃ©rifier si la saison existe dÃ©jÃ 
            const check = await sbFetch('joueurs_liste?saison=eq.' + nouvelleSaison + '&select=id', { headers: { 'Range': '0-0' } });
            const existing = check.ok ? await check.json() : [];
            
            if(existing.length > 0){
                confirm('La saison ' + nouvelleSaison + ' existe dÃ©jÃ  (' + existing.length + '+ joueurs). Voulez-vous la remplacer?', async () => {
                    await sbFetch('joueurs_liste?saison=eq.' + nouvelleSaison, { method: 'DELETE' });
                    await copyJoueursToSaison(nouvelleSaison);
                });
            } else {
                await copyJoueursToSaison(nouvelleSaison);
            }
        }
        
        async function copyJoueursToSaison(nouvelleSaison){
            // Copier tous les joueurs de la saison actuelle vers la nouvelle
            const joueurs = joueursList.joueurs.map(j => ({
                saison: nouvelleSaison,
                nom: j.nom, cote: j.cote, role: j.role,
                telephone1: j.telephone1 || '', telephone2: j.telephone2 || '',
                courriel: j.courriel || '', naissance: j.naissance || '', equipe: ''
            }));
            
            // Insert par batch de 20
            for(let i = 0; i < joueurs.length; i += 20){
                const batch = joueurs.slice(i, i + 20);
                await sbFetch('joueurs_liste', { method: 'POST', body: JSON.stringify(batch) });
            }
            
            joueursList.saison = nouvelleSaison;
            document.getElementById('joueursSaisonSelect').value = nouvelleSaison;
            updateJoueursSaisonDisplay();
            loadJoueursList();
            toast('Saison ' + nouvelleSaison + ' crÃ©Ã©e avec ' + joueurs.length + ' joueurs! Modifiez selon le repÃªchage.', 'success');
        }
        
        function renderArchivesJoueursList(){
            const container = document.getElementById('archivesJoueursList');
            if(!archivesJoueurs.saisons || archivesJoueurs.saisons.length === 0){
                container.innerHTML = '<p style="text-align:center;color:#666;padding:2rem">Aucune archive</p>';
                return;
            }
            const sorted = [...archivesJoueurs.saisons].sort((a,b) => b.saison.localeCompare(a.saison));
            container.innerHTML = sorted.map(arch => {
                const date = new Date(arch.dateArchive).toLocaleDateString('fr-CA');
                return `<div class="item-card">
                    <div style="flex:1">
                        <h4>ğŸƒ Saison ${arch.saison}</h4>
                        <p style="font-size:.8rem;color:#666">ArchivÃ©e le ${date} â€¢ ${arch.joueurs.length} joueurs</p>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-warning btn-small" onclick="downloadArchiveJoueurs('${arch.saison}')">ğŸ’¾ JSON</button>
                        <button class="btn btn-danger btn-small" onclick="deleteArchiveJoueurs('${arch.saison}')">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function downloadArchiveJoueurs(saison){
            const arch = archivesJoueurs.saisons.find(a => a.saison === saison);
            if(!arch) return;
            const data = {saison: arch.saison, joueurs: arch.joueurs};
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `joueurs-${saison}.json`;
            a.click();
            URL.revokeObjectURL(url);
            toast('Archive tÃ©lÃ©chargÃ©e!', 'success');
        }
        
        function deleteArchiveJoueurs(saison){
            confirm(`Supprimer l'archive ${saison}?`, () => {
                archivesJoueurs.saisons = archivesJoueurs.saisons.filter(a => a.saison !== saison);
                save(KEYS.archivesJoueurs, archivesJoueurs);
                renderArchivesJoueursList();
                toast('Archive supprimÃ©e', 'success');
            });
        }
        
        function downloadAllArchivesJoueurs(){
            const json = JSON.stringify(archivesJoueurs, null, 2);
            const blob = new Blob([json], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lbma-archives-joueurs.json';
            a.click();
            URL.revokeObjectURL(url);
            toast('Toutes les archives tÃ©lÃ©chargÃ©es!', 'success');
        }
        
        // Override openModal pour les archives joueurs
        const _origOpenModal = typeof openModal !== 'undefined' ? openModal : null;
        function openModal(id){
            if(id === 'archivesJoueurs') renderArchivesJoueursList();
            document.getElementById(id + 'Modal').classList.add('active');
        }

        // === GESTION DES CONTACTS / DIRECTION (Supabase) ===
        let sbContacts = [];

        async function loadContacts(){
            try {
                // Load contacts
                const r = await sbFetch('direction_contacts?order=ordre.asc,nom.asc', { headers: { 'Range': '0-999' } });
                sbContacts = r.ok ? await r.json() : [];
                // Load page config
                const rc = await sbFetch('page_config?page=eq.direction&select=*', { headers: { 'Range': '0-999' } });
                const arr = rc.ok ? await rc.json() : [];
                if(arr.length > 0){
                    document.getElementById('contactsPageTitre').value = arr[0].titre || '';
                    document.getElementById('contactsPageDesc').value = arr[0].description || '';
                }
            } catch(e) { console.error('Contacts load error:', e); sbContacts = []; }
            renderContacts();
        }

        async function saveContactsConfig(){
            const titre = document.getElementById('contactsPageTitre').value;
            const description = document.getElementById('contactsPageDesc').value;
            const check = await sbFetch("page_config?page=eq.direction&select=id");
            const arr = check.ok ? await check.json() : [];
            if(arr.length > 0){
                await sbFetch('page_config?page=eq.direction', {method:'PATCH', body:JSON.stringify({titre, description})});
            } else {
                await sbFetch('page_config', {method:'POST', body:JSON.stringify({page:'direction', titre, description})});
            }
            toast('Configuration sauvegard\u00e9e!', 'success');
        }

        function renderContacts(){
            const list = document.getElementById('contactsList');
            const countEl = document.getElementById('contactsCount');
            countEl.textContent = sbContacts.length;

            if(sbContacts.length === 0){
                list.innerHTML = '<p style="text-align:center;color:#666;padding:2rem">Aucun contact. Cliquez sur "Ajouter" pour commencer.</p>';
                return;
            }

            list.innerHTML = sbContacts.map(c => {
                const respText = c.responsabilites && c.responsabilites.length > 0
                    ? c.responsabilites.slice(0, 2).join(', ') + (c.responsabilites.length > 2 ? '...' : '')
                    : 'Aucune responsabilitÃ©';
                return `
                    <div class="item-card">
                        <div style="flex:1">
                            <h4>${c.nom} ${c.sous_titre ? '<span style="background:var(--gold);color:var(--dark);padding:0 .4rem;font-size:.7rem;border-radius:3px;margin-left:.5rem">' + c.sous_titre + '</span>' : ''}</h4>
                            <p><strong>${c.titre}</strong></p>
                            <p style="font-size:.75rem">ğŸ“ ${c.telephone || 'N/A'} | âœ‰ï¸ ${c.courriel || 'N/A'}</p>
                            <p style="font-size:.7rem;color:#888;margin-top:.25rem">ğŸ“‹ ${respText}</p>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:.25rem;align-items:center">
                            <span style="font-size:.7rem;color:#666">Ordre: ${c.ordre || '-'}</span>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-small" onclick="openContactModal(${c.id})">âœï¸</button>
                                <button class="btn btn-danger btn-small" onclick="deleteContact(${c.id})">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openContactModal(id){
            if(id === -1){
                document.getElementById('contactIdx').value = -1;
                document.getElementById('contactNom').value = '';
                document.getElementById('contactTitre').value = 'Directeur';
                document.getElementById('contactSousTitre').value = '';
                document.getElementById('contactTelephone').value = '';
                document.getElementById('contactCourriel').value = '';
                document.getElementById('contactResponsabilites').value = '';
                document.getElementById('contactOrdre').value = sbContacts.length + 1;
            } else {
                const c = sbContacts.find(x => x.id === id);
                if(!c) return;
                document.getElementById('contactIdx').value = id;
                document.getElementById('contactNom').value = c.nom || '';
                document.getElementById('contactTitre').value = c.titre || '';
                document.getElementById('contactSousTitre').value = c.sous_titre || '';
                document.getElementById('contactTelephone').value = c.telephone || '';
                document.getElementById('contactCourriel').value = c.courriel || '';
                document.getElementById('contactResponsabilites').value = (c.responsabilites || []).join('\n');
                document.getElementById('contactOrdre').value = c.ordre || 1;
            }
            openModal('contact');
        }

        async function saveContact(){
            const id = parseInt(document.getElementById('contactIdx').value);
            const nom = document.getElementById('contactNom').value.trim();
            const titre = document.getElementById('contactTitre').value.trim();
            if(!nom || !titre) return toast('Nom et titre obligatoires!', 'danger');

            const respText = document.getElementById('contactResponsabilites').value;
            const responsabilites = respText.split('\n').map(r => r.trim()).filter(r => r.length > 0);

            const body = {
                nom, titre,
                sous_titre: document.getElementById('contactSousTitre').value.trim(),
                telephone: document.getElementById('contactTelephone').value.trim(),
                courriel: document.getElementById('contactCourriel').value.trim(),
                responsabilites,
                ordre: parseInt(document.getElementById('contactOrdre').value) || 1
            };

            if(id > 0){
                await sbFetch('direction_contacts?id=eq.' + id, {method:'PATCH', body:JSON.stringify(body)});
                toast('Contact mis \u00e0 jour!', 'success');
            } else {
                await sbFetch('direction_contacts', {method:'POST', body:JSON.stringify(body)});
                toast('Contact ajout\u00e9!', 'success');
            }
            closeModal('contact');
            loadContacts();
        }

        async function deleteContact(id){
            const c = sbContacts.find(x => x.id === id);
            confirm('Supprimer ' + (c ? c.nom : '') + ' de la direction?', async () => {
                await sbFetch('direction_contacts?id=eq.' + id, {method:'DELETE'});
                toast('Contact supprim\u00e9', 'success');
                loadContacts();
            });
        }

        // ====== STATS LANCEURS (Supabase) ======
        const SB_URL = 'https://xgyskiatppgaeaamjhxr.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXNraWF0cHBnYWVhYW1qaHhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTgxNTQsImV4cCI6MjA4NjA3NDE1NH0.67KCcUWlJij-scDoCUvZpkiCle5-mHVmy-inRk96Tac';
        let lanceurData = [];

        async function sbFetch(path, opts = {}) {
            const res = await fetch(`${SB_URL}/rest/v1/${path}`, {
                ...opts,
                headers: {
                    'apikey': SB_KEY,
                    'Authorization': `Bearer ${SB_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': opts.method === 'PATCH' ? 'return=representation' : 'return=minimal',
                    ...(opts.headers || {})
                }
            });
            return res;
        }

        async function initLanceurSaisons() {
            try {
                const res = await sbFetch('lanceurs_saison?select=saison&order=saison.desc', { headers: { 'Range': '0-999' } });
                const rows = await res.json();
                const saisons = [...new Set(rows.map(r => r.saison))].sort((a, b) => b.localeCompare(a));
                const sel = document.getElementById('lanceurSaison');
                sel.innerHTML = '<option value="">-- Choisir --</option>';
                saisons.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            } catch (e) {
                console.error('Erreur chargement saisons lanceurs:', e);
            }
        }

        async function loadLanceurStats() {
            const saison = document.getElementById('lanceurSaison').value;
            if (!saison) { document.getElementById('lanceurBody').innerHTML = ''; document.getElementById('lanceurCount').textContent = '0'; return; }
            try {
                const res = await sbFetch(`lanceurs_saison?saison=eq.${saison}&order=moy.asc`, { headers: { 'Range': '0-999' } });
                lanceurData = await res.json();
                renderLanceurTable();
            } catch (e) {
                console.error('Erreur:', e);
                toast('Erreur de chargement', 'danger');
            }
        }

        function filterLanceurTable() { renderLanceurTable(); }

        function renderLanceurTable() {
            const search = (document.getElementById('lanceurSearch').value || '').toLowerCase();
            const filtered = lanceurData.filter(p => !search || p.nom.toLowerCase().includes(search));
            document.getElementById('lanceurCount').textContent = filtered.length;
            const body = document.getElementById('lanceurBody');
            body.innerHTML = filtered.map(p => {
                const moy = p.moy ? parseFloat(p.moy).toFixed(2) : '-';
                const eqClass = p.equipe ? `<span class="team-color">${p.equipe}</span>` : '-';
                const typeStr = p.type_lanceur || '-';
                return `<tr>
                    <td><strong>${p.nom}</strong></td>
                    <td>${eqClass}</td>
                    <td>${p.cote || '-'}</td>
                    <td><strong>${typeStr}</strong></td>
                    <td>${p.pl || 0}</td>
                    <td>${p.v || 0}</td>
                    <td>${p.d || 0}</td>
                    <td>${p.n || 0}</td>
                    <td>${p.pc || 0}</td>
                    <td>${p.cs || 0}</td>
                    <td>${p.bb || 0}</td>
                    <td>${p.rb || 0}</td>
                    <td><strong>${moy}</strong></td>
                    <td><button class="btn btn-primary btn-small" onclick="openLanceurEdit(${p.id})">âœï¸</button></td>
                </tr>`;
            }).join('');
        }

        function openLanceurEdit(id) {
            const p = lanceurData.find(x => x.id === id);
            if (!p) return;
            document.getElementById('lanceurEditId').value = p.id;
            document.getElementById('lanceurEditNom').value = p.nom || '';
            document.getElementById('lanceurEditSaison').value = p.saison || '';
            document.getElementById('lanceurEditEquipe').value = p.equipe || '';
            document.getElementById('lanceurEditCote').value = p.cote || '';
            document.getElementById('lanceurEditType').value = p.type_lanceur || '';
            document.getElementById('lanceurEditPL').value = p.pl || 0;
            document.getElementById('lanceurEditML').value = p.ml || 0;
            document.getElementById('lanceurEditV').value = p.v || 0;
            document.getElementById('lanceurEditD').value = p.d || 0;
            document.getElementById('lanceurEditN').value = p.n || 0;
            document.getElementById('lanceurEditPC').value = p.pc || 0;
            document.getElementById('lanceurEditCS').value = p.cs || 0;
            document.getElementById('lanceurEditBB').value = p.bb || 0;
            document.getElementById('lanceurEditRB').value = p.rb || 0;
            document.getElementById('lanceurEditMOY').value = p.moy || 0;
            openModal('lanceurEdit');
        }

        async function saveLanceurEdit() {
            const id = document.getElementById('lanceurEditId').value;
            const data = {
                nom: document.getElementById('lanceurEditNom').value.trim(),
                equipe: document.getElementById('lanceurEditEquipe').value,
                cote: document.getElementById('lanceurEditCote').value || null,
                type_lanceur: document.getElementById('lanceurEditType').value || null,
                pl: parseInt(document.getElementById('lanceurEditPL').value) || 0,
                ml: parseFloat(document.getElementById('lanceurEditML').value) || 0,
                v: parseInt(document.getElementById('lanceurEditV').value) || 0,
                d: parseInt(document.getElementById('lanceurEditD').value) || 0,
                n: parseInt(document.getElementById('lanceurEditN').value) || 0,
                pc: parseInt(document.getElementById('lanceurEditPC').value) || 0,
                cs: parseInt(document.getElementById('lanceurEditCS').value) || 0,
                bb: parseInt(document.getElementById('lanceurEditBB').value) || 0,
                rb: parseInt(document.getElementById('lanceurEditRB').value) || 0,
                moy: parseFloat(document.getElementById('lanceurEditMOY').value) || 0
            };
            try {
                const res = await sbFetch(`lanceurs_saison?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    toast('Lanceur mis Ã  jour!', 'success');
                    closeModal('lanceurEdit');
                    loadLanceurStats();
                } else {
                    const err = await res.text();
                    toast('Erreur: ' + err, 'danger');
                }
            } catch (e) {
                toast('Erreur rÃ©seau: ' + e.message, 'danger');
            }
        }

        // ====== Ã‰QUIPES SAISON (Supabase) ======
        const EQ_TEAMS = ['AIGLES','CONDORS','DUCS','FAUCONS','HARFANGS','VAUTOURS'];
        const EQ_COLORS = {AIGLES:'#FF8001',CONDORS:'#124FB2',DUCS:'#006400',FAUCONS:'#CC0000',HARFANGS:'#929292',VAUTOURS:'#333366'};
        const EQ_TEXT = {AIGLES:'white',CONDORS:'white',DUCS:'white',FAUCONS:'white',HARFANGS:'white',VAUTOURS:'white'};
        let eqData = []; // all rows from equipes_saison
        let eqJoueurs = []; // joueurs_liste for dropdown

        async function initEqSaisons() {
            try {
                const res = await sbFetch('equipes_saison?select=saison&order=saison.desc', { headers: { 'Range': '0-999' } });
                const rows = await res.json();
                const saisons = [...new Set(rows.map(r => r.saison))].sort((a, b) => b.localeCompare(a));
                const sel = document.getElementById('eqSaison');
                sel.innerHTML = saisons.length > 0 ? saisons.map(s => '<option value="' + s + '">' + s + '</option>').join('') : '<option value="">Aucune saison</option>';
                if (saisons.length > 0) loadEquipesSaison();
            } catch (e) { console.error('Erreur saisons EQ:', e); }
        }

        async function loadEquipesSaison() {
            const saison = document.getElementById('eqSaison').value;
            if (!saison) return;
            try {
                const res = await sbFetch('equipes_saison?saison=eq.' + saison + '&order=equipe.asc,ordre.asc', { headers: { 'Range': '0-999' } });
                if (!res.ok) { console.warn('equipes_saison: HTTP ' + res.status); return; }
                eqData = await res.json();

                // Also load joueurs_liste for add/replace dropdowns
                try {
                    const jr = await sbFetch('joueurs_liste?saison=eq.' + saison + '&or=(actif.eq.true,actif.is.null)&order=nom.asc', { headers: { 'Range': '0-999' } });
                    eqJoueurs = await jr.json();
                } catch(e) { eqJoueurs = []; }

                renderEqTeams();
                updateEqResume();
            } catch (e) { console.warn('equipes_saison non disponible:', e); }
        }

        function updateEqResume() {
            const total = eqData.length;
            const totalCote = eqData.reduce((s, r) => s + r.joueur_cote, 0);
            const teams = EQ_TEAMS.map(t => eqData.filter(r => r.equipe === t).length);
            document.getElementById('eqResume').innerHTML = total + ' joueurs | Î£ ' + totalCote + ' | ' + EQ_TEAMS.map((t, i) => t.substring(0, 3) + ':' + teams[i]).join(' ');
        }

        function renderEqTeams() {
            const container = document.getElementById('eqTeamsContainer');
            container.innerHTML = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0">' +
                EQ_TEAMS.map(team => {
                    const rows = eqData.filter(r => r.equipe === team);
                    const totalCote = rows.reduce((s, r) => s + r.joueur_cote, 0);
                    const coach = rows.find(r => r.is_coach);
                    return '<div style="border:2px solid var(--dark)">' +
                        '<div style="background:' + EQ_COLORS[team] + ';color:' + EQ_TEXT[team] + ';padding:.75rem;font-family:Bebas Neue,sans-serif;font-size:1.1rem;display:flex;justify-content:space-between;align-items:center">' +
                            '<span>' + team + '</span>' +
                            '<span style="font-family:Oswald,sans-serif;font-size:.8rem">Î£' + totalCote + ' | ' + rows.length + '/11</span>' +
                        '</div>' +
                        '<div style="padding:.5rem;background:var(--white)">' +
                            (coach ? '<div style="padding:.3rem .5rem;background:rgba(212,175,55,.2);font-weight:bold;font-size:.8rem;display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem"><span>ğŸ‘” ' + coach.joueur_nom + ' <span class="cote-badge cote-' + coach.joueur_cote + '" style="width:22px;height:22px;font-size:.7rem;display:inline-flex;border-radius:50%;align-items:center;justify-content:center;margin-left:.3rem">' + coach.joueur_cote + '</span></span><span>' + eqActionBtns(coach, team) + '</span></div>' : '') +
                            rows.filter(r => !r.is_coach).map(r =>
                                '<div style="padding:.25rem .5rem;border-bottom:1px solid var(--cream);font-size:.8rem;display:flex;justify-content:space-between;align-items:center">' +
                                    '<span>' + r.joueur_nom + ' <span class="cote-badge cote-' + r.joueur_cote + '" style="width:22px;height:22px;font-size:.7rem;display:inline-flex;border-radius:50%;align-items:center;justify-content:center;margin-left:.3rem">' + r.joueur_cote + '</span></span>' +
                                    '<span>' + eqActionBtns(r, team) + '</span>' +
                                '</div>'
                            ).join('') +
                            '<div style="padding:.4rem;text-align:center"><button class="btn btn-success btn-small" onclick="openEqAddModal(\'' + team + '\')" style="font-size:.7rem;padding:.25rem .5rem">â• Ajouter</button></div>' +
                        '</div>' +
                    '</div>';
                }).join('') +
            '</div>';
        }

        function eqActionBtns(row, team) {
            return '<button class="btn btn-warning btn-small" onclick="openEqReplaceModal(' + row.id + ',\'' + team + '\')" style="font-size:.65rem;padding:.15rem .35rem;margin-right:.2rem" title="Remplacer">ğŸ”„</button>' +
                   '<button class="btn btn-danger btn-small" onclick="deleteEqPlayer(' + row.id + ')" style="font-size:.65rem;padding:.15rem .35rem" title="Retirer">âœ•</button>';
        }

        // --- Add player to team ---
        function openEqAddModal(team) {
            document.getElementById('eqAddTeam').value = team;
            document.getElementById('eqAddTeamName').textContent = team;
            document.getElementById('eqAddNom').value = '';
            document.getElementById('eqAddCote').value = '3';
            document.getElementById('eqAddCoach').value = 'false';

            // Populate dropdown with joueurs not already in any team
            const inTeam = eqData.map(r => r.joueur_nom.toLowerCase());
            const available = eqJoueurs.filter(j => !inTeam.includes(j.nom.toLowerCase()));
            const sel = document.getElementById('eqAddJoueur');
            sel.innerHTML = '<option value="">-- Choisir de la liste --</option>';
            available.forEach(j => { sel.innerHTML += '<option value="' + j.id + '" data-cote="' + j.cote + '">[' + j.cote + '] ' + j.nom + '</option>'; });
            sel.onchange = function() {
                const opt = sel.options[sel.selectedIndex];
                if (opt.dataset.cote) document.getElementById('eqAddCote').value = opt.dataset.cote;
            };

            openModal('eqAdd');
        }

        async function confirmEqAdd() {
            const team = document.getElementById('eqAddTeam').value;
            const saison = document.getElementById('eqSaison').value;
            const selVal = document.getElementById('eqAddJoueur').value;
            let nom, cote;

            if (selVal) {
                const j = eqJoueurs.find(x => x.id == selVal);
                nom = j ? j.nom : '';
                cote = j ? j.cote : 3;
            } else {
                nom = document.getElementById('eqAddNom').value.trim();
                cote = parseInt(document.getElementById('eqAddCote').value);
            }
            if (!nom) { toast('Nom requis!', 'danger'); return; }

            const isCoach = document.getElementById('eqAddCoach').value === 'true';
            const ordre = eqData.filter(r => r.equipe === team).length + 1;

            try {
                const res = await sbFetch('equipes_saison', {
                    method: 'POST',
                    body: JSON.stringify({ saison, equipe: team, joueur_nom: nom, joueur_cote: cote, is_coach: isCoach, ordre }),
                    headers: { 'Prefer': 'return=representation' }
                });
                if (res.ok) { toast('âœ… ' + nom + ' ajoutÃ© Ã  ' + team, 'success'); closeModal('eqAdd'); loadEquipesSaison(); }
                else { toast('Erreur: ' + await res.text(), 'danger'); }
            } catch (e) { toast('Erreur: ' + e.message, 'danger'); }
        }

        // --- Replace player ---
        function openEqReplaceModal(rowId, team) {
            const row = eqData.find(r => r.id === rowId);
            if (!row) return;
            document.getElementById('eqReplaceId').value = rowId;
            document.getElementById('eqReplaceTeam').value = team;
            document.getElementById('eqReplacePlayerName').textContent = row.joueur_nom;
            document.getElementById('eqReplaceNom').value = '';
            document.getElementById('eqReplaceCote').value = row.joueur_cote;

            const inTeam = eqData.map(r => r.joueur_nom.toLowerCase());
            const available = eqJoueurs.filter(j => !inTeam.includes(j.nom.toLowerCase()));
            const sel = document.getElementById('eqReplaceJoueur');
            sel.innerHTML = '<option value="">-- Choisir de la liste --</option>';
            available.forEach(j => { sel.innerHTML += '<option value="' + j.id + '" data-cote="' + j.cote + '">[' + j.cote + '] ' + j.nom + '</option>'; });
            sel.onchange = function() {
                const opt = sel.options[sel.selectedIndex];
                if (opt.dataset.cote) document.getElementById('eqReplaceCote').value = opt.dataset.cote;
            };

            openModal('eqReplace');
        }

        async function confirmEqReplace() {
            const rowId = document.getElementById('eqReplaceId').value;
            const selVal = document.getElementById('eqReplaceJoueur').value;
            let nom, cote;

            if (selVal) {
                const j = eqJoueurs.find(x => x.id == selVal);
                nom = j ? j.nom : '';
                cote = j ? j.cote : 3;
            } else {
                nom = document.getElementById('eqReplaceNom').value.trim();
                cote = parseInt(document.getElementById('eqReplaceCote').value);
            }
            if (!nom) { toast('Nom du remplaÃ§ant requis!', 'danger'); return; }

            try {
                const res = await sbFetch('equipes_saison?id=eq.' + rowId, {
                    method: 'PATCH',
                    body: JSON.stringify({ joueur_nom: nom, joueur_cote: cote }),
                    headers: { 'Prefer': 'return=representation' }
                });
                const text = await res.text();
                if (res.ok) {
                    const updated = text ? JSON.parse(text) : [];
                    if (updated.length > 0) {
                        toast('ğŸ”„ RemplacÃ© par ' + nom, 'success');
                    } else {
                        toast('âš ï¸ Aucune ligne modifiÃ©e â€” vÃ©rifier les permissions Supabase (RLS)', 'warning');
                    }
                    closeModal('eqReplace'); loadEquipesSaison();
                }
                else { toast('Erreur: ' + text, 'danger'); }
            } catch (e) { toast('Erreur: ' + e.message, 'danger'); }
        }

        // --- Delete player from team ---
        function deleteEqPlayer(rowId) {
            const row = eqData.find(r => r.id === rowId);
            if (!row) return;
            confirm('Retirer ' + row.joueur_nom + ' de ' + row.equipe + '?', async () => {
                try {
                    const res = await sbFetch('equipes_saison?id=eq.' + rowId, { 
                        method: 'DELETE',
                        headers: { 'Prefer': 'return=representation' }
                    });
                    const text = await res.text();
                    if (res.ok) {
                        const deleted = text ? JSON.parse(text) : [];
                        if (deleted.length > 0) {
                            toast('âœ… ' + row.joueur_nom + ' retirÃ©', 'success');
                        } else {
                            toast('âš ï¸ Aucune ligne supprimÃ©e â€” vÃ©rifier les permissions Supabase (RLS)', 'warning');
                        }
                        loadEquipesSaison();
                    }
                    else { toast('Erreur HTTP ' + res.status + ': ' + text, 'danger'); }
                } catch (e) { toast('Erreur: ' + e.message, 'danger'); }
            });
        }

        // ====== JOUEURS REPÃŠCHAGE (Supabase) ======
        let jrData = [];

        async function initJrSaisons() {
            try {
                const res = await sbFetch('joueurs_liste?select=saison&order=saison.desc', { headers: { 'Range': '0-999' } });
                const rows = await res.json();
                const saisons = [...new Set(rows.map(r => r.saison))].sort((a, b) => b.localeCompare(a));
                const sel = document.getElementById('jrSaison');
                sel.innerHTML = '';
                saisons.forEach(s => sel.innerHTML += '<option value="' + s + '">' + s + '</option>');
                if (saisons.length > 0) loadJoueursRepechage();
            } catch (e) { console.error('Erreur saisons JR:', e); }
        }

        async function loadJoueursRepechage() {
            const saison = document.getElementById('jrSaison').value;
            if (!saison) return;
            try {
                const res = await sbFetch('joueurs_liste?saison=eq.' + saison + '&order=nom.asc', { headers: { 'Range': '0-999' } });
                jrData = await res.json();
                renderJrTable();
                const actifs = jrData.filter(j => j.actif !== false).length;
                const totalCote = jrData.filter(j => j.actif !== false).reduce((s, j) => s + j.cote, 0);
                document.getElementById('jrStats').innerHTML = actifs + ' actifs | Î£ ' + totalCote + ' | Cible/Ã©q: ' + (totalCote / 6).toFixed(1);
            } catch (e) { console.error(e); toast('Erreur chargement joueurs', 'danger'); }
        }

        function renderJrTable() {
            const search = (document.getElementById('jrSearch').value || '').toLowerCase();
            const filterCote = document.getElementById('jrFilterCote').value;
            const filterActif = document.getElementById('jrFilterActif').value;
            let filtered = jrData.filter(j => {
                if (search && !j.nom.toLowerCase().includes(search)) return false;
                if (filterCote && j.cote != filterCote) return false;
                if (filterActif === 'true' && j.actif === false) return false;
                if (filterActif === 'false' && j.actif !== false) return false;
                return true;
            });
            document.getElementById('jrCount').textContent = filtered.length;
            document.getElementById('jrBody').innerHTML = filtered.map(j => {
                const actifBadge = j.actif === false
                    ? '<span style="color:var(--danger);font-weight:bold">âŒ</span>'
                    : '<span style="color:var(--success)">âœ…</span>';
                let roleBadge = 'Joueur';
                if (j.role === 'lanceur_a') roleBadge = 'ğŸ¯ Lanceur A';
                else if (j.role === 'coach') roleBadge = 'ğŸ‘” Coach';
                else if (j.role === 'admin') roleBadge = 'âš™ï¸ Admin';
                else if (j.role === 'coachadmin') roleBadge = 'ğŸ‘”âš™ï¸';
                const rowStyle = j.actif === false ? 'opacity:.5' : '';
                return '<tr style="' + rowStyle + '"><td><strong>' + j.nom + '</strong></td><td><span class="cote-badge cote-' + j.cote + '">' + j.cote + '</span></td><td>' + roleBadge + '</td><td style="font-size:.75rem">' + (j.telephone1 || 'â€”') + '</td><td style="font-size:.75rem">' + (j.courriel || 'â€”') + '</td><td>' + actifBadge + '</td><td class="action-btns"><button class="btn btn-primary btn-small" onclick="openJrModal(' + j.id + ')">âœï¸</button><button class="btn btn-danger btn-small" onclick="deleteJr(' + j.id + ')">ğŸ—‘ï¸</button></td></tr>';
            }).join('');
        }

        function openJrModal(id) {
            document.getElementById('jrEditId').value = id === -1 ? '' : id;
            if (id === -1) {
                document.getElementById('jrEditNom').value = '';
                document.getElementById('jrEditCote').value = '3';
                document.getElementById('jrEditRole').value = 'joueur';
                document.getElementById('jrEditActif').value = 'true';
                document.getElementById('jrEditTel1').value = '';
                document.getElementById('jrEditTel2').value = '';
                document.getElementById('jrEditCourriel').value = '';
                document.getElementById('jrEditNaissance').value = '';
            } else {
                const j = jrData.find(x => x.id === id);
                if (!j) return;
                document.getElementById('jrEditNom').value = j.nom || '';
                document.getElementById('jrEditCote').value = j.cote || 3;
                document.getElementById('jrEditRole').value = j.role || 'joueur';
                document.getElementById('jrEditActif').value = j.actif === false ? 'false' : 'true';
                document.getElementById('jrEditTel1').value = j.telephone1 || '';
                document.getElementById('jrEditTel2').value = j.telephone2 || '';
                document.getElementById('jrEditCourriel').value = j.courriel || '';
                document.getElementById('jrEditNaissance').value = j.naissance || '';
            }
            openModal('jrEdit');
        }

        async function saveJrEdit() {
            const id = document.getElementById('jrEditId').value;
            const nom = document.getElementById('jrEditNom').value.trim();
            if (!nom) { toast('Nom requis!', 'danger'); return; }
            const data = {
                nom: nom,
                cote: parseInt(document.getElementById('jrEditCote').value),
                role: document.getElementById('jrEditRole').value,
                actif: document.getElementById('jrEditActif').value === 'true',
                telephone1: document.getElementById('jrEditTel1').value.trim() || null,
                telephone2: document.getElementById('jrEditTel2').value.trim() || null,
                courriel: document.getElementById('jrEditCourriel').value.trim() || null,
                naissance: document.getElementById('jrEditNaissance').value.trim() || null
            };
            try {
                if (id) {
                    const res = await sbFetch('joueurs_liste?id=eq.' + id, { method: 'PATCH', body: JSON.stringify(data) });
                    if (res.ok) { toast('Joueur mis Ã  jour!', 'success'); }
                    else { toast('Erreur: ' + await res.text(), 'danger'); return; }
                } else {
                    data.saison = document.getElementById('jrSaison').value;
                    const res = await sbFetch('joueurs_liste', {
                        method: 'POST',
                        body: JSON.stringify(data),
                        headers: { 'Prefer': 'return=representation' }
                    });
                    if (res.ok) { toast('Joueur ajoutÃ©!', 'success'); }
                    else { toast('Erreur: ' + await res.text(), 'danger'); return; }
                }
                closeModal('jrEdit');
                loadJoueursRepechage();
            } catch (e) { toast('Erreur: ' + e.message, 'danger'); }
        }

        async function deleteJr(id) {
            const j = jrData.find(x => x.id === id);
            if (!j) return;
            if (!window.confirm('Supprimer ' + j.nom + ' de la liste?')) return;
            try {
                const res = await sbFetch('joueurs_liste?id=eq.' + id, { method: 'DELETE' });
                if (res.ok) { toast('SupprimÃ©!', 'success'); loadJoueursRepechage(); }
                else { toast('Erreur', 'danger'); }
            } catch (e) { toast('Erreur: ' + e.message, 'danger'); }
        }

        async function copierSaisonJr() {
            const saisonActuelle = document.getElementById('jrSaison').value;
            const nouvSaison = prompt('Copier les joueurs ' + saisonActuelle + ' vers quelle saison?', String(parseInt(saisonActuelle) + 1));
            if (!nouvSaison || !/^\d{4}$/.test(nouvSaison)) return;
            const actifs = jrData.filter(j => j.actif !== false);
            if (!window.confirm('Copier ' + actifs.length + ' joueurs actifs de ' + saisonActuelle + ' vers ' + nouvSaison + '?')) return;
            try {
                const rows = actifs.map(j => ({
                    nom: j.nom, cote: j.cote, role: j.role || 'joueur',
                    telephone1: j.telephone1, telephone2: j.telephone2,
                    courriel: j.courriel, naissance: j.naissance,
                    saison: nouvSaison, actif: true
                }));
                const res = await sbFetch('joueurs_liste', {
                    method: 'POST',
                    body: JSON.stringify(rows),
                    headers: { 'Prefer': 'return=representation' }
                });
                if (res.ok) {
                    toast('âœ… ' + actifs.length + ' joueurs copiÃ©s vers ' + nouvSaison + '!', 'success');
                    initJrSaisons();
                } else { toast('Erreur: ' + await res.text(), 'danger'); }
            } catch (e) { toast('Erreur: ' + e.message, 'danger'); }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CORRECTION STATS HISTORIQUES (Super Admin)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.getElementById('shType').addEventListener('change',function(){
            var isF=this.value==='frappeurs';
            document.getElementById('shFieldsFrappeurs').style.display=isF?'':'none';
            document.getElementById('shFieldsLanceurs').style.display=isF?'none':'';
        });

        async function shSearch(){
            if(session.role!=='superadmin')return toast('AccÃ¨s refusÃ©','danger');
            var type=document.getElementById('shType').value;
            var nom=document.getElementById('shNom').value.trim();
            var saison=document.getElementById('shSaison').value.trim();
            if(!nom&&!saison)return toast('Entre un nom ou une saison','warning');
            var table=type==='frappeurs'?'frappeurs_saison':'lanceurs_saison';
            var q=table+'?select=*&order=saison.asc';
            if(nom)q+='&nom=ilike.*'+encodeURIComponent(nom)+'*';
            if(saison)q+='&saison=eq.'+saison;
            q+='&limit=100';
            try{
                var r=await sbFetch(q,{headers:{'Range':'0-999'}});
                var data=await r.json();
                shRenderResults(data,type);
            }catch(e){toast('Erreur: '+e.message,'danger');}
        }

        function shRenderResults(data,type){
            var el=document.getElementById('shResults');
            if(!data||data.length===0){el.innerHTML='<p style="color:var(--accent)">Aucun rÃ©sultat.</p>';return;}
            var isF=type==='frappeurs';
            var h='<table class="data-table"><thead><tr><th>Saison</th><th>Nom</th><th>Ã‰Q</th>';
            if(isF)h+='<th>Cote</th><th>PJ</th><th>AB</th><th>CS</th><th>1B</th><th>2B</th><th>3B</th><th>CC</th><th>PC</th><th>PP</th><th>SAC</th><th>BB</th><th>RB</th><th>MOY</th>';
            else h+='<th>PL</th><th>ML</th><th>PC</th><th>CS</th><th>BB</th><th>RB</th><th>V</th><th>D</th><th>N</th><th>MOY</th>';
            h+='<th>Actions</th></tr></thead><tbody>';
            data.forEach(function(d){
                h+='<tr><td>'+d.saison+'</td><td style="text-align:left;font-weight:600">'+d.nom+'</td><td>'+(d.equipe||'')+'</td>';
                if(isF){
                    h+='<td>'+(d.cote||'')+'</td><td>'+(d.pj||0)+'</td><td>'+(d.ab||0)+'</td><td>'+(d.cs||0)+'</td>';
                    h+='<td>'+(d.simples||0)+'</td><td>'+(d.doubles||0)+'</td><td>'+(d.triples||0)+'</td>';
                    h+='<td>'+(d.cc||0)+'</td><td>'+(d.pc||0)+'</td><td>'+(d.pp||0)+'</td><td>'+(d.sac||0)+'</td>';
                    h+='<td>'+(d.bb||0)+'</td><td>'+(d.rb||0)+'</td><td>'+(d.moy!=null?Number(d.moy).toFixed(3):'â€”')+'</td>';
                }else{
                    h+='<td>'+(d.pl||0)+'</td><td>'+(d.ml!=null?Number(d.ml).toFixed(1):'0')+'</td>';
                    h+='<td>'+(d.pc||0)+'</td><td>'+(d.cs||0)+'</td><td>'+(d.bb||0)+'</td><td>'+(d.rb||0)+'</td>';
                    h+='<td>'+(d.v||0)+'</td><td>'+(d.d||0)+'</td><td>'+(d.n||0)+'</td>';
                    h+='<td>'+(d.moy!=null?Number(d.moy).toFixed(2):'â€”')+'</td>';
                }
                h+='<td class="action-btns"><button class="btn btn-primary btn-small" onclick="shEdit('+d.id+',\''+type+'\')">âœï¸</button> ';
                h+='<button class="btn btn-danger btn-small" onclick="shDelete('+d.id+',\''+type+'\')">ğŸ—‘ï¸</button></td></tr>';
            });
            h+='</tbody></table><p style="opacity:.6;font-size:.85rem;margin-top:.5rem">'+data.length+' rÃ©sultat(s)</p>';
            el.innerHTML=h;
        }

        function shShowAdd(){
            if(session.role!=='superadmin')return toast('AccÃ¨s refusÃ©','danger');
            document.getElementById('shEditId').value='';
            document.getElementById('shFormTitle').textContent='â• Ajouter une entrÃ©e';
            document.getElementById('shFNom').value='';document.getElementById('shFEquipe').value='';document.getElementById('shFSaison').value='';
            ['shFCote','shFPj','shFAb','shFCs','shF1b','shF2b','shF3b','shFCc','shFPc','shFPp','shFSac','shFBb','shFRb','shFPl','shFMl','shFLPc','shFLCs','shFLBb','shFLRb','shFV','shFD','shFN'].forEach(function(id){var e=document.getElementById(id);if(e)e.value=id==='shFCote'?'':'0';});
            document.getElementById('shStatus').innerHTML='';
            document.getElementById('shFormBox').style.display='';
        }

        async function shEdit(id,type){
            if(session.role!=='superadmin')return toast('AccÃ¨s refusÃ©','danger');
            var table=type==='frappeurs'?'frappeurs_saison':'lanceurs_saison';
            try{
                var r=await sbFetch(table+'?id=eq.'+id);
                var data=await r.json();
                if(!data||data.length===0)return toast('EntrÃ©e non trouvÃ©e','danger');
                var d=data[0];
                document.getElementById('shType').value=type;
                document.getElementById('shType').dispatchEvent(new Event('change'));
                document.getElementById('shEditId').value=d.id;
                document.getElementById('shFormTitle').textContent='âœï¸ Modifier: '+d.nom+' ('+d.saison+')';
                document.getElementById('shFNom').value=d.nom||'';
                document.getElementById('shFEquipe').value=d.equipe||'';
                document.getElementById('shFSaison').value=d.saison||'';
                if(type==='frappeurs'){
                    document.getElementById('shFCote').value=d.cote||'';
                    document.getElementById('shFPj').value=d.pj||0;
                    document.getElementById('shFAb').value=d.ab||0;
                    document.getElementById('shFCs').value=d.cs||0;
                    document.getElementById('shF1b').value=d.simples||0;
                    document.getElementById('shF2b').value=d.doubles||0;
                    document.getElementById('shF3b').value=d.triples||0;
                    document.getElementById('shFCc').value=d.cc||0;
                    document.getElementById('shFPc').value=d.pc||0;
                    document.getElementById('shFPp').value=d.pp||0;
                    document.getElementById('shFSac').value=d.sac||0;
                    document.getElementById('shFBb').value=d.bb||0;
                    document.getElementById('shFRb').value=d.rb||0;
                }else{
                    document.getElementById('shFPl').value=d.pl||0;
                    document.getElementById('shFMl').value=d.ml||0;
                    document.getElementById('shFLPc').value=d.pc||0;
                    document.getElementById('shFLCs').value=d.cs||0;
                    document.getElementById('shFLBb').value=d.bb||0;
                    document.getElementById('shFLRb').value=d.rb||0;
                    document.getElementById('shFV').value=d.v||0;
                    document.getElementById('shFD').value=d.d||0;
                    document.getElementById('shFN').value=d.n||0;
                }
                document.getElementById('shStatus').innerHTML='';
                document.getElementById('shFormBox').style.display='';
            }catch(e){toast('Erreur: '+e.message,'danger');}
        }

        async function shSave(){
            if(session.role!=='superadmin')return toast('AccÃ¨s refusÃ©','danger');
            var type=document.getElementById('shType').value;
            var id=document.getElementById('shEditId').value;
            var nom=document.getElementById('shFNom').value.trim();
            var saison=document.getElementById('shFSaison').value.trim();
            var equipe=document.getElementById('shFEquipe').value.trim().toUpperCase();
            if(!nom)return toast('Nom obligatoire','warning');
            if(!saison)return toast('Saison obligatoire','warning');
            var table=type==='frappeurs'?'frappeurs_saison':'lanceurs_saison';
            var payload;
            if(type==='frappeurs'){
                var ab=parseInt(document.getElementById('shFAb').value)||0;
                var cs=parseInt(document.getElementById('shFCs').value)||0;
                var coteVal=document.getElementById('shFCote').value.trim();
                payload={nom:nom,equipe:equipe,saison:saison,
                    pj:parseInt(document.getElementById('shFPj').value)||0,ab:ab,cs:cs,
                    simples:parseInt(document.getElementById('shF1b').value)||0,
                    doubles:parseInt(document.getElementById('shF2b').value)||0,
                    triples:parseInt(document.getElementById('shF3b').value)||0,
                    cc:parseInt(document.getElementById('shFCc').value)||0,
                    pc:parseInt(document.getElementById('shFPc').value)||0,
                    pp:parseInt(document.getElementById('shFPp').value)||0,
                    sac:parseInt(document.getElementById('shFSac').value)||0,
                    bb:parseInt(document.getElementById('shFBb').value)||0,
                    rb:parseInt(document.getElementById('shFRb').value)||0,
                    moy:ab>0?Math.round((cs/ab)*1000000)/1000000:null};
                if(coteVal!=='')payload.cote=parseInt(coteVal);
            }else{
                var ml=parseFloat(document.getElementById('shFMl').value)||0;
                var pc=parseInt(document.getElementById('shFLPc').value)||0;
                payload={nom:nom,equipe:equipe,saison:saison,
                    pl:parseInt(document.getElementById('shFPl').value)||0,ml:ml,
                    pc:pc,cs:parseInt(document.getElementById('shFLCs').value)||0,
                    bb:parseInt(document.getElementById('shFLBb').value)||0,
                    rb:parseInt(document.getElementById('shFLRb').value)||0,
                    v:parseInt(document.getElementById('shFV').value)||0,
                    d:parseInt(document.getElementById('shFD').value)||0,
                    n:parseInt(document.getElementById('shFN').value)||0,
                    moy:ml>0?Math.round((pc/ml)*10000)/10000:null};
            }
            try{
                var method=id?'PATCH':'POST';
                var r=await sbFetch(table+(id?'?id=eq.'+id:''),{method:method,body:JSON.stringify(payload)});
                if(r.ok){
                    var moyStr=payload.moy!=null?(type==='frappeurs'?payload.moy.toFixed(3):payload.moy.toFixed(2)):'N/A';
                    document.getElementById('shStatus').innerHTML='<span style="color:var(--success)">âœ… '+(id?'ModifiÃ©':'AjoutÃ©')+': '+nom+' ('+saison+') â€” MOY: '+moyStr+'</span>';
                    toast((id?'ModifiÃ©':'AjoutÃ©')+': '+nom+' ('+saison+')','success');
                    if(document.getElementById('shNom').value||document.getElementById('shSaison').value)shSearch();
                }else{
                    var err=await r.text();
                    document.getElementById('shStatus').innerHTML='<span style="color:var(--accent)">âŒ '+err+'</span>';
                    toast('Erreur: '+err,'danger');
                }
            }catch(e){toast('Erreur: '+e.message,'danger');}
        }

        async function shDelete(id,type){
            if(session.role!=='superadmin')return toast('AccÃ¨s refusÃ©','danger');
            confirm('Supprimer cette entrÃ©e #'+id+' ?',async function(){
                var table=type==='frappeurs'?'frappeurs_saison':'lanceurs_saison';
                try{
                    var r=await sbFetch(table+'?id=eq.'+id,{method:'DELETE'});
                    if(r.ok){toast('SupprimÃ© #'+id,'success');shSearch();}
                    else toast('Erreur suppression','danger');
                }catch(e){toast('Erreur: '+e.message,'danger');}
            });
        }

        document.getElementById('shNom').addEventListener('keyup',function(e){if(e.key==='Enter')shSearch();});
        document.getElementById('shSaison').addEventListener('keyup',function(e){if(e.key==='Enter')shSearch();});

        init();
    </script>
</body>
</html>
