<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frappeurs - CarriÃ¨re - LBMA</title>
    <link rel="icon" type="image/jpeg" href="logo-lbma.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1E3A5F;--accent:#CC0000;--gold:#D4AF37;--white:#FDFBF7;--cream:#F5F1E8;--dark:#1A1A1A;--grass:#2D5016;--dirt:#8B6F47}
        body{font-family:'Work Sans',sans-serif;background:var(--cream);color:var(--dark)}
        .page-header{margin-top:80px;background:linear-gradient(135deg,var(--primary) 0%,#2D5A8A 100%);color:var(--white);padding:3rem 2rem;text-align:center;position:relative}
        .page-header::before{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:300px;height:300px;background:url('logo-lbma.jpg') no-repeat center;background-size:contain;opacity:.1}
        .page-header h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(2rem,6vw,3.5rem);letter-spacing:.1em;position:relative}
        .page-header p{font-family:'Oswald',sans-serif;font-size:1.2rem;position:relative;margin-top:.5rem}
        .container{max-width:1400px;margin:0 auto;padding:2rem}

        /* Controls */
        .controls{background:var(--white);border:3px solid var(--dark);padding:1.5rem;margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end}
        .control-group{display:flex;flex-direction:column;gap:.5rem}
        .control-group label{font-family:'Oswald',sans-serif;text-transform:uppercase;font-size:.85rem;color:var(--primary)}
        .control-group select,.control-group input{padding:.75rem 1.5rem;border:2px solid var(--dark);font-size:1rem;background:var(--cream);min-width:200px}
        .control-group input{min-width:250px}
        .btn{padding:.75rem 1.5rem;font-family:'Oswald',sans-serif;border:2px solid var(--dark);cursor:pointer;transition:.3s;text-transform:uppercase;background:var(--primary);color:white}
        .btn:hover{opacity:.9}
        .btn-secondary{background:var(--cream);color:var(--dark)}
        .btn-gold{background:var(--gold);color:var(--dark)}

        /* Podium */
        .podium-container{display:flex;justify-content:center;align-items:flex-end;gap:1.5rem;margin:2rem 0;padding:1rem}
        .podium-card{text-align:center;border:3px solid var(--dark);padding:1.5rem;min-width:200px;transition:transform .3s}
        .podium-card:hover{transform:translateY(-5px)}
        .podium-1{background:linear-gradient(135deg,#FFD700,#FFA000);order:2;min-height:180px}
        .podium-2{background:linear-gradient(135deg,#C0C0C0,#A0A0A0);order:1;min-height:150px}
        .podium-3{background:linear-gradient(135deg,#CD7F32,#A0522D);color:var(--white);order:3;min-height:130px}
        .podium-rank{font-family:'Bebas Neue',sans-serif;font-size:2.5rem}
        .podium-name{font-family:'Oswald',sans-serif;font-size:1.1rem;font-weight:700;margin:.5rem 0}
        .podium-stat{font-family:'Bebas Neue',sans-serif;font-size:2rem}
        .podium-label{font-size:.8rem;opacity:.8}

        /* Category Tabs */
        .cat-tabs{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1.5rem;justify-content:center}
        .cat-tab{padding:.6rem 1.2rem;border:2px solid var(--dark);background:var(--cream);font-family:'Oswald',sans-serif;font-size:.9rem;cursor:pointer;transition:.3s}
        .cat-tab:hover{background:var(--gold);color:var(--dark)}
        .cat-tab.active{background:var(--primary);color:white;border-color:var(--primary)}

        /* Stats Table */
        .table-wrap{overflow-x:auto;border:3px solid var(--dark);background:var(--white)}
        .stats-table{width:100%;border-collapse:collapse;font-size:.9rem}
        .stats-table th{background:var(--primary);color:white;padding:.75rem .5rem;text-align:center;font-family:'Oswald',sans-serif;text-transform:uppercase;font-size:.8rem;position:sticky;top:0;cursor:pointer;white-space:nowrap;user-select:none}
        .stats-table th:hover{background:#2D5A8A}
        .stats-table th.sort-asc::after{content:' â–²';font-size:.65rem}
        .stats-table th.sort-desc::after{content:' â–¼';font-size:.65rem}
        .stats-table td{padding:.5rem;text-align:center;border-bottom:1px solid var(--cream)}
        .stats-table tr:hover{background:rgba(30,58,95,.05)}
        .stats-table .player-name{text-align:left;font-weight:600;white-space:nowrap}
        .stats-table .highlight{background:rgba(212,175,55,.15)}
        .stats-table .new-badge{display:inline-block;background:var(--accent);color:white;font-size:.6rem;padding:1px 5px;border-radius:3px;margin-left:5px;vertical-align:middle}

        /* Summary */
        .summary-bar{display:flex;justify-content:center;gap:2rem;margin:1.5rem 0;flex-wrap:wrap}
        .summary-item{text-align:center;background:var(--white);border:2px solid var(--dark);padding:1rem 1.5rem}
        .summary-item .num{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--primary)}
        .summary-item .lbl{font-family:'Oswald',sans-serif;font-size:.8rem;color:#666}

        /* Loading */
        .loading{text-align:center;padding:3rem;color:#666}
        .loading .spinner{display:inline-block;width:40px;height:40px;border:4px solid var(--cream);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:1rem}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Legend */
        .legend{background:var(--cream);border:2px solid var(--dark);padding:1rem;margin-top:1.5rem;font-size:.85rem}
        .legend h4{font-family:'Oswald',sans-serif;color:var(--primary);margin-bottom:.5rem}
        .legend-grid{display:flex;flex-wrap:wrap;gap:1rem}

        /* Print */
        @media print{
            .page-header{margin-top:0}
            nav,.controls,.cat-tabs,.legend,.print-btn{display:none!important}
            .stats-table{font-size:.7rem}
            .stats-table th{background:#333!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
        }

        @media(max-width:768px){
            .controls{flex-direction:column}
            .control-group select,.control-group input{width:100%;min-width:auto}
            .podium-container{flex-direction:column;align-items:center}
            .podium-card{order:unset!important;min-height:auto!important;width:90%}
            .stats-table{font-size:.75rem}
            .stats-table th,.stats-table td{padding:.3rem}
        }

        /* Nav */
        nav{position:fixed;top:0;left:0;right:0;z-index:1000;background:var(--white);box-shadow:0 2px 20px rgba(0,0,0,.1)}
        nav .nav-container{max-width:1400px;margin:0 auto;padding:.75rem 2rem;display:flex;justify-content:space-between;align-items:center}
        .logo{display:flex;align-items:center;gap:.75rem;text-decoration:none}
        .logo img{height:55px}
        nav ul{display:flex;list-style:none;gap:.5rem}
        nav li{position:relative}
        nav a{text-decoration:none;color:var(--dark);font-weight:600;text-transform:uppercase;font-size:.85rem;padding:.5rem 1rem;display:block;transition:.3s}
        nav a:hover{color:var(--primary);background:var(--cream)}
        .dropdown-content{display:none;position:absolute;top:100%;left:0;background:var(--white);min-width:220px;box-shadow:0 8px 16px rgba(0,0,0,.1);border:2px solid var(--dark);z-index:1001}
        .dropdown-content a{padding:.75rem 1rem;border-bottom:1px solid var(--cream);font-size:.8rem}
        .dropdown:hover .dropdown-content{display:block}
        .dropdown>a::after{content:' \25BC';font-size:.6rem}
        .hamburger{display:none;font-size:2rem;cursor:pointer;padding:.5rem;color:var(--dark)}
        .dropdown.open .dropdown-content{display:block!important}
        @media(max-width:768px){
            .hamburger{display:block}
            nav ul{display:none;position:absolute;top:100%;left:0;right:0;background:var(--white);flex-direction:column;padding:1rem;box-shadow:0 8px 16px rgba(0,0,0,.1)}
            nav ul.open{display:flex}
            .dropdown-content{position:static;box-shadow:none;border:none;border-left:3px solid var(--primary);margin-left:1rem}
            .dropdown:hover .dropdown-content{display:none}
            .dropdown.open .dropdown-content{display:block}
        }

        /* Footer */
        footer{background:var(--dark);color:var(--white);padding:3rem 2rem}
        .footer-social{display:flex;gap:.5rem;flex-wrap:wrap}
        .social-link{display:inline-flex;align-items:center;gap:.5rem;background:rgba(255,255,255,.1);padding:.6rem 1.2rem;border-radius:5px;color:white;text-decoration:none;transition:.3s}
        .social-link:hover{background:var(--gold);color:var(--dark)}
        .footer-bottom{max-width:1400px;margin:1.5rem auto 0;padding-top:1.5rem;border-top:1px solid rgba(255,255,255,.2);text-align:center;opacity:.7;font-size:.85rem}
    </style>
</head>
<body>

<nav>
    <div class="nav-container">
        <a href="index.html" class="logo"><img src="logo-lbma.jpg" alt="LBMA"></a>
        <div class="hamburger" onclick="document.querySelector('nav ul').classList.toggle('open')">&#9776;</div>
        <ul>
            <li><a href="index.html">Accueil</a></li>
            <li><a href="equipes.html">Ã‰quipes</a></li>
            <li><a href="joueurs.html">Joueurs</a></li>
            <li><a href="calendrier.html">Calendrier</a></li>
            <li class="dropdown">
                <a href="#">Statistiques</a>
                <div class="dropdown-content">
                    <a href="classement-equipes.html">ğŸ† Classement</a>
                    <a href="stats-frappeurs.html">âš¾ Frappeurs</a>
                    <a href="stats-lanceurs.html">ğŸ¯ Lanceurs</a>
                    <a href="stats-series.html">ğŸ† SÃ©ries Ã‰liminatoires</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="#" style="color:var(--primary);font-weight:700">Archives</a>
                <div class="dropdown-content">
                    <a href="archives-frappeurs.html">ğŸ“Š Stats Frappeurs par AnnÃ©e</a>
                    <a href="frappeurs-carriere.html">â­ Frappeurs - CarriÃ¨re</a>
                    <a href="frappeurs-records.html">ğŸ† Frappeurs - Records</a>
                    <a href="archives-lanceurs.html">ğŸ“Š Stats Lanceurs par AnnÃ©e</a>
                    <a href="lanceurs-carriere.html">â­ Lanceurs - CarriÃ¨re</a>
                    <a href="lanceurs-records.html">ğŸ† Lanceurs - Records</a>
                    <a href="classement-equipes.html">ğŸ“ˆ Classements Historiques</a>
                    <a href="temple-renommee.html">ğŸ›ï¸ Temple de la RenommÃ©e</a>
                    <a href="archives.html">ğŸ“š Archives ComplÃ¨tes</a>
                </div>
            </li>
            <li><a href="contact.html">Direction</a></li>
            <li><a href="admin.html" style="color:var(--accent)">Admin</a></li>
        </ul>
    </div>
</nav>

<div class="page-header">
    <h1>â­ CarriÃ¨re des Frappeurs</h1>
    <p>Statistiques cumulatives de tous les joueurs â€¢ Depuis 1976 â€¢ Mise Ã  jour automatique</p>
</div>

<div class="container">
    <div class="summary-bar" id="summaryBar">
        <div class="summary-item"><div class="num" id="totalPlayers">â€”</div><div class="lbl">Joueurs</div></div>
        <div class="summary-item"><div class="num" id="activePlayers">â€”</div><div class="lbl">Actifs 2020+</div></div>
        <div class="summary-item"><div class="num" id="dataSource">â€”</div><div class="lbl">Source</div></div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <label>ğŸ” Recherche</label>
            <input type="text" id="searchInput" placeholder="Nom du joueur...">
        </div>
        <div class="control-group">
            <label>Minimum AB</label>
            <select id="minAB">
                <option value="0">Tous</option>
                <option value="50">50+ AB</option>
                <option value="100" selected>100+ AB</option>
                <option value="200">200+ AB</option>
                <option value="500">500+ AB</option>
            </select>
        </div>
        <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ RÃ©initialiser</button>
    </div>

    <!-- Category tabs -->
    <div class="cat-tabs" id="catTabs">
        <button class="cat-tab active" data-col="moy" data-dir="desc">MOY</button>
        <button class="cat-tab" data-col="cs" data-dir="desc">CS</button>
        <button class="cat-tab" data-col="ab" data-dir="desc">AB</button>
        <button class="cat-tab" data-col="pj" data-dir="desc">PJ</button>
        <button class="cat-tab" data-col="cc" data-dir="desc">CC</button>
        <button class="cat-tab" data-col="2b" data-dir="desc">2B</button>
        <button class="cat-tab" data-col="3b" data-dir="desc">3B</button>
        <button class="cat-tab" data-col="pc" data-dir="desc">PC</button>
        <button class="cat-tab" data-col="pp" data-dir="desc">PP</button>
        <button class="cat-tab" data-col="bb" data-dir="desc">BB</button>
    </div>

    <!-- Podium -->
    <div class="podium-container" id="podium"></div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Chargement des carriÃ¨res...</div>
    </div>

    <!-- Table -->
    <div class="table-wrap" id="tableWrap" style="display:none">
        <table class="stats-table">
            <thead><tr id="tableHead"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="legend">
        <h4>ğŸ“– LÃ©gende</h4>
        <div class="legend-grid">
            <span><strong>PJ</strong>=Parties jouÃ©es</span>
            <span><strong>AB</strong>=Au bÃ¢ton</span>
            <span><strong>CS</strong>=Coups sÃ»rs</span>
            <span><strong>1B</strong>=Simples</span>
            <span><strong>2B</strong>=Doubles</span>
            <span><strong>3B</strong>=Triples</span>
            <span><strong>CC</strong>=Circuits</span>
            <span><strong>PC</strong>=Points comptÃ©s</span>
            <span><strong>PP</strong>=Points produits</span>
            <span><strong>SAC</strong>=Sacrifices</span>
            <span><strong>BB</strong>=Buts/balles</span>
            <span><strong>RB</strong>=Retraits/bÃ¢ton</span>
            <span><strong>MOY</strong>=Moyenne</span>
            <span style="color:var(--accent)"><strong>NOUVEAU</strong>=Joueur ajoutÃ© par Supabase (2020+)</span>
        </div>
    </div>
</div>

<footer>
    <div class="footer-grid" style="max-width:1400px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:2rem">
        <div>
            <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
                <img src="logo-lbma.jpg" alt="LBMA" style="height:50px;background:white;padding:5px;border-radius:5px">
                <div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem">LBMA</div>
                    <div style="opacity:.7;font-size:.9rem">Depuis 1976</div>
                </div>
            </div>
            <div class="footer-social">
                <a href="https://www.facebook.com/groups/2400013274" target="_blank" class="social-link">ğŸ“˜ Facebook</a>
                <a href="https://www.marqueur.com/baseball/mbr/tools/blg/index.php?nyx=1154" target="_blank" class="social-link">ğŸ“Š Marqueur.com</a>
            </div>
        </div>
        <div>
            <h4 style="font-family:'Oswald',sans-serif;color:var(--gold);margin-bottom:1rem">ğŸ“š Archives</h4>
            <ul style="list-style:none">
                <li><a href="archives-frappeurs.html" style="color:white;text-decoration:none;display:block;padding:.25rem 0;opacity:.8">Stats Frappeurs par AnnÃ©e</a></li>
                <li><a href="frappeurs-carriere.html" style="color:white;text-decoration:none;display:block;padding:.25rem 0;opacity:.8">Frappeurs - CarriÃ¨re</a></li>
                <li><a href="archives-lanceurs.html" style="color:white;text-decoration:none;display:block;padding:.25rem 0;opacity:.8">Stats Lanceurs par AnnÃ©e</a></li>
                <li><a href="lanceurs-carriere.html" style="color:white;text-decoration:none;display:block;padding:.25rem 0;opacity:.8">Lanceurs - CarriÃ¨re</a></li>
            </ul>
        </div>
        <div>
            <h4 style="font-family:'Oswald',sans-serif;color:var(--gold);margin-bottom:1rem">âš¾ La Ligue</h4>
            <ul style="list-style:none">
                <li><a href="equipes.html" style="color:white;text-decoration:none;display:block;padding:.25rem 0;opacity:.8">Ã‰quipes 2026</a></li>
                <li><a href="calendrier.html" style="color:white;text-decoration:none;display:block;padding:.25rem 0;opacity:.8">Calendrier</a></li>
                <li><a href="reglements.html" style="color:white;text-decoration:none;display:block;padding:.25rem 0;opacity:.8">RÃ¨glements</a></li>
            </ul>
        </div>
    </div>
    <div class="footer-bottom">Â© 2026 Ligue de Balle Molle Amicale (LBMA) - Tous droits rÃ©servÃ©s</div>
</footer>

<script>
/*
 * CARRIÃˆRE FRAPPEURS â€” FUSION AUTOMATIQUE
 * ========================================
 * 1. Charge frappeurs-carriere.json (base historique, ~516 joueurs)
 * 2. Charge Supabase frappeurs_saison (2020+), cumule par joueur
 * 3. Fusionne : joueurs existants â†’ additionne stats Supabase
 *               nouveaux joueurs â†’ crÃ©e entrÃ©e carriÃ¨re
 * RÃ©sultat : chaque match finalisÃ© met Ã  jour les carriÃ¨res automatiquement
 */

const SUPABASE_URL = 'https://xgyskiatppgaeaamjhxr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXNraWF0cHBnYWVhYW1qaHhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTgxNTQsImV4cCI6MjA4NjA3NDE1NH0.67KCcUWlJij-scDoCUvZpkiCle5-mHVmy-inRk96Tac';

let allCareer = [];
let currentSort = { col: 'moy', dir: 'desc' };

// â”€â”€ Normalize name for matching â”€â”€
// JSON carriere: "MÃ‰NARD, JEAN-CLAUDE" â†’ "JEAN-CLAUDE MÃ‰NARD"
// Supabase: "Jean-Claude MÃ©nard" or "JEAN-CLAUDE MÃ‰NARD"
function normalizeName(nom) {
    if (!nom) return '';
    var n = nom.trim().toUpperCase();
    // Convert "LAST, FIRST" to "FIRST LAST"
    if (n.indexOf(',') > -1) {
        var parts = n.split(',');
        n = parts[1].trim() + ' ' + parts[0].trim();
    }
    // Remove accents for matching
    return n.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

// â”€â”€ Load and merge â”€â”€
async function init() {
    var jsonData = [];
    var supabaseByPlayer = {};
    var source = 'JSON seul';

    // 1. Load JSON career base
    try {
        var resp = await fetch('frappeurs-carriere.json');
        jsonData = await resp.json();
        console.log('âœ… JSON carriÃ¨re chargÃ©: ' + jsonData.length + ' joueurs');
    } catch (e) {
        console.error('Erreur JSON carriÃ¨re:', e);
    }

    // 2. Load Supabase frappeurs_saison (2020+)
    try {
        var url = SUPABASE_URL + '/rest/v1/frappeurs_saison?select=*&saison=gte.2020&limit=3000';
        var resp2 = await fetch(url, {
            headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                'Range': '0-2999'
            }
        });
        if (!resp2.ok) throw new Error('HTTP ' + resp2.status);
        var rows = await resp2.json();
        console.log('âœ… Supabase: ' + rows.length + ' lignes frappeurs (2020+)');

        // Cumulate by player
        rows.forEach(function(r) {
            var key = normalizeName(r.nom);
            if (!key) return;
            if (!supabaseByPlayer[key]) {
                supabaseByPlayer[key] = {
                    nom: r.nom, equipe: r.equipe || '',
                    pj: 0, ab: 0, cs: 0, '1b': 0, '2b': 0, '3b': 0,
                    cc: 0, pc: 0, pp: 0, sac: 0, bb: 0, rb: 0,
                    saisons: []
                };
            }
            var p = supabaseByPlayer[key];
            p.pj  += (r.pj || 0);
            p.ab  += (r.ab || 0);
            p.cs  += (r.cs || 0);
            p['1b'] += (r.simples || r['1b'] || 0);
            p['2b'] += (r.doubles || r['2b'] || 0);
            p['3b'] += (r.triples || r['3b'] || 0);
            p.cc  += (r.cc || 0);
            p.pc  += (r.pc || 0);
            p.pp  += (r.pp || 0);
            p.sac += (r.sac || 0);
            p.bb  += (r.bb || 0);
            p.rb  += (r.rb || 0);
            if (p.saisons.indexOf(r.saison) === -1) p.saisons.push(r.saison);
            // Keep most recent equipe
            if (!p._maxSaison || r.saison > p._maxSaison) {
                p._maxSaison = r.saison;
                p.equipe = r.equipe || p.equipe;
            }
        });
        source = 'JSON + Supabase';
    } catch (e) {
        console.warn('Supabase indisponible:', e.message);
    }

    // 3. Build merged career array
    var merged = {};
    var sbKeysUsed = {};

    // Start with JSON career data
    jsonData.forEach(function(j) {
        var key = normalizeName(j.nom);
        merged[key] = {
            nom: j.nom,
            pj: j.pj || 0, ab: j.ab || 0, cs: j.cs || 0,
            '1b': j['1b'] || 0, '2b': j['2b'] || 0, '3b': j['3b'] || 0,
            cc: j.cc || 0, pc: j.pc || 0, pp: j.pp || 0,
            sac: j.sac || 0, bb: j.bb || 0, rb: j.rb || 0,
            moy: j.moy || 0,
            _fromJson: true, _fromSupabase: false, _isActive: false
        };

        // Check if this player has Supabase data to add
        if (supabaseByPlayer[key]) {
            var sb = supabaseByPlayer[key];
            var m = merged[key];
            m.pj  += sb.pj;
            m.ab  += sb.ab;
            m.cs  += sb.cs;
            m['1b'] += sb['1b'];
            m['2b'] += sb['2b'];
            m['3b'] += sb['3b'];
            m.cc  += sb.cc;
            m.pc  += sb.pc;
            m.pp  += sb.pp;
            m.sac += sb.sac;
            m.bb  += sb.bb;
            m.rb  += sb.rb;
            m._fromSupabase = true;
            m._isActive = true;
            m.equipe = sb.equipe;
            // Recalculate average
            m.moy = m.ab > 0 ? m.cs / m.ab : 0;
            sbKeysUsed[key] = true;
        }
    });

    // Add Supabase-only players (new since 2020, not in JSON)
    Object.keys(supabaseByPlayer).forEach(function(key) {
        if (!sbKeysUsed[key] && !merged[key]) {
            var sb = supabaseByPlayer[key];
            merged[key] = {
                nom: sb.nom,
                equipe: sb.equipe,
                pj: sb.pj, ab: sb.ab, cs: sb.cs,
                '1b': sb['1b'], '2b': sb['2b'], '3b': sb['3b'],
                cc: sb.cc, pc: sb.pc, pp: sb.pp,
                sac: sb.sac, bb: sb.bb, rb: sb.rb,
                moy: sb.ab > 0 ? sb.cs / sb.ab : 0,
                _fromJson: false, _fromSupabase: true, _isActive: true
            };
        }
    });

    // Convert to array
    allCareer = Object.values(merged);

    // Update summary
    document.getElementById('totalPlayers').textContent = allCareer.length;
    document.getElementById('activePlayers').textContent = allCareer.filter(function(p){ return p._isActive; }).length;
    document.getElementById('dataSource').textContent = source;

    document.getElementById('loading').style.display = 'none';
    document.getElementById('tableWrap').style.display = 'block';

    renderAll();
}

// â”€â”€ Get filtered data â”€â”€
function getFiltered() {
    var data = allCareer.slice();
    var q = document.getElementById('searchInput').value.toLowerCase().trim();
    if (q) data = data.filter(function(p) { return p.nom.toLowerCase().indexOf(q) >= 0; });
    var minAB = parseInt(document.getElementById('minAB').value) || 0;
    if (minAB > 0) data = data.filter(function(p) { return p.ab >= minAB; });
    return data;
}

// â”€â”€ Render all â”€â”€
function renderAll() {
    var tab = document.querySelector('.cat-tab.active');
    var col = tab.dataset.col;
    var dir = tab.dataset.dir;
    currentSort = { col: col, dir: dir };
    renderPodium(col, dir);
    renderTable(col);
}

// â”€â”€ Podium â”€â”€
function renderPodium(col, dir) {
    var data = getFiltered();
    // For MOY podium, require min 100 AB
    if (col === 'moy') data = data.filter(function(p) { return p.ab >= 100; });
    data.sort(function(a, b) { return dir === 'desc' ? (b[col]||0) - (a[col]||0) : (a[col]||0) - (b[col]||0); });

    var top3 = data.slice(0, 3);
    var medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    var labels = {moy:'MOY',cs:'CS',ab:'AB',pj:'PJ',cc:'CC','2b':'2B','3b':'3B',pc:'PC',pp:'PP',bb:'BB'};

    document.getElementById('podium').innerHTML = top3.map(function(p, i) {
        var val = col === 'moy' ? p.moy.toFixed(3) : (p[col] || 0);
        var displayName = p.nom;
        return '<div class="podium-card podium-' + (i+1) + '">' +
            '<div class="podium-rank">' + medals[i] + '</div>' +
            '<div class="podium-name">' + displayName + '</div>' +
            '<div class="podium-stat">' + val + '</div>' +
            '<div class="podium-label">' + (labels[col]||col) + (p.equipe ? ' Â· ' + p.equipe : '') + '</div>' +
        '</div>';
    }).join('');
}

// â”€â”€ Table â”€â”€
var COLS = [
    {key:'pj',  label:'PJ'},
    {key:'ab',  label:'AB'},
    {key:'cs',  label:'CS'},
    {key:'1b',  label:'1B'},
    {key:'2b',  label:'2B'},
    {key:'3b',  label:'3B'},
    {key:'cc',  label:'CC'},
    {key:'pc',  label:'PC'},
    {key:'pp',  label:'PP'},
    {key:'sac', label:'SAC'},
    {key:'bb',  label:'BB'},
    {key:'rb',  label:'RB'},
    {key:'moy', label:'MOY'}
];

function renderTable(highlightCol) {
    var data = getFiltered();
    data.sort(function(a, b) {
        var va = a[currentSort.col] || 0;
        var vb = b[currentSort.col] || 0;
        return currentSort.dir === 'desc' ? vb - va : va - vb;
    });

    // Header
    var headHtml = '<th>#</th><th onclick="sortBy(\'nom\')" class="' + (currentSort.col==='nom'?'sort-'+currentSort.dir:'') + '" style="text-align:left">Joueur</th>';
    COLS.forEach(function(c) {
        headHtml += '<th onclick="sortBy(\'' + c.key + '\')" class="' + (currentSort.col===c.key?'sort-'+currentSort.dir:'') + '">' + c.label + '</th>';
    });
    document.getElementById('tableHead').innerHTML = headHtml;

    // Body
    var bodyHtml = '';
    data.forEach(function(p, i) {
        var isTop10 = i < 10;
        var badge = (!p._fromJson && p._fromSupabase) ? '<span class="new-badge">NOUVEAU</span>' : '';
        bodyHtml += '<tr class="' + (isTop10 ? 'highlight' : '') + '">';
        bodyHtml += '<td>' + (i+1) + '</td>';
        bodyHtml += '<td class="player-name">' + p.nom + badge + '</td>';
        COLS.forEach(function(c) {
            var val = c.key === 'moy' ? (p.ab > 0 ? (p.cs / p.ab).toFixed(3) : '.000') : (p[c.key] || 0);
            var hl = c.key === highlightCol ? ' style="font-weight:700;color:var(--primary)"' : '';
            bodyHtml += '<td' + hl + '>' + val + '</td>';
        });
        bodyHtml += '</tr>';
    });
    document.getElementById('tableBody').innerHTML = bodyHtml;
}

function sortBy(col) {
    if (currentSort.col === col) {
        currentSort.dir = currentSort.dir === 'desc' ? 'asc' : 'desc';
    } else {
        currentSort.col = col;
        currentSort.dir = col === 'nom' ? 'asc' : 'desc';
    }
    renderTable(document.querySelector('.cat-tab.active').dataset.col);
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('minAB').value = '100';
    renderAll();
}

// Tab clicks
document.querySelectorAll('.cat-tab').forEach(function(t) {
    t.addEventListener('click', function() {
        document.querySelectorAll('.cat-tab').forEach(function(x) { x.classList.remove('active'); });
        t.classList.add('active');
        renderAll();
    });
});
document.getElementById('searchInput').addEventListener('input', renderAll);
document.getElementById('minAB').addEventListener('change', renderAll);

// â”€â”€ Mobile nav â”€â”€
(function() {
    var isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    document.querySelectorAll('nav .dropdown > a').forEach(function(a) {
        a.addEventListener('click', function(e) {
            if (isTouch || window.innerWidth <= 768) {
                e.preventDefault();
                var parent = this.parentElement;
                document.querySelectorAll('nav .dropdown').forEach(function(d) { if (d !== parent) d.classList.remove('open'); });
                parent.classList.toggle('open');
            }
        });
    });
    document.addEventListener('click', function(e) {
        if (!e.target.closest('nav')) {
            var ul = document.querySelector('nav ul'); if (ul) ul.classList.remove('open');
            document.querySelectorAll('nav .dropdown').forEach(function(d) { d.classList.remove('open'); });
        }
    });
})();

// GO
init();
</script>
<script src="lbma-analytics.js"></script>
</body>
</html>
