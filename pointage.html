<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feuille de pointage - LBMA 2026</title>
    <link rel="icon" type="image/jpeg" href="logo-lbma.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1E3A5F;--accent:#CC0000;--gold:#D4AF37;--white:#FDFBF7;--cream:#F5F1E8;--dark:#1A1A1A;--success:#28a745;--danger:#dc3545;--warning:#ffc107}
        body{font-family:'Work Sans',sans-serif;background:var(--cream);color:var(--dark);min-height:100vh}
        .topbar{background:var(--dark);color:var(--white);padding:.6rem 1.5rem;display:flex;justify-content:space-between;align-items:center;font-family:'Oswald',sans-serif;font-size:.85rem;text-transform:uppercase;letter-spacing:.05em}
        .topbar a{color:var(--gold);text-decoration:none}.topbar a:hover{text-decoration:underline}
        .match-header{background:var(--primary);color:var(--white);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid var(--gold)}
        .match-header h1{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:.05em}
        .match-header .match-info{font-family:'Oswald',sans-serif;font-size:.9rem;text-align:right}
        .status-live{background:var(--accent);padding:.2rem .6rem;animation:pulse 1.5s infinite;display:inline-block;margin-top:.3rem}
        .status-final{background:var(--success);padding:.2rem .6rem;display:inline-block;margin-top:.3rem}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
        .linescore-wrap{padding:1rem 1.5rem;background:var(--white);border-bottom:2px solid var(--dark)}
        .linescore{width:100%;border-collapse:collapse;font-family:'Oswald',sans-serif;font-size:.9rem}
        .linescore th,.linescore td{border:1px solid #ccc;padding:.4rem .5rem;text-align:center;min-width:32px}
        .linescore thead th{background:var(--dark);color:var(--white);font-weight:600;font-size:.75rem}
        .linescore .team-row td:first-child{text-align:left;font-weight:700;padding-left:.75rem;min-width:120px;font-size:1rem}
        .linescore .total-col{background:var(--cream);font-weight:700;font-size:1rem;min-width:40px}
        .linescore input[type="number"]{width:32px;border:none;text-align:center;font-family:'Oswald',sans-serif;font-size:.9rem;background:transparent;padding:0;-moz-appearance:textfield}
        .linescore input::-webkit-outer-spin-button,.linescore input::-webkit-inner-spin-button{-webkit-appearance:none}
        .linescore input:focus{background:rgba(212,175,55,.2);outline:2px solid var(--gold)}
        .team-sheet{margin:1rem 1.5rem;border:2px solid var(--dark);background:var(--white);overflow-x:auto}
        .team-sheet-header{padding:.75rem 1rem;color:var(--white);font-family:'Bebas Neue',sans-serif;font-size:1.4rem;display:flex;justify-content:space-between;align-items:center;letter-spacing:.05em}
        .team-sheet-header .logo-ph{width:40px;height:40px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .section-sub{padding:.4rem .75rem;color:var(--white);font-family:'Oswald',sans-serif;font-size:.8rem;text-transform:uppercase;letter-spacing:.08em}
        .section-sub.frappeurs{background:var(--primary)}
        .section-sub.banc{background:#6c757d}
        .section-sub.lanceurs{background:var(--accent)}
        .st{width:100%;border-collapse:collapse;font-size:.8rem}
        .st th{background:var(--cream);border:1px solid #ccc;padding:.4rem .3rem;font-family:'Oswald',sans-serif;font-size:.7rem;text-transform:uppercase;color:var(--primary)}
        .st td{border:1px solid #ddd;padding:.3rem .2rem;text-align:center}
        .st .c-ord{min-width:25px;font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--primary);font-weight:700}
        .st .c-j{text-align:left;padding-left:.5rem;min-width:150px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
        .st .c-j select{width:100%;border:none;font-weight:600;font-size:.78rem;background:transparent;padding:.2rem 0;font-family:'Work Sans',sans-serif;cursor:pointer}
        .st .c-j select:focus{outline:2px solid var(--gold);background:rgba(212,175,55,.1)}
        .st .c-j select optgroup{font-weight:700;font-size:.75rem;color:var(--primary)}
        .st .c-j select option{font-weight:400;font-size:.8rem;padding:.15rem}
        .st .c-j select option.opt-autre{font-style:italic;color:var(--accent);font-weight:600}
        .st .c-j .manual-name{font-weight:600;font-size:.8rem;padding:.2rem .3rem;display:flex;align-items:center;gap:.3rem}
        .st .c-j .manual-name .edit-btn{font-size:.65rem;cursor:pointer;color:var(--accent);background:none;border:1px solid var(--accent);padding:0 .3rem;font-family:'Oswald',sans-serif}
        .st .c-pos{min-width:40px;font-family:'Oswald',sans-serif;font-size:.75rem;color:#666}
        .st .c-m{min-width:28px;background:rgba(30,58,95,.03)}
        .st .c-s{min-width:32px;font-weight:600;background:var(--cream)}
        .st .c-m input,.st .c-s input{width:100%;border:none;text-align:center;font-size:.8rem;font-family:'Work Sans',sans-serif;background:transparent;padding:.2rem 0;-moz-appearance:textfield}
        .st .c-m input::-webkit-outer-spin-button,.st .c-m input::-webkit-inner-spin-button,.st .c-s input::-webkit-outer-spin-button,.st .c-s input::-webkit-inner-spin-button{-webkit-appearance:none}
        .st input:focus{background:rgba(212,175,55,.25);outline:2px solid var(--gold)}
        .st .c-pos select,.st .c-role select{border:none;background:transparent;font-family:'Oswald',sans-serif;padding:0;text-align:center}
        .st .c-pos select{font-size:.75rem;width:45px}
        .st .c-role select{font-size:.7rem;width:42px;font-weight:700}
        .st .c-role select.r-DEF{color:var(--primary)}.st .c-role select.r-OFF{color:var(--success)}.st .c-role select.r-ABS{color:#999}.st .c-role select.r-BL{color:var(--danger)}
        .st tr:hover{background:rgba(30,58,95,.04)}
        .st tr.row-banc{background:rgba(108,117,125,.06)}
        .lanceurs-wrap{border-top:3px solid var(--dark)}
        .lanceurs-wrap .st th{background:#e8e0d0}
        .actions{padding:1rem 1.5rem;display:flex;gap:.75rem;flex-wrap:wrap;justify-content:center;background:var(--cream);border-top:2px solid var(--dark);position:sticky;bottom:0;z-index:10}
        .btn{padding:.65rem 1.5rem;font-family:'Oswald',sans-serif;border:2px solid var(--dark);cursor:pointer;transition:.2s;text-transform:uppercase;font-size:.9rem;letter-spacing:.03em}
        .btn:hover{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,.2)}
        .btn-save{background:var(--success);color:white;border-color:var(--success)}
        .btn-final{background:var(--gold);color:var(--dark);border-color:var(--dark)}
        .btn-reset{background:var(--danger);color:white;border-color:var(--danger)}
        .btn-back{background:var(--white);color:var(--dark)}
        .btn-print{background:var(--primary);color:var(--white);border-color:var(--primary)}
        body.readonly .st input,body.readonly .st select,body.readonly .linescore input{pointer-events:none;background:transparent!important}
        body.readonly .btn-save,body.readonly .btn-final,body.readonly .btn-reset{display:none}
        .toast{position:fixed;top:20px;right:20px;padding:.75rem 1.5rem;color:white;font-family:'Oswald',sans-serif;z-index:9999;animation:slideIn .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.3)}
        .toast-success{background:var(--success)}.toast-danger{background:var(--danger)}.toast-warning{background:var(--warning);color:var(--dark)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .loading{text-align:center;padding:3rem;font-family:'Oswald',sans-serif;font-size:1.2rem;color:var(--primary)}
        .loading::after{content:'';display:inline-block;width:20px;height:20px;border:3px solid var(--gold);border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite;margin-left:.5rem;vertical-align:middle}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media print{.topbar,.actions{display:none!important}.team-sheet{margin:.5rem 0;break-inside:avoid}body{background:white}}
        @media(max-width:768px){.match-header{flex-direction:column;text-align:center;gap:.5rem}.team-sheet{margin:.5rem}.st{font-size:.7rem}.st .c-j{min-width:100px;max-width:120px}}
    </style>
</head>
<body>
<div id="app"><div class="loading">Chargement...</div></div>
<script>
var SB='https://xgyskiatppgaeaamjhxr.supabase.co',SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXNraWF0cHBnYWVhYW1qaHhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTgxNTQsImV4cCI6MjA4NjA3NDE1NH0.67KCcUWlJij-scDoCUvZpkiCle5-mHVmy-inRk96Tac';
var SAI='2026',NM=10,NF=9,NB=4;
var POS=['','L','R','1B','2B','3B','AC','CC','CG','CD','VD','JD','RE'];
var ROLES=['DEF','OFF','ABS','BL'];
var TC={AIGLES:'#FF8001',CONDORS:'#124FB2',DUCS:'#006400',FAUCONS:'#CC0000',HARFANGS:'#555555',VAUTOURS:'#DAA520'};
var TN={AIGLES:'Aigles',CONDORS:'Condors',DUCS:'Ducs',FAUCONS:'Faucons',HARFANGS:'Harfangs',VAUTOURS:'Vautours'};

/* Liste des joueurs chargée depuis Supabase (joueurs_liste) */
var ALL_JOUEURS = []; // [{nom:'NOM, PRENOM', ...}, ...]

/* --- Supabase --- */
function sbF(p){return fetch(SB+'/rest/v1/'+p,{headers:{'apikey':SK,'Authorization':'Bearer '+SK}}).then(function(r){return r.json();}).then(function(d){return Array.isArray(d)?d:[];}).catch(function(){return[];})}
function sbU(t,d){return fetch(SB+'/rest/v1/'+t,{method:'POST',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json','Prefer':'resolution=merge-duplicates,return=representation'},body:JSON.stringify(d)}).then(function(r){return r.json();})}
function sbD(t,q){return fetch(SB+'/rest/v1/'+t+'?'+q,{method:'DELETE',headers:{'apikey':SK,'Authorization':'Bearer '+SK}})}
function sbP(t,q,d){return fetch(SB+'/rest/v1/'+t+'?'+q,{method:'PATCH',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json','Prefer':'return=representation'},body:JSON.stringify(d)}).then(function(r){return r.json();})}

/* --- State --- */
var mid=null,md=null,adm=false;
var manD={visiteur:{},local:{}};
var fraD={visiteur:[],local:[]};
var banD={visiteur:[],local:[]};
var lanD={visiteur:[],local:[]};

function mkF(n){return{joueur:n||'',pos:'',role:'',m1:'',m2:'',m3:'',m4:'',m5:'',m6:'',m7:'',m8:'',m9:'',m10:'',ab:0,cs:0,b1:0,b2:0,b3:0,cc:0,pc:0,pp:0,bb:0,k:0,sac:0,e:0}}
function mkB(n,rl){var o=mkF(n);o.role=rl||'DEF';return o;}

/* Helper: build joueur <select> depuis la liste Supabase */
function jSel(curVal,onchangeStr){
    var isKnown=false;
    ALL_JOUEURS.forEach(function(j){if(j.nom===curVal)isKnown=true;});

    var h='<select '+onchangeStr+'>';
    h+='<option value=""'+(!curVal?' selected':'')+'>\u2014 Choisir \u2014</option>';

    // Tous les joueurs de la saison, triés alphabétiquement
    h+='<optgroup label="\u26be JOUEURS SAISON '+SAI+'">';
    ALL_JOUEURS.forEach(function(j){
        var sel=(j.nom===curVal)?' selected':'';
        h+='<option value="'+esc(j.nom)+'"'+sel+'>'+esc(j.nom)+'</option>';
    });
    h+='</optgroup>';

    // Option "Autre" pour saisie manuelle
    h+='<optgroup label="\u270f\ufe0f AUTRE">';
    if(curVal && !isKnown){
        h+='<option value="'+esc(curVal)+'" selected>\u2705 '+esc(curVal)+'</option>';
    }
    h+='<option value="__AUTRE__" class="opt-autre">+ Ajouter un joueur...</option>';
    h+='</optgroup></select>';
    return h;
}

/* Handler quand "Autre..." est choisi */
function jAutre(selectEl,section,side,idx){
    var v=selectEl.value;
    if(v==='__AUTRE__'){
        var nom=prompt('Entrez le nom du joueur (Nom, Pr\u00e9nom):');
        if(nom&&nom.trim()){
            nom=nom.trim();
            // Update data
            if(section==='fra')fraD[side][idx].joueur=nom;
            else if(section==='ban')banD[side][idx].joueur=nom;
            else if(section==='lan')lanD[side][idx].joueur=nom;
            render(); // Re-render to show the manual name
        }else{
            // Cancelled - reset to previous value
            var prev='';
            if(section==='fra')prev=fraD[side][idx].joueur;
            else if(section==='ban')prev=banD[side][idx].joueur;
            else if(section==='lan')prev=lanD[side][idx].joueur;
            selectEl.value=prev;
        }
    }else{
        // Normal selection
        if(section==='fra'){fraD[side][idx].joueur=v;uF(side,idx,'joueur',v);}
        else if(section==='ban'){banD[side][idx].joueur=v;uB(side,idx,'joueur',v);}
        else if(section==='lan'){lanD[side][idx].joueur=v;uL(side,idx,'joueur',v);}
    }
}

/* --- Init --- */
function init(){
    var p=new URLSearchParams(location.search);
    mid=p.get('id');adm=p.get('admin')==='1';
    if(!mid){document.getElementById('app').innerHTML='<div class="loading" style="color:var(--accent)">Aucun match. <a href="calendrier.html">Retour</a></div>';return;}
    if(!adm)document.body.classList.add('readonly');
    load();
}

async function load(){
    try{
        // 1. Charger la liste des joueurs depuis Supabase
        var joueursRes = await sbF('joueurs_liste?saison=eq.'+SAI+'&order=nom.asc&select=nom,role');
        ALL_JOUEURS = Array.isArray(joueursRes) ? joueursRes : [];

        // 2. Charger le match
        var ms=await sbF('matchs_regulier?id=eq.'+mid);
        if(!ms||ms.length===0)ms=await sbF('matchs_series?id=eq.'+mid);
        if(!ms||ms.length===0){document.getElementById('app').innerHTML='<div class="loading" style="color:var(--accent)">Match introuvable. <a href="calendrier.html">Retour</a></div>';return;}
        md=ms[0];

        // 3. Charger les données de pointage existantes
        var fr=await sbF('pointage_frappeurs?match_id=eq.'+mid+'&order=ordre.asc');
        var la=await sbF('pointage_lanceurs?match_id=eq.'+mid+'&order=ordre.asc');
        var ma=await sbF('pointage_manches?match_id=eq.'+mid);
        if(!Array.isArray(fr))fr=[];
        if(!Array.isArray(la))la=[];
        if(!Array.isArray(ma))ma=[];
        initD(fr,la,ma);render();
    }catch(e){
        console.error(e);
        document.getElementById('app').innerHTML='<div class="loading" style="color:var(--accent)">Erreur. Tables de pointage cr\u00e9\u00e9es?<br><small>'+e.message+'</small><br><a href="calendrier.html">Retour</a></div>';
    }
}

function initD(fr,la,ma){
    manD={visiteur:{},local:{}};
    if(ma&&!ma.error)ma.forEach(function(m){var s=m.equipe===md.visiteur?'visiteur':'local';manD[s][m.manche]=m.points||0;});

    ['visiteur','local'].forEach(function(side){
        var tm=md[side],ex=(fr&&!fr.error)?fr.filter(function(f){return f.equipe===tm;}):[];
        if(ex.length>0){
            var fL=[],bL=[];
            ex.forEach(function(f){
                var o={joueur:f.joueur,pos:f.pos||'',role:f.role||'',
                    m1:f.m1||'',m2:f.m2||'',m3:f.m3||'',m4:f.m4||'',m5:f.m5||'',
                    m6:f.m6||'',m7:f.m7||'',m8:f.m8||'',m9:f.m9||'',m10:f.m10||'',
                    ab:f.ab||0,cs:f.h||0,b1:f.b1||0,b2:f.b2||0,b3:f.b3||0,cc:f.cc||0,pc:f.r||0,pp:f.rbi||0,bb:f.bb||0,k:f.k||0,sac:f.sac||0,e:f.e||0};
                if(f.role&&ROLES.indexOf(f.role)!==-1)bL.push(o);else fL.push(o);
            });
            while(fL.length<NF)fL.push(mkF(''));
            fraD[side]=fL.slice(0,NF);
            while(bL.length<NB)bL.push(mkB(''));
            banD[side]=bL;
        }else{
            fraD[side]=[];for(var i=0;i<NF;i++)fraD[side].push(mkF(''));
            banD[side]=[];
            for(var j=0;j<NB;j++)banD[side].push(mkB('',j<2?'DEF':'OFF'));
        }
    });

    ['visiteur','local'].forEach(function(side){
        var tm=md[side],ex=(la&&!la.error)?la.filter(function(l){return l.equipe===tm;}):[];
        if(ex.length>0){lanD[side]=ex.map(function(l){return{joueur:l.joueur,ip:l.ip||0,h:l.h||0,r:l.r||0,er:l.er||0,bb:l.bb||0,k:l.k||0};});}
        else{lanD[side]=[{joueur:'',ip:0,h:0,r:0,er:0,bb:0,k:0},{joueur:'',ip:0,h:0,r:0,er:0,bb:0,k:0}];}
    });
}

/* --- Totals --- */
function calcT(side){
    var r=0,h=0,e=0;
    fraD[side].forEach(function(f){r+=(parseInt(f.pc)||0);h+=(parseInt(f.cs)||0);e+=(parseInt(f.e)||0);});
    banD[side].forEach(function(b){
        if(b.role==='OFF'){r+=(parseInt(b.pc)||0);h+=(parseInt(b.cs)||0);}
        if(b.role==='DEF'||b.role==='OFF')e+=(parseInt(b.e)||0);
    });
    return{r:r,h:h,e:e};
}

/* --- Render --- */
function render(){
    var d=md,ds=fmtD(d.date);
    var sLbl=d.status==='final'?'FINAL':(d.status==='en_cours'?'\uD83D\uDD34 EN DIRECT':'\u00c0 VENIR');
    var sCls=d.status==='final'?'status-final':(d.status==='en_cours'?'status-live':'');

    var h='';
    h+='<div class="topbar"><a href="calendrier.html">\u2190 CALENDRIER</a><span>LBMA '+SAI+'</span><span>'+(d.endroit||'')+'</span></div>';
    h+='<div class="match-header"><h1>\u26be FEUILLE DE POINTAGE</h1><div class="match-info"><div>'+ds+' \u2014 '+(d.heure||'')+'</div>';
    if(sCls)h+='<span class="'+sCls+'">'+sLbl+'</span>';
    h+='</div></div>';
    h+=rLS();
    h+=rTS('visiteur');
    h+=rTS('local');
    h+='<div class="actions">';
    h+='<button class="btn btn-back" onclick="location.href=\'calendrier.html\'">\u2190 Calendrier</button>';
    h+='<button class="btn btn-print" onclick="window.print()">\uD83D\uDDA8 Imprimer</button>';
    h+='<button class="btn btn-save" onclick="saveAll()">\uD83D\uDCBE Sauvegarder</button>';
    h+='<button class="btn btn-final" onclick="finaliser()">\uD83C\uDFC1 Finaliser</button>';
    h+='<button class="btn btn-reset" onclick="resetAll()">\uD83D\uDDD1 R\u00e9initialiser</button>';
    h+='</div>';
    document.getElementById('app').innerHTML=h;
}

function rLS(){
    var h='<div class="linescore-wrap"><table class="linescore"><thead><tr><th style="text-align:left;min-width:120px">\u00c9QUIPE</th>';
    for(var i=1;i<=NM;i++)h+='<th>'+i+'</th>';
    h+='<th class="total-col">R</th><th class="total-col">H</th><th class="total-col">E</th></tr></thead><tbody>';
    ['visiteur','local'].forEach(function(s){
        var tm=md[s],c=TC[tm]||'#333';
        h+='<tr class="team-row"><td style="color:'+c+'">'+(TN[tm]||tm).toUpperCase()+'</td>';
        for(var i=1;i<=NM;i++){
            var v=manD[s][i]!==undefined?manD[s][i]:'';
            h+='<td><input type="number" min="0" max="99" value="'+v+'" onchange="uM(\''+s+'\','+i+',this.value)" onfocus="this.select()"></td>';
        }
        var t=calcT(s);
        h+='<td class="total-col" id="lr-'+s+'">'+t.r+'</td><td class="total-col" id="lh-'+s+'">'+t.h+'</td><td class="total-col" id="le-'+s+'">'+t.e+'</td></tr>';
    });
    h+='</tbody></table></div>';return h;
}

function rTS(side){
    var tm=md[side],c=TC[tm]||'#333';
    var tx=(tm==='VAUTOURS'||tm==='HARFANGS')?'var(--dark)':'var(--white)';
    var h='<div class="team-sheet">';
    h+='<div class="team-sheet-header" style="background:'+c+';color:'+tx+'"><span>'+(TN[tm]||tm).toUpperCase()+'</span><div class="logo-ph">\u26be</div></div>';

    // === FRAPPEURS 1-9 ===
    h+='<div class="section-sub frappeurs">\u26be ALIGNEMENT DES FRAPPEURS (1-9)</div>';
    h+='<table class="st"><thead><tr><th style="min-width:25px">#</th><th style="text-align:left;padding-left:.5rem;min-width:150px">JOUEURS</th><th style="min-width:45px">POS</th>';
    for(var i=1;i<=NM;i++)h+='<th>'+i+'</th>';
    h+='<th>AB</th><th>CS</th><th>1B</th><th>2B</th><th>3B</th><th>CC</th><th>PC</th><th>PP</th><th>BB</th><th>K</th><th>SAC</th><th>E</th></tr></thead><tbody>';

    fraD[side].forEach(function(f,idx){
        h+='<tr>';
        h+='<td class="c-ord">'+(idx+1)+'</td>';
        h+='<td class="c-j">'+jSel(f.joueur,'onchange="jAutre(this,\'fra\',\''+side+'\','+idx+')"')+'</td>';
        h+='<td class="c-pos"><select onchange="uF(\''+side+'\','+idx+',\'pos\',this.value)">';
        POS.forEach(function(p){h+='<option'+(f.pos===p?' selected':'')+'>'+p+'</option>';});
        h+='</select></td>';
        for(var m=1;m<=NM;m++){
            h+='<td class="c-m"><input type="text" value="'+esc(f['m'+m]||'')+'" onchange="uF(\''+side+'\','+idx+',\'m'+m+'\',this.value)" onfocus="this.select()" maxlength="4" style="width:28px"></td>';
        }
        ['ab','cs','b1','b2','b3','cc','pc','pp','bb','k','sac','e'].forEach(function(st){
            h+='<td class="c-s"><input type="number" min="0" value="'+(f[st]||0)+'" onchange="uF(\''+side+'\','+idx+',\''+st+'\',this.value)" onfocus="this.select()"></td>';
        });
        h+='</tr>';
    });
    h+='</tbody></table>';

    // === BANC / SUBSTITUTS ===
    h+='<div class="section-sub banc">\uD83D\uDC65 BANC / SUBSTITUTS</div>';
    h+='<table class="st"><thead><tr><th style="min-width:42px">R\u00d4LE</th><th style="text-align:left;padding-left:.5rem;min-width:150px">JOUEURS</th><th style="min-width:45px">POS</th>';
    for(var i=1;i<=NM;i++)h+='<th>'+i+'</th>';
    h+='<th>AB</th><th>CS</th><th>1B</th><th>2B</th><th>3B</th><th>CC</th><th>PC</th><th>PP</th><th>BB</th><th>K</th><th>SAC</th><th>E</th></tr></thead><tbody>';

    banD[side].forEach(function(b,idx){
        var isOFF=b.role==='OFF',isDEF=b.role==='DEF',isOut=b.role==='ABS'||b.role==='BL';
        h+='<tr class="row-banc">';
        // Role
        h+='<td class="c-role"><select class="r-'+(b.role||'DEF')+'" onchange="uB(\''+side+'\','+idx+',\'role\',this.value);this.className=\'r-\'+this.value">';
        ROLES.forEach(function(r){h+='<option value="'+r+'"'+(b.role===r?' selected':'')+'>'+r+'</option>';});
        h+='</select></td>';
        // Joueur
        h+='<td class="c-j"'+(isOut?' style="opacity:.4"':'')+'>'+jSel(b.joueur,'onchange="jAutre(this,\'ban\',\''+side+'\','+idx+')"')+'</td>';
        // Position
        h+='<td class="c-pos"><select onchange="uB(\''+side+'\','+idx+',\'pos\',this.value)"'+(isOut?' disabled':'')+'>';
        POS.forEach(function(p){h+='<option'+(b.pos===p?' selected':'')+'>'+p+'</option>';});
        h+='</select></td>';
        // Manches
        for(var m=1;m<=NM;m++){
            if(isOut||isDEF){
                h+='<td class="c-m" style="opacity:'+(isOut?'.1':'.2')+'">\u2014</td>';
            }else{
                h+='<td class="c-m"><input type="text" value="'+esc(b['m'+m]||'')+'" onchange="uB(\''+side+'\','+idx+',\'m'+m+'\',this.value)" onfocus="this.select()" maxlength="4" style="width:28px"></td>';
            }
        }
        // Stats
        if(isOut){
            for(var s=0;s<12;s++)h+='<td class="c-s" style="opacity:.1">\u2014</td>';
        }else if(isDEF){
            // DEF: seulement E
            for(var s=0;s<11;s++)h+='<td class="c-s" style="opacity:.2">\u2014</td>';
            h+='<td class="c-s"><input type="number" min="0" value="'+(b.e||0)+'" onchange="uB(\''+side+'\','+idx+',\'e\',this.value)" onfocus="this.select()"></td>';
        }else{
            // OFF: toutes les stats
            ['ab','cs','b1','b2','b3','cc','pc','pp','bb','k','sac','e'].forEach(function(st){
                h+='<td class="c-s"><input type="number" min="0" value="'+(b[st]||0)+'" onchange="uB(\''+side+'\','+idx+',\''+st+'\',this.value)" onfocus="this.select()"></td>';
            });
        }
        h+='</tr>';
    });
    h+='</tbody></table>';

    // === LANCEURS ===
    h+='<div class="lanceurs-wrap"><div class="section-sub lanceurs">\uD83C\uDFAF LANCEURS</div>';
    h+='<table class="st"><thead><tr><th style="text-align:left;padding-left:.5rem;min-width:150px">LANCEURS</th>';
    h+='<th>IP</th><th>H</th><th>R</th><th>ER</th><th>BB</th><th>K</th></tr></thead><tbody>';
    lanD[side].forEach(function(l,idx){
        h+='<tr><td class="c-j">'+jSel(l.joueur,'onchange="jAutre(this,\'lan\',\''+side+'\','+idx+')"')+'</td>';
        ['ip','h','r','er','bb','k'].forEach(function(st){
            h+='<td class="c-s"><input type="number" min="0" step="'+(st==='ip'?'0.1':'1')+'" value="'+(l[st]||0)+'" onchange="uL(\''+side+'\','+idx+',\''+st+'\',this.value)" onfocus="this.select()"></td>';
        });
        h+='</tr>';
    });
    h+='</tbody></table></div></div>';
    return h;
}

/* --- Update handlers --- */
function uM(s,m,v){manD[s][m]=parseInt(v)||0;rT();}
function uF(s,i,f,v){if(f==='joueur'||f==='pos'||f[0]==='m')fraD[s][i][f]=v;else fraD[s][i][f]=parseInt(v)||0;if(f==='b1'||f==='b2'||f==='b3'||f==='cc')fraD[s][i].cs=fraD[s][i].b1+fraD[s][i].b2+fraD[s][i].b3+fraD[s][i].cc;rT();render();}
function uB(s,i,f,v){
    if(f==='joueur'||f==='pos'||f==='role'||f[0]==='m')banD[s][i][f]=v;else banD[s][i][f]=parseInt(v)||0;
    if(f==='b1'||f==='b2'||f==='b3'||f==='cc')banD[s][i].cs=banD[s][i].b1+banD[s][i].b2+banD[s][i].b3+banD[s][i].cc;
    if(f==='role')render();else rT();
}
function uL(s,i,f,v){if(f==='joueur')lanD[s][i][f]=v;else if(f==='ip')lanD[s][i][f]=parseFloat(v)||0;else lanD[s][i][f]=parseInt(v)||0;}

function rT(){
    ['visiteur','local'].forEach(function(s){
        var t=calcT(s);
        var a=document.getElementById('lr-'+s),b=document.getElementById('lh-'+s),c=document.getElementById('le-'+s);
        if(a)a.textContent=t.r;if(b)b.textContent=t.h;if(c)c.textContent=t.e;
    });
}

/* --- Save --- */
async function saveAll(){
    try{
        toast('\uD83D\uDCBE Sauvegarde...','warning');
        // Manches
        var mr=[];
        ['visiteur','local'].forEach(function(s){var tm=md[s];for(var m=1;m<=NM;m++){if(manD[s][m]!==undefined&&manD[s][m]!=='')mr.push({match_id:mid,equipe:tm,manche:m,points:parseInt(manD[s][m])||0});}});
        await sbD('pointage_manches','match_id=eq.'+mid);
        if(mr.length>0)await sbU('pointage_manches',mr);

        // Frappeurs + Banc
        await sbD('pointage_frappeurs','match_id=eq.'+mid);
        var ar=[];
        ['visiteur','local'].forEach(function(s){
            var tm=md[s];
            fraD[s].forEach(function(f,i){
                if(f.joueur&&f.joueur.trim())ar.push({match_id:mid,equipe:tm,joueur:f.joueur,pos:f.pos||'',role:'',ordre:i+1,
                    m1:f.m1||'',m2:f.m2||'',m3:f.m3||'',m4:f.m4||'',m5:f.m5||'',m6:f.m6||'',m7:f.m7||'',m8:f.m8||'',m9:f.m9||'',m10:f.m10||'',
                    ab:parseInt(f.ab)||0,r:parseInt(f.pc)||0,h:parseInt(f.cs)||0,rbi:parseInt(f.pp)||0,e:parseInt(f.e)||0,
                    b1:parseInt(f.b1)||0,b2:parseInt(f.b2)||0,b3:parseInt(f.b3)||0,cc:parseInt(f.cc)||0,bb:parseInt(f.bb)||0,k:parseInt(f.k)||0,sac:parseInt(f.sac)||0});
            });
            banD[s].forEach(function(b,i){
                if(b.joueur&&b.joueur.trim())ar.push({match_id:mid,equipe:tm,joueur:b.joueur,pos:b.pos||'',role:b.role||'DEF',ordre:NF+i+1,
                    m1:b.m1||'',m2:b.m2||'',m3:b.m3||'',m4:b.m4||'',m5:b.m5||'',m6:b.m6||'',m7:b.m7||'',m8:b.m8||'',m9:b.m9||'',m10:b.m10||'',
                    ab:parseInt(b.ab)||0,r:parseInt(b.pc)||0,h:parseInt(b.cs)||0,rbi:parseInt(b.pp)||0,e:parseInt(b.e)||0,
                    b1:parseInt(b.b1)||0,b2:parseInt(b.b2)||0,b3:parseInt(b.b3)||0,cc:parseInt(b.cc)||0,bb:parseInt(b.bb)||0,k:parseInt(b.k)||0,sac:parseInt(b.sac)||0});
            });
        });
        if(ar.length>0)await sbU('pointage_frappeurs',ar);

        // Lanceurs
        await sbD('pointage_lanceurs','match_id=eq.'+mid);
        var lr=[];
        ['visiteur','local'].forEach(function(s){var tm=md[s];lanD[s].forEach(function(l,i){if(l.joueur&&l.joueur.trim())lr.push({match_id:mid,equipe:tm,joueur:l.joueur,ordre:i+1,ip:parseFloat(l.ip)||0,h:parseInt(l.h)||0,r:parseInt(l.r)||0,er:parseInt(l.er)||0,bb:parseInt(l.bb)||0,k:parseInt(l.k)||0});});});
        if(lr.length>0)await sbU('pointage_lanceurs',lr);

        // Update match score
        var sv=0,sl=0;
        fraD.visiteur.forEach(function(f){sv+=(parseInt(f.pc)||0);});
        banD.visiteur.forEach(function(b){if(b.role==='OFF')sv+=(parseInt(b.pc)||0);});
        fraD.local.forEach(function(f){sl+=(parseInt(f.pc)||0);});
        banD.local.forEach(function(b){if(b.role==='OFF')sl+=(parseInt(b.pc)||0);});
        var tbl=md.saison?'matchs_regulier':'matchs_series';
        await sbP(tbl,'id=eq.'+mid,{score_visiteur:sv,score_local:sl,status:'en_cours'});
        toast('\u2705 Sauvegard\u00e9!','success');
    }catch(e){console.error(e);toast('\u274c '+e.message,'danger');}
}

async function finaliser(){
    if(!confirm('Finaliser ce match? Le score sera d\u00e9finitif.'))return;
    await saveAll();
    var tbl=md.saison?'matchs_regulier':'matchs_series';
    await sbP(tbl,'id=eq.'+mid,{status:'final'});

    // === Compiler vers frappeurs_saison ===
    toast('\uD83D\uDCCA Compilation stats...','warning');
    try{
        for(var si=0;si<2;si++){
            var side=si===0?'visiteur':'local';
            var tm=md[side];
            var allF=[].concat(fraD[side]).concat(banD[side].filter(function(b){return b.role==='OFF';}));

            for(var fi=0;fi<allF.length;fi++){
                var f=allF[fi];
                if(!f.joueur||!f.joueur.trim())continue;
                var nom=f.joueur;
                var ab=parseInt(f.ab)||0;
                if(ab===0 && (parseInt(f.bb)||0)===0 && (parseInt(f.sac)||0)===0)continue; // skip if no at-bats

                var cs=parseInt(f.cs)||0, b1=parseInt(f.b1)||0, b2=parseInt(f.b2)||0, b3=parseInt(f.b3)||0;
                var cc=parseInt(f.cc)||0, pc=parseInt(f.pc)||0, pp=parseInt(f.pp)||0;
                var bb=parseInt(f.bb)||0, k=parseInt(f.k)||0, sac=parseInt(f.sac)||0;

                var existing=await sbF('frappeurs_saison?saison=eq.'+SAI+'&nom=eq.'+encodeURIComponent(nom));
                if(existing.length>0){
                    var ex=existing[0];
                    var newAB=(ex.ab||0)+ab, newCS=(ex.cs||0)+cs;
                    var moy=newAB>0?(newCS/newAB):0;
                    await sbP('frappeurs_saison','id=eq.'+ex.id,{
                        pj:(ex.pj||0)+1, ab:newAB, cs:newCS,
                        b1:(ex.b1||0)+b1, b2:(ex.b2||0)+b2, b3:(ex.b3||0)+b3, cc:(ex.cc||0)+cc,
                        pc:(ex.pc||0)+pc, pp:(ex.pp||0)+pp, bb:(ex.bb||0)+bb,
                        rb:(ex.rb||0)+k, sac:(ex.sac||0)+sac,
                        moy:parseFloat(moy.toFixed(3))
                    });
                }else{
                    var moy=ab>0?(cs/ab):0;
                    await fetch(SB+'/rest/v1/frappeurs_saison',{method:'POST',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json','Prefer':'return=representation'},
                        body:JSON.stringify([{saison:SAI,nom:nom,equipe:tm,
                            pj:1,ab:ab,cs:cs,b1:b1,b2:b2,b3:b3,cc:cc,pc:pc,pp:pp,bb:bb,rb:k,sac:sac,
                            moy:parseFloat(moy.toFixed(3))}])});
                }
            }
        }

        // === Compiler vers lanceurs_saison ===
        var scoreV=0,scoreL=0;
        fraD.visiteur.forEach(function(f){scoreV+=(parseInt(f.pc)||0);});
        banD.visiteur.forEach(function(b){if(b.role==='OFF')scoreV+=(parseInt(b.pc)||0);});
        fraD.local.forEach(function(f){scoreL+=(parseInt(f.pc)||0);});
        banD.local.forEach(function(b){if(b.role==='OFF')scoreL+=(parseInt(b.pc)||0);});

        for(var si=0;si<2;si++){
            var side=si===0?'visiteur':'local';
            var tm=md[side];
            lanD[side].forEach(async function(l){
                if(!l.joueur||!l.joueur.trim())return;
                var nom=l.joueur;
                var isWin=(side==='visiteur'&&scoreV>scoreL)||(side==='local'&&scoreL>scoreV);
                var isLoss=(side==='visiteur'&&scoreV<scoreL)||(side==='local'&&scoreL<scoreV);
                var isTie=scoreV===scoreL;
                var lPC=parseInt(l.r)||0;

                // Déterminer type_lanceur
                var joueurInfo=ALL_JOUEURS.find(function(j){return j.nom&&j.nom.toLowerCase()===nom.toLowerCase();});
                var typeLanceur=(joueurInfo&&joueurInfo.role==='lanceur_a')?'A':'B';

                var existing=await sbF('lanceurs_saison?saison=eq.'+SAI+'&nom=eq.'+encodeURIComponent(nom));
                if(existing.length>0){
                    var ex=existing[0];
                    await sbP('lanceurs_saison','id=eq.'+ex.id,{
                        pl:(ex.pl||0)+1, ml:(ex.ml||0)+1,
                        v:(ex.v||0)+(isWin?1:0), d:(ex.d||0)+(isLoss?1:0), n:(ex.n||0)+(isTie?1:0),
                        pc:(ex.pc||0)+lPC, cs:(ex.cs||0)+(parseInt(l.h)||0),
                        bb:(ex.bb||0)+(parseInt(l.bb)||0), rb:(ex.rb||0)+(parseInt(l.k)||0),
                        moy:((ex.pc||0)+lPC)/Math.max(1,(ex.ml||0)+1)
                    });
                }else{
                    await fetch(SB+'/rest/v1/lanceurs_saison',{method:'POST',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/json','Prefer':'return=representation'},
                        body:JSON.stringify([{saison:SAI,nom:nom,equipe:tm,type_lanceur:typeLanceur,
                            pl:1,ml:1,v:isWin?1:0,d:isLoss?1:0,n:isTie?1:0,
                            pc:lPC,cs:parseInt(l.h)||0,bb:parseInt(l.bb)||0,rb:parseInt(l.k)||0,
                            moy:lPC}])});
                }
            });
        }
    }catch(e){console.error('Erreur compilation stats:',e);}

    toast('\uD83C\uDFC1 Match finalis\u00e9 + stats compil\u00e9es!','success');
    md.status='final';render();
}

async function resetAll(){
    if(!confirm('R\u00e9initialiser toutes les donn\u00e9es?'))return;
    if(!confirm('Action irr\u00e9versible. Continuer?'))return;
    await sbD('pointage_manches','match_id=eq.'+mid);
    await sbD('pointage_frappeurs','match_id=eq.'+mid);
    await sbD('pointage_lanceurs','match_id=eq.'+mid);
    var tbl=md.saison?'matchs_regulier':'matchs_series';
    await sbP(tbl,'id=eq.'+mid,{score_visiteur:null,score_local:null,status:'a_venir'});
    toast('Donn\u00e9es r\u00e9initialis\u00e9es','danger');load();
}

/* --- Helpers --- */
function fmtD(ds){
    if(!ds)return'';var d=new Date(ds+'T12:00:00');
    var j=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
    var m=['janvier','f\u00e9vrier','mars','avril','mai','juin','juillet','ao\u00fbt','septembre','octobre','novembre','d\u00e9cembre'];
    return j[d.getDay()]+' '+d.getDate()+' '+m[d.getMonth()]+' '+d.getFullYear();
}
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(m,t){var x=document.querySelector('.toast');if(x)x.remove();var e=document.createElement('div');e.className='toast toast-'+(t||'success');e.textContent=m;document.body.appendChild(e);setTimeout(function(){e.remove();},3000);}

init();
</script>
</body>
</html>
