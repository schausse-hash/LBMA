<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¥ REP√äCHAGE LIVE 2026 - LBMA</title>
    <link rel="icon" type="image/jpeg" href="logo-lbma.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1E3A5F;--accent:#CC0000;--gold:#D4AF37;--white:#FDFBF7;--cream:#F5F1E8;--dark:#1A1A1A;--aigles:#FF8001;--condors:#124FB2;--ducs:#006400;--faucons:#CC0000;--harfangs:#929292;--vautours:#FFFF00;--success:#28a745;--danger:#dc3545;--warning:#ffc107}
        body{font-family:'Work Sans',sans-serif;background:var(--dark);color:var(--white);min-height:100vh}
        .header{background:linear-gradient(135deg,var(--accent) 0%,#8B0000 100%);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .header-left{display:flex;align-items:center;gap:1rem}
        .header img{height:60px;background:white;padding:5px;border-radius:5px}
        .header h1{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:.1em}
        .live-badge{background:var(--accent);color:white;padding:.5rem 1rem;font-family:'Oswald',sans-serif;animation:pulse 1.5s infinite;display:flex;align-items:center;gap:.5rem}
        .live-dot{width:12px;height:12px;background:white;border-radius:50%;animation:blink 1s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        .header-right{display:flex;gap:1rem;align-items:center}
        .round-display{background:var(--gold);color:var(--dark);padding:.75rem 1.5rem;font-family:'Bebas Neue',sans-serif;font-size:1.5rem}
        .refresh-bar{background:var(--primary);padding:.5rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid var(--gold);font-family:'Oswald',sans-serif;font-size:.85rem}
        .refresh-bar .timer{opacity:.7}
        .container{max-width:1600px;margin:0 auto;padding:1rem}
        .cote-bar{background:rgba(30,58,95,.6);padding:.75rem 2rem;display:flex;gap:2rem;align-items:center;flex-wrap:wrap}
        .cote-stat{text-align:center}
        .cote-stat .label{font-family:'Oswald',sans-serif;font-size:.65rem;text-transform:uppercase;opacity:.7}
        .cote-stat .value{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--gold)}
        .cote-teams{display:flex;gap:.5rem;flex:1;justify-content:center;flex-wrap:wrap}
        .cote-team-badge{padding:.25rem .6rem;font-family:'Oswald',sans-serif;font-size:.75rem;border-radius:3px;text-align:center;min-width:70px}
        .cote-team-badge.ok{background:rgba(40,167,69,.3);border:2px solid var(--success)}
        .cote-team-badge.warn{background:rgba(255,193,7,.3);border:2px solid var(--warning)}
        .cote-team-badge.bad{background:rgba(220,53,69,.3);border:2px solid var(--danger)}
        .cote-team-badge.empty{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.3)}
        .teams-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1rem}
        .team-card{border:3px solid var(--dark);display:flex;flex-direction:column}
        .team-card.team-full{border-color:var(--success)}
        .team-header{padding:.75rem 1rem;color:white;display:flex;justify-content:space-between;align-items:center}
        .team-header h3{font-family:'Bebas Neue',sans-serif;font-size:1.2rem}
        .team-info{font-family:'Oswald',sans-serif;font-size:.8rem;text-align:right}
        .team-header.aigles{background:var(--aigles)}.team-header.condors{background:var(--condors)}.team-header.ducs{background:var(--ducs)}
        .team-header.faucons{background:var(--faucons)}.team-header.harfangs{background:var(--harfangs)}.team-header.vautours{background:var(--vautours);color:var(--dark)}
        .team-body{background:var(--white);color:var(--dark);flex:1;overflow-y:auto;padding:.4rem}
        .team-player{display:flex;justify-content:space-between;align-items:center;padding:.35rem .5rem;border-bottom:1px solid var(--cream);font-size:.85rem}
        .team-player:last-child{border-bottom:none}
        .team-player.is-coach{background:rgba(212,175,55,.2);font-weight:bold}
        .round-badge{font-size:.6rem;background:var(--primary);color:white;padding:.05rem .25rem;border-radius:2px;margin-right:.3rem}
        .player-cote{padding:.1rem .35rem;font-family:'Oswald',sans-serif;font-size:.75rem;border-radius:3px}
        .cote-1{background:#ffebee;color:#c62828}.cote-2{background:#fff3e0;color:#ef6c00}.cote-3{background:#fffde7;color:#f9a825}.cote-4{background:#e8f5e9;color:#2e7d32}.cote-5{background:#e3f2fd;color:#1565c0}
        .draft-history{background:var(--primary);padding:.75rem 1rem;max-height:200px;overflow-y:auto}
        .draft-history h3{font-family:'Bebas Neue',sans-serif;margin-bottom:.4rem;color:var(--gold);font-size:1rem}
        .history-item{padding:.3rem .5rem;background:rgba(255,255,255,.1);margin-bottom:.2rem;display:flex;justify-content:space-between;font-size:.8rem}
        .new-pick{animation:highlightPick 2s ease}
        @keyframes highlightPick{0%{background:rgba(40,167,69,.5);transform:scale(1.02)}100%{background:rgba(255,255,255,.1);transform:scale(1)}}
        .last-pick{background:linear-gradient(135deg,var(--gold),#B8962E);color:var(--dark);padding:1rem 2rem;text-align:center;font-family:'Oswald',sans-serif;font-size:1.1rem;display:none}
        .last-pick.visible{display:block}
        .footer-links{text-align:center;padding:1rem;opacity:.7;font-size:.85rem}
        .footer-links a{color:var(--gold);text-decoration:none;margin:0 1rem}
        @media(max-width:1200px){.teams-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:768px){.teams-grid{grid-template-columns:1fr}.header h1{font-size:1.5rem}}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <img src="logo-lbma.jpg" alt="LBMA">
            <div><h1>üî¥ REP√äCHAGE LIVE 2026</h1><p style="font-size:.85rem;opacity:.9">Suivez la s√©lection des joueurs en direct!</p></div>
        </div>
        <div class="header-right">
            <div class="live-badge"><span class="live-dot"></span> EN DIRECT</div>
            <div class="round-display" id="roundDisplay">CHARGEMENT...</div>
        </div>
    </header>

    <div class="refresh-bar">
        <span>üëÅÔ∏è Mode spectateur ‚Äî mise √† jour automatique</span>
        <span class="timer" id="refreshTimer">‚è±Ô∏è 10s</span>
    </div>

    <div class="last-pick" id="lastPick"></div>

    <div class="cote-bar">
        <div class="cote-stat"><div class="label">Joueurs</div><div class="value" id="totalPlayers">0</div></div>
        <div class="cote-stat"><div class="label">Œ£ Cotes</div><div class="value" id="totalCotes">0</div></div>
        <div class="cote-stat"><div class="label">Cible/√©q.</div><div class="value" id="targetCote">0</div></div>
        <div class="cote-stat"><div class="label">Tol√©rance</div><div class="value">¬± 1</div></div>
        <div class="cote-teams" id="coteTeamBadges"></div>
    </div>

    <div class="container">
        <div class="teams-grid" id="teamsGrid"></div>
        <div class="draft-history"><h3>üìú HISTORIQUE DU REP√äCHAGE</h3><div id="draftHistory"></div></div>
        <div class="footer-links"><a href="index.html">üè† Accueil</a><a href="equipes.html">üë• √âquipes</a><a href="calendrier.html">üìÖ Calendrier</a></div>
    </div>

    <script>
    const SB_URL = 'https://xgyskiatppgaeaamjhxr.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXNraWF0cHBnYWVhYW1qaHhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTgxNTQsImV4cCI6MjA4NjA3NDE1NH0.67KCcUWlJij-scDoCUvZpkiCle5-mHVmy-inRk96Tac';
    const SAISON = '2026';
    const MAX = 11;
    const TMS = ['AIGLES','CONDORS','DUCS','FAUCONS','HARFANGS','VAUTOURS'];
    const TI = {AIGLES:{e:'ü¶Ö'},CONDORS:{e:'ü¶Ö'},DUCS:{e:'ü¶â'},FAUCONS:{e:'ü¶Ö'},HARFANGS:{e:'ü¶â'},VAUTOURS:{e:'ü¶Ö'}};

    let allPlayers = [], picks = [], prevPickCount = 0;

    async function sb(path) {
        const res = await fetch(SB_URL + '/rest/v1/' + path, {
            headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Range': '0-999' }
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
    }

    function getTP(team) { return picks.filter(p => p.equipe === team); }

    async function loadAll() {
        try {
            allPlayers = await sb('joueurs_liste?saison=eq.' + SAISON + '&actif=eq.true&order=nom.asc');
            picks = await sb('repechage_picks?saison=eq.' + SAISON + '&order=pick_order.asc');

            // Detect round
            const coachCount = TMS.filter(t => getTP(t).find(p => p.is_coach)).length;
            const r0Count = TMS.filter(t => getTP(t).find(p => p.ronde === 0 && !p.is_coach)).length;
            let roundLabel = 'RONDE COACHS';
            if (coachCount >= 6 && r0Count < 6) roundLabel = 'RONDE 0';
            else if (r0Count >= 6) {
                let r = 1;
                for (let i = 1; i <= 9; i++) {
                    if (TMS.filter(t => getTP(t).some(p => p.ronde === i)).length < 6) { r = i; break; }
                    if (i === 9) r = 9;
                }
                roundLabel = 'RONDE ' + r;
            }
            document.getElementById('roundDisplay').textContent = roundLabel;

            // Show last pick banner if new
            if (picks.length > prevPickCount && prevPickCount > 0) {
                const last = picks[picks.length - 1];
                const lp = document.getElementById('lastPick');
                const act = last.is_coach ? 'üëî NOUVEAU COACH' : 'üéØ NOUVEAU PICK';
                lp.innerHTML = act + ' ‚Üí <strong>' + last.joueur_nom + '</strong> [' + last.joueur_cote + '] ‚Üí ' + last.equipe;
                lp.classList.add('visible');
                setTimeout(() => lp.classList.remove('visible'), 8000);
            }
            prevPickCount = picks.length;

            renderTeams();
            renderHist();
            updateBar();
        } catch (e) { console.error(e); }
    }

    function updateBar() {
        const tot = allPlayers.length, sc = allPlayers.reduce((s, p) => s + p.cote, 0), tgt = tot > 0 ? (sc / 6).toFixed(1) : 0;
        document.getElementById('totalPlayers').textContent = tot;
        document.getElementById('totalCotes').textContent = sc;
        document.getElementById('targetCote').textContent = tgt;
        document.getElementById('coteTeamBadges').innerHTML = TMS.map(t => {
            const tp = getTP(t), tc = tp.reduce((s, p) => s + p.joueur_cote, 0), cn = tp.length;
            let cl = 'empty';
            if (cn > 0) { const d = Math.abs(tc - parseFloat(tgt)); cl = cn === MAX ? (d <= 1 ? 'ok' : d <= 2 ? 'warn' : 'bad') : 'warn'; }
            return '<div class="cote-team-badge ' + cl + '">' + t.substring(0, 3) + '<br><strong>' + tc + '</strong><br><span style="font-size:.6rem">' + cn + '/' + MAX + '</span></div>';
        }).join('');
    }

    function renderTeams() {
        document.getElementById('teamsGrid').innerHTML = TMS.map(t => {
            const tp = getTP(t);
            const tot = tp.reduce((s, p) => s + p.joueur_cote, 0);
            const full = tp.length >= MAX;
            return '<div class="team-card ' + (full ? 'team-full' : '') + '">' +
                '<div class="team-header ' + t.toLowerCase() + '"><h3>' + TI[t].e + ' ' + t + '</h3>' +
                '<div class="team-info"><div>Œ£ <strong>' + tot + '</strong></div><div style="font-size:.65rem">' + tp.length + '/' + MAX + '</div></div></div>' +
                '<div class="team-body">' +
                (tp.length > 0 ? tp.map(p => {
                    const rLabel = p.ronde === -1 ? 'C' : 'R' + p.ronde;
                    return '<div class="team-player ' + (p.is_coach ? 'is-coach' : '') + '"><span><span class="round-badge">' + rLabel + '</span><span class="player-cote cote-' + p.joueur_cote + '">' + p.joueur_cote + '</span> ' + (p.is_coach ? 'üëî ' : '') + p.joueur_nom + '</span></div>';
                }).join('') : '<p style="color:#999;text-align:center;padding:1rem;font-size:.85rem">En attente...</p>') +
                '</div></div>';
        }).join('');
    }

    function renderHist() {
        const c = document.getElementById('draftHistory');
        if (!picks.length) { c.innerHTML = '<p style="opacity:.5">En attente du premier pick...</p>'; return; }
        const sorted = [...picks].sort((a, b) => b.pick_order - a.pick_order);
        c.innerHTML = sorted.slice(0, 40).map((h, i) => {
            const rLabel = h.ronde === -1 ? 'COACH' : (h.ronde === 0 ? 'R0' : 'R' + h.ronde);
            const act = h.is_coach ? 'COACH' : 'REP√äCH√â';
            const cls = i === 0 ? 'history-item new-pick' : 'history-item';
            return '<div class="' + cls + '"><span><strong>' + rLabel + '</strong> | <span style="color:#28a745">' + act + '</span> | ' + h.equipe + ': <strong>' + h.joueur_nom + '</strong> [' + h.joueur_cote + ']</span><span style="opacity:.7">' + new Date(h.picked_at).toLocaleTimeString('fr-CA') + '</span></div>';
        }).join('');
    }

    // Auto-refresh
    let countdown = 10;
    setInterval(() => {
        countdown--;
        document.getElementById('refreshTimer').textContent = '‚è±Ô∏è ' + countdown + 's';
        if (countdown <= 0) { countdown = 10; loadAll(); }
    }, 1000);

    loadAll();
    </script>
</body>
</html>
